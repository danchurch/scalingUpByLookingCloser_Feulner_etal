## we have illumina data from alfons, some of which is from our cyanobacterial cultures


## let's have a look. work on the optiplex for now.

## we'll need silva, properly formatted:

wget https://zenodo.org/records/14169026/files/silva_nr99_v138.2_toGenus_trainset.fa.gz

## it's here:
/home/daniel/Documents/databases/silva/silva_nr99_v138.2_toGenus_trainset.fa
## which samples are the moss samples?:

ls /home/daniel/Documents/projects/wernerSphagnum/wernerSphagnumSequences/

cd /home/daniel/Documents/projects/wernerSphagnum/wernerSphagnumSequences/

## our moss samples have the following IDs:
Oemik-002018
Oemik-002019
Oemik-002020 (neg)

## so...
cp Oemik-0020{18..20}_S4[5-7]_L001_R1_001.fastq.gz /home/daniel/Documents/projects/mossSymbiosis/
 
cd /home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture

## how do they look?

mkdir fastqcOut

fastqc -o fastqcOut -t 11 reads/*.gz

## from laptop
getThis=/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/fastqcOut/*html
puthere=/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/totalCyanoCommunity/
rsync -auv daniel@132.180.113.114:$getThis $puthere
## looks fine. 

## trim primers:

mkdir trimmed_reads/

## go to the directory with the raw read files on optiplex
cd reads

outputDir="../trimmed_reads/"
for inputFastq in *; do
    cutadapt --rc \
        -g TCGTGYCAGCMGCCGCGGTAA \
        --length 280 \
        -a GGACTACNVGGGTWTCTAAT \
        -o ${outputDir}${inputFastq} \
           ${inputFastq}
done

## we can use our environment from the spatialdirt environment (that we use for carbon4d data):

conda activate spatialDirt

R

#install.packages("BiocManager")
#library("BiocManager")
#BiocManager::install("dada2")

library("dada2")
library("phyloseq")

setwd("/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/reads")

fileNames <- list.files()

filterPath <- "../filteredReads"

out <- filterAndTrim(fileNames, filterPath,
              maxN=0, maxEE=2, truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=TRUE)

setwd("../filteredReads")

err <- learnErrors(fileNames, multithread=TRUE)

save(err, file="../err.rda")

plotErrors(err, nominalQ=TRUE)

dadaF <- dada(fileNames, err=err, pool=TRUE, multithread=TRUE)

seqtab <- makeSequenceTable(dadaF)

seqtab

seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)

## make the sample names prettier

rownames(seqtab.nochim) <- c("S45","S46","S47")


## now we have OTUs (ASVs) and an otu table
## let's get taxonomic assignments:

## for silva:
path2silvaDB <- "/home/daniel/Documents/databases/silva/silva_nr99_v138.2_toGenus_trainset.fa"
taxa <- assignTaxonomy(seqtab.nochim, path2silvaDB, multithread=TRUE)


ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), tax_table(taxa))

## insert our representative sequences for our OTUs:

dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
## give our ASVs pretty names instead of DNA sequences:
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))

save(ps, file="../cyanoPS.rda")



## to start from here:

R

setwd("/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture")
load(file="cyanoPS.rda")
library(phyloseq)
library(Biostrings)

## okay, how do they look?

rank_names(ps)

tax_table(ps)["ASV1",]

tax_table(ps)["ASV17",] ## chloroplast from eukaryotic algae

tax_table(ps)["ASV2",]

## lots of stuff in there. Subset to cyanos?:
ps.cya = subset_taxa(ps, Phylum=="Cyanobacteriota")

head(as.data.frame(refseq(ps.cya)))

as.data.frame(refseq(ps.cya))['ASV17',]

barplot(sort(taxa_sums(ps.cya), decreasing=TRUE))

barplot(sort(taxa_sums(ps.cya)[ taxa_sums(ps.cya) > 30], decreasing=TRUE))


plot_bar(ps.cya, fill = "Family")

plot_bar(ps.cya, fill = "Order") ## most of these are chloroplasts

## still a lot of chloroplasts, probably from the eukaryotic algae

aa <- as.data.frame(tax_table(ps.cya))$Order == "Chloroplast"
aa[is.na(aa)] <- FALSE
aa <- !aa
length(aa)
ps.noCp <- prune_taxa(aa, ps.cya)

plot_bar(ps.noCp, fill= "Order")

refseq(ps.noCp)

as.data.frame(refseq(ps.noCp))

ps.cya.noCp = subset_taxa(ps, Order=="Cyanobacteriales")

plot_bar(ps.cya.noCp, fill="Order")
## pretty much one ASV for non-chloroplast cyano...
str(as.character(refseq(ps.cya.noCp)[1]))

## and it is a plastid also, from Klebsormidium, a green alga.

## so literally no cyanos detected? Either they were not present, 
## or they were swamped out by the abundance of moss plastids and eukaryotic algae plastids.
## the latter seems likely. 

## can we get identification of eukaryotic alge from these chloroplasts?

## get out our sequences for all of our "cyanobacteria":

ps.cya

refseq(ps.cya)

str(as.character(refseq(ps.cya.noCp)[1]))

refseq(ps.cya.noCp)

writeXStringSet(refseq(ps.cya), "/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/refSeqsChloroplasts.fa")

## while we are at it, export the abundances ("community matrix", though not much of a matrix)

write.csv(otu_table(ps.cya), file="chloroplast_read_abundances_from_mixedCultures.csv")


## get this on our local computer (BASH, not R):
rsync -aux daniel@132.180.113.114:/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/refSeqsChloroplasts.fa \
     /home/daniel/Documents/projects/mossSymbiosis/nostoc/totalCyanoCommunity/

rsync -aux daniel@132.180.113.114:/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/chloroplast_read_abundances_from_mixedCultures.csv \
     /home/daniel/Documents/projects/mossSymbiosis/nostoc/totalCyanoCommunity/

## I think for this we need to do some "manual" blast matches, switch to biopython

## following: https://www.tutorialspoint.com/biopython/biopython_overview_of_blast.htm

python3
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os
from Bio.Blast import NCBIWWW
from Bio.Blast import NCBIXML

sequence_data = open('refSeqsChloroplasts.fa').read() 

result_handle = NCBIWWW.qblast("blastn", "nt", sequence_data)

with open('chloroplastBlastResults.xml', 'w') as save_file: 
  blast_results = result_handle.read() 
  save_file.write(blast_results)

E_VALUE_THRESH = 1e-20 
for record in NCBIXML.parse(open("chloroplastBlastResults.xml")): 
    if record.alignments: 
       print("\n") 
       print("query: %s" % record.query[:100]) 
       for align in record.alignments: 
          for hsp in align.hsps: 
             if hsp.expect < E_VALUE_THRESH: 
                print("match: %s " % align.title[:100])

## to write this to a text file:
with open('chloroplastBlastResults_highConf.txt', 'w') as save_file:
  E_VALUE_THRESH = 1e-20 
  for record in NCBIXML.parse(open("chloroplastBlastResults.xml")): 
      if record.alignments: 
         save_file.write("\n") 
         save_file.write("query: %s" % record.query[:100]) 
         save_file.write("\n") 
         for align in record.alignments: 
            for hsp in align.hsps: 
               if hsp.expect < E_VALUE_THRESH: 
                  save_file.write("match: %s \n" % align.title[:100])

## get on office comp:
rsync -aux daniel@132.180.113.114:/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/chloroplastBlastResults_highConf.txt \
     /home/daniel/Documents/projects/mossSymbiosis/nostoc/totalCyanoCommunity/


## send Romina the community matrix, the reference sequences fasta, and the blast results. And point her to this script. 


############### note from 7.11.25 #########################
## Romina has found an interesting database, PhytoRef (http://phytoref.sb-roscoff.fr/).
## It hasn't been maintained in a while, but let's see it can also be used for identification
## of these reads, since the vast majority of them are chloroplasts from eukaryotic algae. 
## their github site was never finished and doesn't have the files it promises, but they have 
## the above old-fashioned website with the fasta files

## back on optiplex:
cd /home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture

## the closest thing they have to a dada2-formatted file for the assignTaxonmy function:
wget http://phytoref.sb-roscoff.fr/static/downloads/PhytoRef_with_taxonomy.fasta

## following https://benjjneb.github.io/dada2/training.html, we need to reformat a bit
## we need to drop the unique ID numbers, trade the pipes for semicolons, and add a semicolon
## at the end:

sed "/^>/ s/[0-9].*Eukaryota/Eukaryota/" PhytoRef_with_taxonomy.fasta | sed "/^>/ s/|/;/g" | sed "/^>/ s/$/;/" > PhytoRef_dada2.fa

## in R, we need to purge the old ps taxonomy assignments and replace assignments
## resulting from this database...

## moving over to R:

## to reuse this ps object for phytoRef (see script above):
library(Biostrings)
library(phyloseq)
library(dada2)

load(file="cyanoPS.rda")

otu_table

ps 

phytoRefTaxLevels <- c("Domain","Super-group","Phylum","Class","Subclass","Order","Suborder","Family","Genus","Species")
phytoRefAssignments <- assignTaxonomy(refseq(ps),"PhytoRef_dada2.fa", taxLevels = phytoRefTaxLevels)

taxa_names(ps)

## just checking...order ok?
names(phytoRefAssignments[1:2,1])
refseq(ps)[1:2]
names(phytoRefAssignments[595:596,1])
refseq(ps)[595:596]

## clean up rownames:
rownames(phytoRefAssignments) <- names(rownames(phytoRefAssignments))

## slide this in as our new taxa table:
tax_table(ps) <- phytoRefAssignments

## rename and save out
psPhyto <- ps

#save(psPhyto, file="phytoRefPS.rda")


load(file="phytoRefPS.rda") ## our phytoref ps
load(file="cyanoPS.rda") ## our silva identified ps

## now Romina will need a "community matrix" and a taxonomy table, I think:


rank_names(ps)
rank_names(psPhyto)

tax_table(ps)["ASV1",]
tax_table(psPhyto)["ASV1",]

## from this we see the problem that this will identify
## things as chloroplasts that are not, because all non-chloroplast
## 16s are not available in the phytoref database, and RDP
## just finds the closest thing. Should have set a more stringent 
## bootstrap? Not sure if this will help.

## to be safe, let's remove everything that didn't originally 
## id to cyanobacteria under silva:

ps.cya <- subset_taxa(ps, Phylum=="Cyanobacteriota")

psPhyto <- prune_taxa(taxa_names(ps.cya), psPhyto)

## update:
#save(psPhyto, file="phytoRefPS.rda")

tax_table(ps.cya)["ASV17",] ## unidentified cyano with silva
tax_table(psPhyto)["ASV17",] ## Klebsormidium flaccidum with phytoRef

barplot(sort(taxa_sums(psPhyto), decreasing=TRUE))

dev.new()

plot_bar(psPhyto, fill = "Order") ## this is much more informational than above.


## anyway, this is Romina's data...
writeXStringSet(refseq(psPhyto), "/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/refSeqsChloroplasts.fa")
write.csv(otu_table(psPhyto), file="chloroplast_read_abundances_from_mixedCultures_phytoRef.csv")
write.csv(tax_table(psPhyto), file="taxAssignments_chloroplast_mixedCultures_phytoRef.csv")

#getFile="refSeqsChloroplasts.fa"
#getFile="chloroplast_read_abundances_from_mixedCultures_phytoRef.csv"
getFile="taxAssignments_chloroplast_mixedCultures_phytoRef.csv"
getDir=/home/daniel/Documents/projects/mossSymbiosis/cyanoMixedCulture/
putHere=/home/daniel/Documents/projects/mossSymbiosis/nostoc/totalCyanoCommunity/
rsync -aux daniel@132.180.113.114:${getDir}${getFile} $putHere
