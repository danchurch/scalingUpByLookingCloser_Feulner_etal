## let's see if we can extract the 16s sequence for this 
## cyano

## as always, make a repo:

git clone https://github.com/danchurch/nanoporeNostoc16sAlignments.git
git config --global user.email "danchurchthomas@gmail.com"
git config --global user.name "danchurch"
git remote set-url origin git@github.com:danchurch/nanoporeNostoc16sAlignments.git


## from one of our colony PCRs:

scp test@132.180.112.115:/media/vol1/daniel/nostoc/FAX46654_pass_7c69c392_f65555ec_0.fastq .

## we want a database that contains all public 16s cyanobacteria to blast against. 

## then make some sort of consensus sequence to report. As a preliminary result. 

## downloaded the silva sequences for cyanobacteria 16s
## we should use this to blast against, to find our possible cyano reads

## go looking for the symbionts after that. 

## for the cyano reads - 
## silva cyano reads are here:

cd /media/vol1/daniel/nostoc/cyanoRef16s

tar -xzvf arb-silva.de_2023-11-22_id1287436.tgz

## that's rna, U's instead of T's. Does blast have a problem with this?

## our raw read folder is here:

rawReadDir=/var/lib/minknow/data/lowPoresNostoc/Nostoc2/20231121_1424_MN40608_FAX46654_7c69c392/fastq_pass

cp $rawReadDir 

## copied to 
/media/vol1/daniel/nostoc/minionReadsNostoc

## combine them:

gunzip *
cat * > allNostoc2.fastq

## to fasta
seqtk seq -A allNostoc2.fastq > allNostoc2.fasta

## can we clean up the headers?

head -n 10 allNostoc2.fasta | sed "s/runid=.*$//" ## seems to work

sed -i "s/runid=.*$//" allNostoc2.fasta

## great. we need a blastable database
## silva gives rna, not DNA, is this a problem?


makeblastdb -in arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta -parse_seqids -dbtype nucl 

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta
minionReads=/media/vol1/daniel/nostoc/minionReadsNostoc/allNostoc2.fasta

blastn -db $cyanoDB \
  -query $minionReads \
  -num_threads 10 \
  -num_alignments 1 \
  -out minion2cyanoMatches.csv \
  -outfmt 10 &

## ugh, the headers are weird:

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta

## some weird things in there. For instance, why is this in our cyano database? gammaproteo

cd /media/vol1/daniel/nostoc/blastout

grep -c "Proteobacteria" $cyanoDB 

grep "Proteobacteria" $cyanoDB ## prochlorothrix, but misassigned

grep "EF174233.1.1481" $cyanoDB

## looks like a pseudomonas mislabeled as a cyano in the silva database

grep ">" /media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta | less

## ugh. more curation is needed. Get rid of all chloroplast sequences. 
## modify headers so that genus is included in the blast results
## etc, etc. 

## blast results:

blRes=/media/vol1/daniel/nostoc/minionReadsNostoc/minion2cyanoMatches.csv

grep "EF174233.1.1481" $cyanoDB

grep "EF174233.1.1481" $blRes

## so we need to rerun the blast without chloroplast sequences in the ref db,
## or exclude any non-cyano (contaminants, chloroplasts) using
## the taxonomy in the headers of our reference sequence
## change the headers to include the taxonomy. 

## to clean up the database a bit:

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta

head $cyanoDB 

head $cyanoDB | sed "s/ /_/g"

## what can we use as a connector...

grep "_" $cyanoDB ## nope
grep "=" $cyanoDB ## nope
grep "+" $cyanoDB ## that works, only one of those, in a chloroplast sequence.

## speaking of, how do we get rid of the chloroplast reads?

grep -i "Chloroplast" $cyanoDB 

grep -i "Chloroplast" $cyanoDB | grep "chloroplast"

## get rid of line breaks 
seqtk seq -l 0 $cyanoDB > silvaCyanosNoLB.fasta

grep -ci "Chloroplast" silvaCyanosNoLB.fasta ## 75,997 sequences are chloroplasts

grep -iV "Chloroplast" silvaCyanosNoLB.fasta

head -n 100 silvaCyanosNoLB.fasta | grep -iv "Chloroplast" 

grep -v "Chloroplast" silvaCyanosNoLB.fasta

grep -iA 1 "Chloroplast" silvaCyanosNoLB.fasta

## ugh, need to go to python

import pandas as pd
from Bio import SeqIO
import os

## get our silva cyano database in there:

os.chdir("/media/vol1/daniel/nostoc/cyanoRef16s")

silvaCyanos="arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta"

notChloros=[]
for rec in SeqIO.parse(silvaCyanos, "fasta"):
    print(rec.id)
    if "hloroplast" not in rec.description and "Cyanobacteria" in rec.description: 
        print ("yep!!!")
        print (rec.description)
        notChloros.append(rec)

## check it:
for i,j in enumerate(notChloros):
    print(i)
    print(j)

len(notChloros) ##103898 records. Should not be anything but real cyanos, no chloroplasts.

## write out
SeqIO.write(notChloros, "silvaCyanos.fasta", "fasta")

## back in the shell
## we still want to reformat, to keep the phylo info in our 
## blast csv:

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta

grep -c "+" $cyanoDB ## 0

## change out headers, get rid of first space: 
sed "s/ /;/" -i silvaCyanos.fasta

grep -c "Chloroplast" $cyanoDB ## 0


less silvaCyanos.fasta

## looks okay. make db and try again:
makeblastdb -in silvaCyanos.fasta -dbtype nucl 

cd /media/vol1/daniel/nostoc/blastout
cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta
minionReads=/media/vol1/daniel/nostoc/minionReadsNostoc/allNostoc2.fasta
nohup blastn -db $cyanoDB \
  -query $minionReads \
  -num_threads 10 \
  -num_alignments 1 \
  -out minion2cyanoMatches.csv \
  -outfmt 10 &

cd /media/vol1/daniel/nostoc/blastout

less minion2cyanoMatches.csv

wc -l minion2cyanoMatches.csv ## 35220 hits, out of 

grep -c "^>"  $minionReads ## 40,000

grep -c "Nostocaceae" minion2cyanoMatches.csv ## 11340

grep -c "Nostoc" minion2cyanoMatches.csv ## 11340 

grep -c "Nostocaceae;Nostoc" minion2cyanoMatches.csv ## 9928
grep -c ";Nostoc," minion2cyanoMatches.csv ## 9940 weird, why more? formatting I guess

## interesting. what to do from here:
## fastqc, nanoqc
## 
## check relative abundances - is nostoc really the most 
## common thing here?
## Take out the nostoc sequences, 
## find some consensus sequences, put them on a 16s tree. 
## how many "different" nostocs are there?
## figure out if it something new
## that's a bit of work.
## that should be preliminary data for some kind of grant. 
## but we do need to get some kind of consensus here. 
## maybe pull out all nostoc hits and run an alignment... 
## but there are lots...

## we have a two step project here 
## 1 - get some consensus sequences - vsearch
## 2 - place these on a tree, probably the tree from 
##     these folks: https://github.com/FGPLab/cydrasil

## start by getting some representative sequences

## let's pull out all reads that blasted to 16s nostoc sequences

cd /media/vol1/daniel/nostoc/blastout 

grep "Nostocaceae;Nostoc" minion2cyanoMatches.csv > nostocMatches.csv
cut -f1 -d, nostocMatches.csv > nostocReads.txt

nostocReads="/media/vol1/daniel/nostoc/blastout/nostocReads.txt"
allReads="/media/vol1/daniel/nostoc/minionReadsNostoc/allNostoc2.fastq"
## use seqtk to keep only the matches to nostoc
seqtk subseq $allReads $nostocReads > onlyNostoc.fastq

grep -c "runid=" onlyNostoc.fastq ##9928, looks good

## how do these look?

fastqc -t 10 -o fastqcOut onlyNostoc.fastq
 
scp -r test@132.180.112.115:/media/vol1/daniel/nostoc/minionReadsNostoc/fastqcOut .


## yeah, let's cut the adapters, other stuff 


## first basepairs are really low quality. Not sure
## how long the adapters are...
## can we find our primers in there? the sequences are:

## 16S-27F:
grep AG.GTTTGAT..TGGCTCAG onlyNostoc.fastq ## 20 bp

## a random sample of reads before this:
TGTGCATACTGGATCAGTTACGTATTGCT
TGCTATGTGCTCTACTGGTACAGTTAGCGTATTGCT
TGGCATCTACTGGTTAGACTTGGTCTTGCT
ATGTAGCCTTGGTTCAGAGTACGTATTGCT
TGTGTCACCTGGTTCGAGTTTACGTATTGCT

## 16S-1492R

grep TACCTTGTTA.GACTT onlyNostoc.fastq ## 16 bp

## a random sample of reads before this:
ATGTCTACCTTGGTTCAGAGTACGTATTGCT
TATGTGTACGTCCTACTTGGTTCCGTTGCGTATTGCT
ATGTTTTGCATCTACTGGTTGGTTGGTATTGCT
TGCCATGCTTGGTTCAGTACGTATTGCT


## so it looks like the adaptors are 30-40 bp,
## and the primers are 16-20bp 
## I think this means, to be safe, that 
## we should chop the first 60 reads.
## and allow the maximum reads after that to 
## be ~1600 bp:

cd /media/vol1/daniel/nostoc/minionReadsNostoc

#seqtk trimfq -L80 onlyNostoc.fastq > test.fastq
seqtk trimfq -b60 -L1600  onlyNostoc.fastq > onlyNostTrimmed.fastq

rm fastqcOut/*
fastqc -t 10 -o fastqcOut onlyNostoc.fastq
fastqc -t 10 -o fastqcOut test.fastq
fastqc -t 10 -o fastqcOut onlyNostTrimmed.fastq

## on local, to look at this:
rm -r fastqcOut/ &&
scp -r test@132.180.112.115:/media/vol1/daniel/nostoc/minionReadsNostoc/fastqcOut . &&
firefox fastqcOut/*html

## that's starting to look right. 
## now, get some otus out of this?

cd /media/vol1/daniel/nostoc/clustering

fastaF=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostoc.fastq
vsearch \
  --cluster_size $fastaF \
  --id 0.90 \
  --relabel otu \
  --sizein \
  --sizeout \
  --fasta_width 0 \
  --strand both \
  --consout "nostocConsensusSeqs.fasta" \
  --threads 10 \
  --otutabout "nostocClusterTable.csv"

## that fails horribly. at id=0.97 or 0.90 we still have 
## about the same number of OTUs as reads. 
## the exceptions are not recognizeable as cyanos 
## anymore.

## weird.

## try nanoclust
## tried nanoclust. installation was a nightmare, 
## had to hand modify scripts, install a thousand
## dependencies even though it was in conda
## then it didn't work anyway because the reads weren't abundant
## enough for the algorithm.

## new approach, we have our blast results,
## let's sort them by abundance, and assume 
## the things that blast to the same thing are
## the same same thing

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' nostocMatches.csv

python3 

import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.chdir('/media/vol1/daniel/nostoc/blastout/')

nostocMatches = pd.read_csv('/media/vol1/daniel/nostoc/blastout/nostocMatches.csv', index_col='qseqid')
## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

nostocMatches.groupby('sseqid').count()

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()

bb = aa.T.iloc[0,:].sort_values(ascending=False)

## the vast majority (7805 out of 9928) have blasted to
## JN847344.1.1541

## accession number JN847344

## this is from a lichen associated cyanobacteria, from Leptogium
## from oregon

## what is our mean percent % similarity and length of match?


nostocMatches.head()

leptoMatches=nostocMatches[nostocMatches['sseqid']=='JN847344.1.1541']

## second most common (285 out of 9928) match is to a hornwort-associated nostoc:
hornMatches=nostocMatches[nostocMatches['sseqid']=='CP001037.5515629.5517117']

leptoMatches.head()
leptoMatches.tail()

leptoMatches[['pident', 'length']].mean() ## on average, 86% match

nostocMatches[['sseqid', 'pident', 'length','evalue']].groupby('sseqid').mean()

aa = nostocMatches[['sseqid', 'pident', 'length']].groupby('sseqid')

hornMatches[['pident', 'length']].mean() ## on average, 86% match also.

nostocMatches[['sseqid','pident']].groupby('sseqid').count()

## so now we have two problems:

## 1 - we need a consensus sequence for our nostoc
## 2 - we need a tree to put it in.

##### placement on tree ########

## let's see if we can get our consensus seqs,
## the tree from Cydarasil3 (https://github.com/FGPLab/cydrasil)
## we'll try pplacer (http://matsen.github.io/pplacer/generated_rst/pplacer.html)
## also using taxtastic (https://fhcrc.github.io/taxtastic/quickstart.html)

## pplacer needs:

conda create -n pplacer -c bioconda pplacer
conda activate pplacer
conda install -c bioconda taxtastic

## make the reference package:

taxit create -l 16s_rRNA -P my.refpkg \
    --aln-fasta seqs.fasta \
    --tree-stats tree_stats.txt \
    --tree-file tree.nwk

seqsfasta=
tree_stats=
tree=
taxit create -l 16s_rRNA -P my.refpkg \
    --aln-fasta $seqsfasta \
    --tree-stats $tree_stats \
    --tree-file $tree

## ugh, cydrasil doesn't have all the files
## needed for pplacer. Try SSU-align/EPA-ng pipeline that cydrasil
## recommends:

conda create -n cydrasil -c bioconda ssu-align epa-ng

conda activate cydrasil

/media/vol1/daniel/nostoc/16sTree/cydrasil_repo

consenSeqs=/media/vol1/daniel/nostoc/clustering/nostocConsensusSeqs.fasta
ssuAlignMask=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/cydrasil-v3-ssu-align.bacteria.mask

ssu-align $consenSeqs aln
ssu-mask -s $ssuAlignMask aln

ssu-align query-seqs.fasta output-directory-name

## let's put that on hold for a moment...

####### get consensus sequence for nostoc sp ####

## problem two is to get a consensus 16s sequence from
## our nanopore sequencing effort

## we think we have a new nostoc species that is 
## associated with the hylocomium. Let's see.

## we are down to maybe 10,000 sequences that 
## are probably nostoc. 
## Let's assume these are what we are looking for.

## for a 16S tree, this is maybe feasible. 
## let's try ssu-align

nostoc 

conda activate cydrasil

## convert trimmed nostoc to fasta
cd /media/vol1/daniel/nostoc/minionReadsNostoc

seqtk seq -A onlyNostTrimmed.fastq > onlyNostTrimmed.fasta
sed -i "s/runid=.*$//" onlyNostTrimmed.fasta

cd /media/vol1/daniel/nostoc/ourNostocMSA
nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fasta
ssu-align -f $nostocReads msaNostoc

## repeated read names...how can this be...
grep "de18da17-28ad-4b14-8440-f70e40d5dbe3" $nostocReads

## are there others?:

sed -n "/>/p" $nostocReads | sort | uniq -d ## 841! what is going on??

## look at one set:

grep -A1 "de18da17-28ad-4b14-8440-f70e40d5dbe3" $nostocReads

## those look identical...make sure

readName="de18da17-28ad-4b14-8440-f70e40d5dbe3"
grep -A1 $readName $nostocReads > twoReads.txt
diff <(sed -n "2"p twoReads.txt) <(sed -n "4"p twoReads.txt)

## are other reads identical?

sed -n "/>/p" $nostocReads | sort | uniq -d > dupedReads

for readName in $(cat dupedReads); do
  grep -A1 $readName $nostocReads > twoReads.txt
  diff <(sed -n "2"p twoReads.txt) <(sed -n "4"p twoReads.txt)
done

## yeah, those are exact dups. 

## is all the metadata the same? for instance

nostocFastq=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fastq

readName="de18da17-28ad-4b14-8440-f70e40d5dbe3"
grep -A1 $readName $nostocFastq > twoReads.txt
#grep -A1 $readName $nostocReads > twoReads.txt

diff <(sed -n "1"p twoReads.txt) <(sed -n "4"p twoReads.txt)

## not sure where they occurred or why? hope that's not a 
## a problem...hopefully just another quirk of nanopore.

## for the moment, can we remove duplicates?

## use seqkit?

conda deactivate 
conda activate seqkit

cd /media/vol1/daniel/nostoc/minionReadsNostoc/

seqkit rmdup < onlyNostTrimmed.fasta > onlyNostTrimmed_dedup.fasta

## found 1019 duplicated sequences!! whoah, weird.
## now try again with ssu

conda deactivate 

conda activate cydrasil

cd /media/vol1/daniel/nostoc/ourNostocMSA

nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta
nohup ssu-align -f $nostocReads msaNostoc &

mv nohup.out nohup.align.out

## mask the low-confidence columns

nohup ssu-mask msaNostoc &

## SSU-ALIGN masking shows that we have a lot of 
## low confidence columns...it really only trusts
## 140 columns...ugh nanopore

## how do we view these two alignments (masked/non)
## and get a consensus out of them?

conda deactivate

conda create -n jalview -c bioconda jalview

conda activate jalview

## neither of these are useful. The raw unmasked one has 10,000 columns,
## with supposedly high-confidence columns scattered throughout. 

## the masked one blasts to nothing. 

## let's try muscle:


cd /media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign

noFasta=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fasta
nohup muscle -in $noFasta -out nostoc16sAlignment.fa  &

\time muscle -in $noFasta -out nostoc16sAlignment.fa

## think that will run for some time....

## and died. Not enough ram?

13796344

13,796,344 ## that's not that much...hmmm

## as per here: http://www.drive5.com/muscle/muscle.html#_Toc81224829

noFasta=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fasta
nohup muscle -in $noFasta -out nostoc16sAlignment.fa -maxiters 2 -diags1 -sv &

file2get="/media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign/nostoc16sAlignment.fa"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/idColonies"
scp -r test@132.180.112.115:$file2get $putHere

## look at it with aliview:

wget http://ormbunkar.se/aliview/downloads/linux/linux-version-1.28/aliview.install.run

gtctcgtgggctcggagatgtgtataagagacagggactacnvgggtwtctaat

## ugh. so the question remains, if these sequences are so 
## un-alignable, how did blast perfom so well? 

## let's rerun the blast search with verbose results, with alignments,
## might give us a clue as to what is going on.

## our dedupped data is here on the lab computer, back it up on github
file2get="/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/data/"
scp -r test@132.180.112.115:$file2get $putHere

## also the reference fasta we made, of cleaned up silva cyanobacterial accessions:
file2get="/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/refDatabases/"
scp -r test@132.180.112.115:$file2get $putHere
## and gzip it because too big

## anyway, move over to lab comp to let things run

cd /media/vol1/daniel/nostoc/minionReadsNostoc

nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta

cd /media/vol1/daniel/nostoc/blastout

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta
nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta
nohup blastn -db $cyanoDB \
  -query $nostocReads \
  -num_threads 10 \
  -num_alignments 1 \
  -out minion2cyanoMatchesVerbose.txt &

## the previous most common hit is still the most common:

grep -c  ">JN847344.1.1541" minion2cyanoMatchesVerbose.txt ## ____ out of

grep -c "Query=" minion2cyanoMatchesVerbose.txt ## ____


## don't know why we didn't notice this before, but this match is 
## also common:

grep -c KF359696.1.1469 minion2cyanoMatchesVerbose.txt 

grep -c ">KF359696.1.1469" minion2cyanoMatchesVerbose.txt ## but never first hit, hmmm

## 1557 hits, usually following the JN8 accession with an equal e/bit score
## what is this?

## it is also a leptogium symbiont. 

## so what do we do with this?

## is this the same file as used above by the ssh aligner and muscle?
## essentially. 
## so why did the alignments fail so badly?

## get new version of muscle:

wget https://github.com/rcedgar/muscle/releases/download/5.1.0/muscle5.1.linux_intel64

sudo ln -s muscle5.1.linux_intel64 muscle5

cd /media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign
nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta
nohup muscle5 -super5 $nostocReads -output nostoc16sAlignment.fa &> nostoc16sAlignment.log &

cd /media/vol1/daniel/nostoc/



## maybe try subsetting. subset to the very highest matches, to the same  

cd /media/vol1/daniel/nostoc/blastout

grep "JN847344.1.1541" nostocMatches.csv > leptoNostocBlastMatches.csv 

cut -d, -f3 leptoNostocBlastMatches.csv 

wc -l  nostocMatches.csv

## this looks like it is still failing. 
## don't understand. In the blast matches, these all look similar, 
## at a glance:

grep -c "^>" /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt ## pretty much all leptogium nostoc seqs covered

less /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt 

grep "|||" -A 1 -B 1 /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
less

grep "Plus/Plus" -A 4 /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
less

## there are reads in both directions, but I assume muscle can handle this

## different approach: pick out a subset, ~100 reads. 
## how do we know to which ones are the good ones?

## read into python, pick out the top ones according to escore or bits, with 
## strict minimums, maybe direction (strand = Plus/Plus)?

## or another simple test - look for strict matches to a sequence from the ref
## take all the ones that match this, they should mostly be in the same direction
## and pretty high quality:


## eg this sequence, which occurs in the middle, somewhere around 1050 bp:

less /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt 

grep  "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
grep  "AAACCGGAGGAAGGTGG" 

grep "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
grep -c "AAACCGGAGGAAGGTGG" 

## still 377 sequences


## to pull these out of our nostoc sequences:

cd /media/vol1/daniel/nostoc/minionReadsNostoc

grep -c "AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta 
## only 529, not sure if this is intellectually satisfying...try it

python3 

import pandas as pd
from Bio import SeqIO
from Bio import AlignIO

import matplotlib.pyplot as plt; plt.ion()
import os
import re

nostocReads = "/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta"
patt = re.compile("AAACCGGAGGAAGGTGG")

## find all sequences with a strict match to this 

patt = re.compile("AAACCGGAGGAAGGTGG")
a=0
strictMatches = []
for values in SeqIO.parse(nostocReads, "fasta"):
    if patt.findall(str(values.seq)) and len(values.seq) > 1000  :
        a+=1
        print(values.id)
        patt.findall(str(values.seq)) 
        strictMatches.append(values)

print(a) ## 632 matches

SeqIO.write(strictMatches, "leptogium_subsetStrict.fasta", "fasta")

## try our multiple alignment with this instead
## back in shell:

cd /media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign

lepFasta=/media/vol1/daniel/nostoc/minionReadsNostoc/leptogium_subsetStrict.fasta
nohup muscle5 -super5 $lepFasta -output lepNost16sAlignment.fa &> lepNost16sAlignment.log &

## let that run tonight. 
## the smaller one (lepto only) is available 

#wget http://ormbunkar.se/aliview/downloads/linux/linux-version-1.28/aliview.install.run

## doesn't look great.

## I do not know if this is shit data, or diverse data

## I think we have to manually curate 

## use eugene?
wget https://github.com/ugeneunipro/ugene/releases/download/50.0/ugene-50.0-linux-x86-64.tar.gz
tar -xf ugene-50.0-linux-x86-64.tar.gz

## on local:

file2get="/media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign/lepNost16sAlignment.fa"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/msa/lepNost16sAlignment_original.fa"
scp -r test@132.180.112.115:$file2get $putHere

## to get it on the office comp:
file2get="/media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign/lepNost16sAlignment.fa"
putHere="/media/vol/nostocBigFiles/"
scp -r test@132.180.112.115:$file2get $putHere

cd /home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/msa

/home/daniel/ugene-50.0/ugene -ui &

## then hand curation in ugene:
##  1. deleted first 470 bp or so, these were only found in our fourth read, chimeric
##  2. deleted any columns that consisted of 95% gaps or more. This brought the majority
##     of sequence lengths to ~1485 bp, approximately the expected length for 16s
##  3. So trimmed off ends after 1485
##  4. did an addition filter of removing any column with 60% or more missing bps  
##  5. that rep sequence was exported, then entered into the alignment, and any site that 
##     showed 20% for at least two BP is relabeled as "N", in a separate file

## the consensus sequence is upper/lower case based on quality:
aa=$(cat leptoNostoc_draftConsensus.txt)
echo ">leptoNostoc_draftConsensus" > leptoNostoc_draftConsensus.fasta
echo ${aa^^} >> leptoNostoc_draftConsensus.fasta
#rm leptoNostoc_draftConsensus.txt
cat leptoNostoc_draftConsensus.fasta

## how does this blast?
## without Ns, still best blast is the leptogium symbiont:
## KF359696.1, PID 98.24, eval=0.0, bitscore 2471

## with Ns, still best blast is the leptogium symbiont. Match scores lower, makes sense

## we can try putting both on a 16s tree of cyanobacteria

## then hang it on a tree. How do we do that?

## pipeline here:
https://github.com/FGPLab/cydrasil

## step one, align our sequence against their reference sequence set:
## they recommend one of two alignment software, ssh-aligner or papara
## so ssh. Let's use ssh-align, start with the N-containing consensus  

## this is already installed somewhere on our lab comp:
conda activate cydrasil

cd /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/placeConsensusSeqOnCydrasil

## the various files we need:
cydDir=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/
querySeq=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/leptoNostoc_withN.fa
refAlignment=${cydDir}Cydrasil-v3-reference-alignment.afa
mask=${cydDir}cydrasil-v3-ssu-align.bacteria.mask
tree=${cydDir}cydrasil-v3-reference-tree.nwk
model=${cydDir}cydrasil-v3.bestModel

## all there?
ls -l $querySeq
ls -l $refAlignment
ls -l $mask
ls -l $tree
ls -l $model

## I don't know if we need to do the alignment step when we only have
## one sequence?

## we need some sort of alignment, because they want an SSU-Align alignment model
ssu-align $querySeq ssuAl

## mask it:
ssu-mask -s $mask ssuAl/

## convert back to fasta:
ssu-esl-reformat -o ssuAl/ssuAl.bacteria.mask.afa afa ssuAl/ssuAl.bacteria.mask.stk

## this should now be generally aligned with SSU reads from the rest of the
## world, ready for placement:

queryAligned=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/placeConsensusSeqOnCydrasil/ssuAl/ssuAl.bacteria.mask.afa

## placement on tree

## this works:
epa-ng -s $refAlignment \
       -t $tree \
       -q $queryAligned \
       -m $model --redo

# ## without redo, aborts. Why??
# epa-ng -s $refAlignment \
#        -t $tree \
#        -q $queryAligned \
#        -m $model 

## that seems to have worked

## makes a "jplace" file that is pretty much a newick file, I think, that ITOL can use. 

## we'll try visualization on itol as per instructions

## danchurch is itol login name

## the info is a bit outdated as far as how to root the tree

## check out these articles:
https://communities.springernature.com/posts/margulisbacteria-and-saganbacteria-the-newly-uncovered-siblings-of-cyanobacteria
https://www.nature.com/articles/s41396-021-00898-x

## the github for cydrasil suggests searching for WOR-1 bacteria, or White-Oak-River bacteria, 
## which are called Sagenbacteria in the article.

## According to this article, all of the Margulisbacteria and Sagenbacteria (hah!)
## are a sister group to cyanos. So find the branch for all of these 
## sequences and bend the tree there

## At time of writing, this is the node between gleobacter and these 
## MargulisBacter/Sagenbacter/Sericytochromatia things: 2528

## how do I find my placed sequence?

## in the iTOL control panel, use the "Datasets" tab, 
## a "Datasets" box should pop up, allow you to toggle the placements in the file
## then the "search placements" box should pop up, and allow highlighting 

## regardless of root, this placement also puts our nostoc right in there 
## with:

## FJ815291.1 = Peltigera-associated Nostoc
## JX088109.1 = freshwater aquatic calothrix from NZ
## KT760404.1 = undescribed n-fixing nostoc from grassland soil of NZ (unpub)
## JQ771626.1 = Finnish peltigera

## related:
## the closest blast from microbial genomes of NCBI is to N. punctiforme, with 90% seq sim in 16S
## and for just 16S sequences from genbank, it blasts at 91.26% seq sim to two Nostocs:
KF359696.1, a leptogium symbiont, and JN847344.1, also from leptogium.

## Nostoc.s sp.str KVJ20  = liverwort symbiont
## the genome for this has been sequenced: https://doi.org/10.1128/mra.01190-19

## what about our old friends, closest blast matches: JN847344.1.1541 and KF359696.1

less ${cydDir}Cydrasil-v3-reference-alignment.afa ## they aren't in there, as far as I can tell

## do we need/want a graphic for our JGI application?



############## start over with new nostocs #############

## we have repeated the same nanopore sequencing process
## on some nostoc colonies isolated from other hosts


## We had to do the sequencing without the basecalling because
## of software updates and driver issues. How can we start the basecalling of
## the Pod5 voltage files we created?

## which are here, btw:
/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5


## maybe some help here:
## https://nanoporetech.com/document/data-analysis

## back up the read files:

cd /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90

tar cvzf nostocColonyPCRsRound2.tar.gz pod5/

## back this up to desktop:

cd /media/vol/mossStuff/nostocColonyPCRbackups
rsync -auv test@132.180.112.115:/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/nostocColonyPCRsRound2.tar.gz . 

## as far as basecalling, is it as simple as?:

#mkdir /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled
outDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled"
pod5="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5"
dorado basecaller sup $pod5 -v --device cuda:all --emit-fastq -o $outDir

(dorado basecaller sup $pod5 -v --device cuda:all --emit-fastq -o $outDir & ) &

## seems to work. As per the documentation (https://dorado-docs.readthedocs.io/en/latest/)
## pipe the results to the demultiplexer:

dorado basecaller sup $pod5 --device cuda:all -v |
dorado demux --output demuxed -v

dorado basecaller ... | dorado demux --output demuxed

dorado basecaller sup

dorado demux --output demuxed

## not working for me, not sure why. Try on basecalled files without piping 
## commands:

reads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/calls_2025-07-19_T09-33-22.fastq"
demuxDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed"
dorado demux --kit-name SQK-RBK114-24 --emit-fastq -o $demuxDir $reads

## but the vast majority are unclassified.
## maybe because I'm not using BAM formatting?
## see here: https://github.com/nanoporetech/dorado/issues/1178

## maybe something like:

pod5="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5"
demuxDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed"

dorado basecaller sup $pod5 -v --device cuda:all | dorado demux --kit-name SQK-RBK114-24 -o $demuxDir $reads

## that helped dramatically. The vast majority are still unclassified reads, though. 
## Also reads from barcodes that were not in my study. These are either erroneous or 
## from Dimitri's experiments. 

## any other defaults we can tweak? break up the command:

pod5="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5"
demuxDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed"
basecalledDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/basecalled"

cd $pod5

dorado basecaller -v --device cuda:all  -o $basecalledDir sup $pod5 

## is trimming the default? try turning it off. 
dorado basecaller -v --no-trim --device cuda:all  -o $basecalledDir sup $pod5

## GPU is working hard:
nvidia-smi -l 5

############ duplex basecalling possible? #############

## is it possible to rerun basecalling, in duplex mode?
## https://nanoporetech.com/document/kit-14-device-and-informatics#basecalling-kit-14-duplex-data
## not sure if we missed a step somewhere that would preclude this 

## somthing like this (not run)
dorado duplex dna_r10.4.1_e8.2_400bps_sup@v4.1.0 pod5s/ > duplex.bam

## didn't seem to help much...
###########################################################


## now try demultiplexing...
dorado demux -v --kit-name SQK-RBK114-24 -o $demuxDir $basecalledDir

## that helped a lot, we're up to 31% classified. Still low, though...
## any errors reported in veryVerbose mode?

dorado demux -vv --kit-name SQK-RBK114-24 -o $demuxDir $basecalledDir 2> log.txt

dorado demux -h | less

grep -c "midstrand" log.txt ## 23810 hits, lots. May be why we have low classification %

## is there a way to ignore these mid strand barcodes?
## don't see it. 

## there is mention about this:
https://github.com/nanoporetech/dorado/issues/1178

## somewhere there is a toml file to change the scoring for midstrand
## and other issues. 

## trim primers and adapters?
## for now just adapters. We might need the primers to clear things up (nif vs. 16s, etc)
## coming back to this, realized that the demux step also has an default trim option
## so this didn't matter. To retain adapters, I guess you have to tell it during demuxing and
## trimming stages

trimmedDir=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed

cd /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed

demuxedFile1="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.bam"
dorado trim \
    -k SQK-RBK114-24 \
    -v \
    --no-trim-primers \
    --emit-fastq \
    $demuxedFile1 > ${trimmedDir}/${demuxedFile1}


for demuxedFile in *bam; do
  echo "Starting ${demuxedFile}"
  dorado trim \
    -k SQK-RBK114-24 \
    -v \
    --no-trim-primers \
    --emit-fastq \
    $demuxedFile > ${trimmedDir}/${demuxedFile/\.bam/\.fastq}
  echo "Done ${demuxedFile}"
done

## try aligning to 16s, NifH, etc. 

## on line 188 above, we made a formatted blastn database for finding
## hits to nostoc, try it here for our 16s reads.
## would be barcodes 9-11

## need to convert to fasta

seqtk seq -A 2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq > 

outDir=/media/vol1/daniel/nostoc/blastout/round1_Hylocomium/round2_ZygodonHomaliaAmbylostegium

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta

minionReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed

cd $minionReads
for i in 2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode{09..11}.fastq; do
  echo $i
  j=${i/*SQK-RBK114-24/nostoc_16S}
  k=${j/\.fastq/\.fasta}
  l=${k/\.fasta/\_cyanoMatches.csv}
  seqtk seq -A $i > $k
  echo $l
  blastn -db $cyanoDB \
    -query $k \
    -num_threads 10 \
    -num_alignments 1 \
    -out $l \
    -outfmt 10 
done

mv *cyanoMatches.csv /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/




## for the moment, let's see if we can make sense of our 16s. Worried about
## the Amblystegium, doesn't come out cleanly as a nostoc

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/

grep "Nostocaceae;Nostoc" nostoc_16S_barcode09_cyanoMatches.csv 

grep -c  "Nostocaceae" nostoc_16S_barcode09_cyanoMatches.csv ## 350
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode09_cyanoMatches.csv ## 64, out of...

grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq ## 4367 reads
wc -l nostoc_16S_barcode09_cyanoMatches.csv ## and 3861 of these 4367 matched to cyanobacteria? seems high.
## before, in hylocomium, only 25% matched to cyanobacteria, but of these almost all matched nostoc. 

## could this be a relic of the fact that we parsed our database down to just cyanbacteria? What happens
## if we blast again all bacteria?

## download full silva db, blast against this?

wget https://www.arb-silva.de/fileadmin/silva_databases/release_138/Exports/SILVA_138_SSURef_tax_silva.fasta.gz

mv SILVA_138_SSURef_tax_silva.fasta.gz /media/vol1/daniel/databases/silva

cd /media/vol1/daniel/databases/silva

gunzip SILVA_138_SSURef_tax_silva.fasta.gz 

head -n 100 SILVA_138_SSURef_tax_silva.fasta  ## ugh the spaces are going to cause a problem in the headers.


## nostoc punctiforme from the PCC:
grep -A1 "AF027655" silva138_SSU_reformathead.fasta


clear
head -n 1 SILVA_138_SSURef_tax_silva.fasta 

## this seems to work, get rid of first space
head -n 1 SILVA_138_SSURef_tax_silva.fasta | sed -r 's/(^>[^ ]*) /\1;/' 

## try for the whole file:
sed -r 's/(^>[^ ]*) /\1;/' SILVA_138_SSURef_tax_silva.fasta > silva138_SSU_reformathead.fasta

## do it without parsing seq ids, because of our very long headers.
makeblastdb -in silva138_SSU_reformathead.fasta -dbtype nucl 



cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq"

## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}

blastn -db $blastDB \
  -query ${readFile/\.fastq/\.fasta} \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode9-allSilva.csv \
  -outfmt 10 

## did this make a difference?
grep -c "Nostocaceae;Nostoc" nostoc_16S_barcode09_cyanoMatches.csv ## 64
grep -c "Nostocaceae;Nostoc" round2Barcode9-allSilva.csv  ## 9
## quite. 

grep -c  "Nostocaceae" nostoc_16S_barcode09_cyanoMatches.csv ## 350
grep -c  "Nostocaceae" round2Barcode9-allSilva.csv ## 26, many of which are calothrix.

grep "Nostocaceae" nostoc_16S_barcode09_cyanoMatches.csv 
grep "Nostocaceae" round2Barcode9-allSilva.csv ## 26, 

## anyway, not sure what to do with this barcode. I cannot tell if we actually sequenced the c.f. nostoc colony 
## or not. 

## that will run for a while?
## and the others?

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

## barcode 10 should be nostoc from Homalia:
grep -c  "Nostocaceae" nostoc_16S_barcode10_cyanoMatches.csv ## 393
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode10_cyanoMatches.csv ## 380, out of...
grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq ## 569 reads
## that is simpler, clearly a nostoc. But not abundant, let's hope we can work with that.

## barcode 11 should be nostoc from Zygodon:
grep -c  "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv ## 1762
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode11_cyanoMatches.csv ## 1121, out of...
grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq ## 4859 reads

################# barcode 9 get consensus seq ############################

## can we get barcode 9 working? though listed first, this is our last 
## 16s effort of the three from the most recent nanopore sequencing
## data.

## because at first glance, this was the worst data. Rerun the blast check for nostocs, to be sure

blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq"
## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}
#nohup blastn -db $blastDB \
#        -query ${readFile/\.fastq/\.fasta} \
#        -num_threads 10 \
#        -num_alignments 1 \
#        -out round2Barcode09-allSilva.csv \
#        -outfmt 10 & ## 

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode09-allSilva.csv

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09

wc -l round2Barcode09-allSilva.csv  ## 4030. Lots of reads. Probably pseudomonas.

grep -c "Nostocaceae;Nostoc" round2Barcode09-allSilva.csv  ## 9. Probably not a nostoc. 

grep -c "Cyanobacteriia" round2Barcode09-allSilva.csv  ## more. 

grep "Cyanobacteriia" round2Barcode09-allSilva.csv  ## vast majority to unidentified Oxyphotobacteria (=Cyanophycaceae), the parent order of all normal cyanos. Great.

## any particularly prominent ones?

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09')

all16sMatches = pd.read_csv('round2Barcode09-allSilva.csv', index_col='qseqid')

## all of these have been id'd to nostoc, so get rid of taxonomy
all16sMatches['sseqid'] = all16sMatches['sseqid'].str.split(';', expand=True)[[0]]

all16sMatches.head()

all16sMatches.groupby('sseqid').count() 
## the most common match (117 matches) is JQ007760.1.1503, host Peltigera degenii, from Kaasalainen et al. (2012) 
## "Cyanobacteria produce a high variety of hepatotoxic peptides in lichen symbiosis"
## second most common (43) is nephroma cyanobiont HQ591517.1.1534
## at some point, we need to compare with our Hylocomium symbiont. Where is our consensus sequence for this?

pd.set_option('display.max_rows', None)

aa = all16sMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True) 


## the two most common hits are to completely unknown, uncultured bacteria with 
## no taxonomic information. One is free living on various outdoor substrates
## at a park in SW china (KF037401), the other is a human wound-inhabiting bacteria. 
## great. I want to quit. 

## subset to just cyanobacteria:
grep "Cyanobacteriia" round2Barcode09-allSilva.csv > allCyanoMatchesBC09.csv
#sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' allCyanoMatchesBC09.csv

allcyanoMatches = pd.read_csv('allCyanoMatchesBC09.csv', index_col='qseqid')

allcyanoMatches['sseqid'] = allcyanoMatches['sseqid'].str.split(';', expand=True)[[0]]

allcyanoMatches.head()

aa = allcyanoMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## the most common taxa is KF037287.1.1456
## well, weird, this blasts to the same paper as with our all-taxa, 
## the genbank accession has no taxonomic information, but silva does?

## meh focus on the nifH genes. I assume there is a mess waiting there, also.
## here it looks like we missed the nostoc and sequenced something else, 
## a poorly known microbe.
## we can try resequencing this later? Check on the colonies, sequence 
## exactly the colony you use for microscopy.

################# barcode 10 get consensus seq ############################

## both are more promising. Start with barcode10. 

## just curious, are there a lot of duplicate reads, as before? 
## Could skewing results here.
readDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
barcode="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"

seqtk seq -A ${readDir}/${barcode} | sed -n "/>/p" |  cut -f 1 -d " " | sort | uniq -d ## I see no dups

grep "Nostocaceae;Nostoc" nostoc_16S_barcode10_cyanoMatches.csv > barcode10_nostocMatches.csv

cut -f1 -d, barcode10_nostocMatches.csv > barcode10_nostocReads.txt

## use seqtk to keep only the matches to nostoc
allReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"
seqtk subseq $allReads barcode10_nostocReads.txt > barcode10_onlyNostoc.fastq

wc -l barcode10_onlyNostoc.fastq
wc -l barcode10_nostocMatches.csv

## add headers

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode10_nostocMatches.csv

## check out barcode 10 with python:

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10')

nostocMatches = pd.read_csv('barcode10_nostocMatches.csv', index_col='qseqid')
## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

nostocMatches.groupby('sseqid').count() 
## the most common match (117 matches) is JQ007760.1.1503, host Peltigera degenii, from Kaasalainen et al. (2012) 
## "Cyanobacteria produce a high variety of hepatotoxic peptides in lichen symbiosis"
## second most common (43) is nephroma cyanobiont HQ591517.1.1534
## at some point, we need to compare with our Hylocomium symbiont. Where is our consensus sequence for this?

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()

bb = aa.T.iloc[0,:].sort_values(ascending=False)

peltigeraMatches = nostocMatches[nostocMatches['sseqid']=='JQ007760.1.1503']

nephromaMatches = nostocMatches[nostocMatches['sseqid']=='HQ591517.1.1534']

pd.set_option('display.max_rows', None)

peltigeraMatches

nephromaMatches

## both are very strong. Perhaps we have two strains? Hard to tell.

##  

peltigeraMatches[['pident', 'length']].mean() ## on average, 95% match

## overall picture:
aa = nostocMatches[['sseqid', 'pident', 'length']].groupby('sseqid')


nephromaMatches[['pident', 'length']].mean() ## on average, 95% match also.

## so halfway between two cyanobionts. Kind of like last time. 

## at this point, before, we used the best blast matches to nostoc, 
## selected ~500 seqs with strict matches to a particular region 
## aligned these, and manually curated a consensus sequence for downsteam

## last time, SSUalign didn't work that well, but I think we may have
## cleaner data this time, or at least smaller data. Let's try to align our 
## barcode 10 reads that aligned 

readDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
barcode="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"

/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium


conda activate cydrasil

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}
nohup ssu-align -f ${barcode/.fastq/.fasta} msaBarcode10 
ssu-mask msaBarcode10 

conda activate jalview

jalview 

## this is a worthless alignment, as before. Not sure why.

## try muscle: 

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}

muscle -in ${barcode/.fastq/.fasta} -out muscleMSAbarcode10.fa

## looks promising. Grab it locally:

rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSAbarcode10.fa \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## and it's a mess. Hard to identify what is best here. we can do a lot of manual
## editing to the alignment to maybe get a consensus sequence. But let's 
## repeat the first pipeline we did, of looking for a region of high-agreement 
## in the verbose blast document, and selecting reads that contain this region 

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

#readDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
#barcode="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"
readDir="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium"
barcode="barcode10_onlyNostoc.fastq"
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}
nostocReads=${barcode/.fastq/.fasta}
cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta
nohup blastn -db $cyanoDB \
  -query ${barcode/.fastq/.fasta} \
  -num_threads 10 \
  -num_alignments 1 \
  -out barcode10nostocs_2cyanoSilvaVerbose.txt &
  #-out barcode10minion2cyanoMatchesVerbose.txt &

######################################################################################################
## to review, last time we randomly grabbed a conserved region around position 1050 :
## less /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatchesVerbose.txt 
## grep  "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatchesVerbose.txt |
## grep  "AAACCGGAGGAAGGTGG"  
## ## which took us from many (35,220) of matches to 400 or so:
## grep -c  "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatchesVerbose.txt 
## wc -l /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatches.csv
## still not sure if that was a good way to do this...
######################################################################################################

## is this sequence also in our new nostoc?

grep "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10minion2cyanoMatchesVerbose.txt |
grep  "AAACCGGAGGAAGGTGG"  
## yes, but scattered all over the place.

## how are our qualities of these reads that aligned to nostocaceae

fastqc barcode10_onlyNostoc.fastq

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

## checking on just these nostoc...
fastqc -t 10 -o /media/vol1/daniel/nostoc/fastqcOutputs/round2/barcode10 barcode10_onlyNostoc.fastq

rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/fastqcOutputs/round2/barcode10/barcode10_onlyNostoc_fastqc.html \
  /home/daniel/Documents/projects/mossSymbiosis/fastqc/

## they actually seem quite good, for nanopore, somewhere around 28 for most of the positions of most of the reads.

## let see if we can identify and other sequence that could be useful
## maybe let's try to hit the v4 region, inside the normal EMB primers 515/806

less barcode10nostocs_2cyanoSilvaVerbose.txt

## eg this sequence, or RC:
grep -c "AAGAGTCTAGCTCAACTAGATAAGAGCAGTGGAAACTAC\|GTAGTTTCCACTGCTCTTATCTAGTTGAGCTAGACTCTT" barcode10_onlyNostoc.fasta 
## 60 hits, out of 569 ~ 10% of reads in the barcode

## eg this sequence, or RC:
grep -c "GCATTTCACCGCTACACCAGGAATTCCCTCTGCCCCGAA\|TTCGGGGCAGAGGGAATTCCTGGTGTAGCGGTGAAATGC" barcode10_onlyNostoc.fasta 
## 56 hits

## if we go to the just the matches to our most common match, JQ007760.1.1503:
grep -c ">JQ007760" barcode10nostocs_2cyanoSilvaVerbose.txt  ## 121 matches. look at these



## some possibilities:

grep -c "TTCTTCCTGATCTCTACGCATTTCACCGCTACACCA\|TGGTGTAGCGGTGAAATGCGTAGAGATCAGGAAGAA" barcode10_onlyNostoc.fasta

## meh, unlike last time, I think we are dealing with intentionally fragmented amplicons,
## from tagmentation, so it is probably best to simply use all the sequences that align with our most 
## common match.

## then we can use this align to structure the rest, as per https://drive5.com/muscle/manual/addtomsa.html

## so, let's pull out those with just an best hit to JQ007760.1.1503:

less barcode10_nostocMatches.csv 

grep -c JQ007760 barcode10_nostocMatches.csv 

#grep JQ007760.1.1503 barcode10_nostocMatches.csv > barcode10_nostocJQ007760Matches.csv
## don't rerun unless you need to! Hand-edited to remove a few sequences, below
cut -f1 -d, barcode10_nostocJQ007760Matches.csv > barcode10_JQ007760Reads.txt


allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_JQ007760Reads.txt > barcode10_JQ007760.fastq

## let's try aligning these:


cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

readDir=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium
barcode=barcode10_JQ007760.fastq
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}

muscle -in ${barcode/.fastq/.fasta} -out muscleMSA_barcode10_JQ007760.fa

rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSA_barcode10_JQ007760.fa \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## actually looks good. Time for some hand editing.

## record of hand-edits of round2 barcode 10 blast matches to JQ007760

## 1 the following sequences don't fit in the alignment at all. I'm not sure what happened. 
#    for the moment, removing them and rerun alignment as above:

2b8c14b7-24e5-4306-8954-ff42c0098a21
2d8a4e8e-0771-41b9-b1f2-5c699df1dcbe
71337ef8-62aa-49fe-872e-83fad3ed302c
7dcfc702-f1cd-4dec-9d6d-318bbf6ea096
9080bca4-5689-426d-af53-0b0aa9f107be
925d2359-c67a-4076-bfc5-b59def3a5f9e
dfc03e80-3375-4193-baec-e3408bf0b186
e3322d0f-3fc4-4708-b442-25403222eeb4

## saved as weirdJQ007760matches.txt

## removed these by hand from our list of sequences for the msa
#vim barcode10_nostocJQ007760Matches.csv

## then rerun above code to run the msa
cut -f1 -d, barcode10_nostocJQ007760Matches.csv > barcode10_JQ007760Reads.txt
allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_JQ007760Reads.txt > barcode10_JQ007760.fastq


cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

readDir=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium
barcode=barcode10_JQ007760.fastq
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}
muscle -in ${barcode/.fastq/.fasta} -out muscleMSA_barcode10_JQ007760.fa

## from desktop:
rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSA_barcode10_JQ007760.fa \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## following this, some more hand-editing in ugene, removed all gaps that were 90% or more empty.
## also removed all gaps that were mostly empty and next to homopolymers, especially if the
## gap was created by the same nucleotide in the homopolymer in a few reads (cause Nanopore).
## then clipped the first 134 bp from the alignment, there was a lot of noise in the 
## early reads and low coverage. Must be the tagmentation issue?

## anyway, here is at least one consensus seq from that effort (barcode 10, sequences that blast to JQ007760 from Homalia)
>Consensus seq for Nostoc from Homalia
aaggcgtaaggggcatgctgacttgacgtcatccccaccttcctccggtttgtcaccggcagtctctctagagtgcccaacttaatgctggcaactaaaaacgagggttgcgctcgttgcgggacttaacccaacatctcacgacacgagctgacgacagccatgcaccacctgtgttcgcgctcccgaaggcacttgaagctttcactccaattcgcgacatgtcaagccttggtaaggttcttcgcgttgcatcgaattaaaccacatactccaccgcttgtgcgggcccccgtcaattcctttgagtttcaccgttgccggcgtactccccaggcgggatacttaacgcgttagctacggcacggctcgggtcgatacaagccacgcctagtatccatcgtttacggctaggactactggggtatctaatcccattcgctcccctagctttcgtccctcagtgtcagttgcggcctagcagagcgccttcgccaccggtgtttctcctgatctctacgcatttcaccgctacaccaggaattccctctgcccgaacgcactctagcgatgtagtttccactgctctttatctagttgagctagactctttaacagcagacttacatcgccacctgcggacgctttacgcccaatcattccggataacgcttgcatcctccgtattaccgcggctgctggcacggagttagccgatgcttattcctcaggtaccgtcattgtgttcttccctgagaaaagaggtttacgacccaagagccttcctccctcacgcggtattgctccgtcaggctttcgcccattgcggaaaattccccactgctgcctcccgtaggagtctgggccgtgtctcagtcccagtgtggctgatcgtcctctcagaccagctactgatcgtcgccttggtaggctcttactctaccaactagctaatcagacgcgagctcatcttcaggcagttaacctttcaccccgaagggcacatccggtattagccaccgtttccagtggttgtcccagacctgaagccagattctcacgcgttactcacccgtccgccactaaatcccgaaagatttcgttcgacttgcatgtgttaagcataccgccagcgttcatcctgagcca

## as predicted, still blasts best to peltigera symbionts, especially the JQ007760 accesssion
## maybe tomorrow rerun the alignment of all nostocs with this as a reference seq? 

## why not?...following: https://drive5.com/muscle/manual/addtomsa.html

## first, remove the sequences we already have in our alignment to JQ007760 from our larger, aligned-to-nostoc file:

## on nanoComp:

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

## sequences we don't need (already in alignment):

wc -l barcode10_nostocJQ007760Matches.csv 

cut -f 1 barcode10_nostocJQ007760Matches.csv -d ,

## we need to modify:

wc -l barcode10_nostocMatches.csv 

## so something like:

cat <(cut -f 1 barcode10_nostocJQ007760Matches.csv -d ,) <(cut -f 1 barcode10_nostocMatches.csv -d ,) | 
     sort | 
     uniq -u | 
     sed '/qseqid/d' > barcode10_nostoc_NOT_JQ007760readNames.txt

     barcode10_nostoc_NOT_JQ007760readNames.txt
     seqtk sub


allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_nostoc_NOT_JQ007760readNames.txt > barcode10_nostoc_nonJQ007760Matches.fasta

## back to: https://drive5.com/muscle/manual/addtomsa.html
## run an alignment on these:

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

readDir=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium
reads=barcode10_nostoc_nonJQ007760Matches.fasta

seqtk seq -A ${readDir}/${reads} > ${reads/.fastq/.fasta}

muscle -in ${reads/.fastq/.fasta} -out muscleMSA_barcode10_notJQ007760.afa

muscle -profile -in1 muscleMSA_barcode10_JQ007760.fa -in2 muscleMSA_barcode10_notJQ007760.afa -out muscleMSA_barcode10_Nostoc_onJQ007760.afa

## did that work? look at it:
getFile="muscleMSA_barcode10_Nostoc_onJQ007760.afa"
rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/${getFile} \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## interesting, the blast results might be accurate. As in, there may be multiple strains here. I think I see support for
## at least two. What does it look like if we make a tree on these sequences, as is?

cd /media/vol1/daniel/nostoc/16sTree/round2/barcode10
alignment="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSA_barcode10_Nostoc_onJQ007760.afa"
FastTree -gtr -nt < $alignment > barcode10_Nostoc_onJQ007760.nwk

getFile="/media/vol1/daniel/nostoc/16sTree/round2/barcode10/barcode10_Nostoc_onJQ007760.nwk"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/


## yes, it's a mess, but looks like perhaps four groups. Not sure about their sequence difference,
## but it is really hard to distinguish them from noise. 
## for the moment, move on

## for now accept the above consensus seq. Try the same pipeline for barcode11

## return to this 30.07.2025
## and this approach really didn't work for barcode11. Too noisy.
## instead, below we aligned with SINA using a reference alignment
## from the cyanoseq database, then created a hmm profile from the
## alignment and generated a consensus sequence from this. 
## for consistency, let's apply this approach here. We can compare
## the consensus sequences, to see how consistent the two 
## approaches are.

## last time, we found some error due to the blast database used.
## let's make sure we use the entire silva 

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10

blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"
## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}
nohup blastn -db $blastDB \
        -query ${readFile/\.fastq/\.fasta} \
        -num_threads 10 \
        -num_alignments 1 \
        -out round2Barcode10-allSilva.csv \
        -outfmt 10 & ## 

grep -c "Nostocaceae;Nostoc" round2Barcode10-allSilva.csv  ## 375


## pull out the nostoc-like things:
grep "Nostocaceae;Nostoc" round2Barcode10-allSilva.csv > barcode10_nostocMatches.csv
sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode10_nostocMatches.csv

####### 
python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

nostocMatches = pd.read_csv('barcode10_nostocMatches.csv', index_col='qseqid')

## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]
nostocMatches.head()
nostocMatches.groupby('sseqid').count() 
aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)

## as before, JQ007760.1.1503 is still the most common match

grep JQ007760.1 barcode10_nostocMatches.csv > barcode10_nostocJQ007760Matches.csv
cut -f1 -d, barcode10_nostocJQ007760Matches.csv > barcode10_JQ007760Reads.txt
allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_JQ007760Reads.txt > barcode10_JQ007760.fastq

## so, align these with SINA against the cyanoseq db:
conda activate sina

cyanoseqARB=/media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.arb

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10

less barcode10_JQ007760.fastq

fastq="barcode10_JQ007760.fastq"
blastoutDir="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10"
#ls -l ${blastoutDir}/${fastq}
fasta=${fastq/\.fastq/\.fasta}
seqtk seq -A ${blastoutDir}/${fastq} > $fasta
cyanoseqARB=/media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.arb

sina \
  -i $fasta \
  -o ${fasta/\.fasta/aligned_cyanoseq.afa} \
  --db $cyanoseqARB &> log.txt

## as below, lots of errors. But I guess they can be ignored?

ls ${fasta/\.fasta/aligned_cyanoseq.afa} 


## how does this look?

getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/barcode10_JQ007760aligned_cyanoseq.afa"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

ugene -ui barcode10_JQ007760aligned_cyanoseq.afa ## that is noisier than our barcode11 ashitsuki matches below. 


## oh well. Try a consensus seq:

## as before hanging BPs to be manually removed
##c61c2933-c3be-4865-97eb-98bbcce1d3db
##2a4ec9cb-e3ae-4238-9ffc-83cc178a78be
vim ${alignDir}/${alignFile}

alignDir="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10"
alignFile="barcode10_JQ007760aligned_cyanoseq.afa"
hmmbuild barcode10_JQ007760.hmm ${alignDir}/${alignFile}

## and ask for a "plurality" type consensus:
hmmemit -c -o barcode10_nostoc_JQ007760_16s_consensus.fasta barcode10_JQ007760.hmm

## RNA to DNA
sed -i '/^[^>]/ y/uU/tT/' barcode10_nostoc_JQ007760_16s_consensus.fasta 

less barcode10_nostoc_JQ007760_16s_consensus.fasta 


cd  /media/vol1/daniel/nostoc/consensusSequences/

## yeah, don't think that helped. A quick blast match is basically 
## nonsense. 
## weird. keep the above consensus sequence. 


####################### barcode 11 #################################

## barcode 11 should be nostoc from Zygodon:

## reads here:
cd /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11

grep -c  "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv ## 1762
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode11_cyanoMatches.csv ## 1121, out of...
grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq ## 4859 reads

## run a check for bias from db. Run against the entire silva and pull out the nostocaceae and/or nostoc matches
blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq"
## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}
nohup blastn -db $blastDB \
        -query ${readFile/\.fastq/\.fasta} \
        -num_threads 10 \
        -num_alignments 1 \
        -out round2Barcode11-allSilva.csv \
        -outfmt 10 & ## 120290

## from these, we need only those that match to nostaceae, I think

grep -c "Nostocaceae" round2Barcode11-allSilva.csv ## only 33, out of 4859 reads. 

grep -c ";Nostoc," round2Barcode11-allSilva.csv ## 22 nostocs

## compare this to when we blasted to a cyano-only database:

grep -c "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv ## 1762 reads. 

grep -c ";Nostoc," nostoc_16S_barcode11_cyanoMatches.csv ## 1126 reads. so mostly nostocs

## big effect by reference database used. I am only taking the first match, this may be the issue.
## not sure which to trust.

## maybe check one record that appears a Nostoceae in our cyano-matches, but not as a nostoc our entire-silva db matches 
## - is it second/third match? So one that didn't make it into our full silva search.

##  

less round2Barcode11-allSilva.csv

cat <(grep "Nostocaceae" round2Barcode11-allSilva.csv | cut -f 1 -d ,) \
    <(grep "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv | cut -f 1 -d ,) | 
     sort | 
     uniq -u  | wc -l ## 1721 unique (unrepeated sequences)

cat <(grep "Nostocaceae" round2Barcode11-allSilva.csv | cut -f 1 -d ,) \
    <(grep "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv | cut -f 1 -d ,) | 
     sort | uniq -u | sed '/qseqid/d' 


## do all of these belong in the cyano-db blast results?
## anyway, most of them do, pick a few and make sure:

cyanoRds=(\
f9d89649-4261-45df-963c-ac3afa28ae03
f9f59d68-ba82-4593-b157-f5204c9f7c3f
f9ffe375-053d-4f4a-97ee-615793363c98
fa3affd9-65fd-4b3b-9328-ea80d3e6b83a
fad023b6-dad7-42ac-b08c-5b497e64f0d0
fad60fdc-feec-406f-bfa5-e0a0a66473ba
fb012ea3-8221-4acf-beae-0b0f85dd8f25
fb9925bb-7c5a-49ab-becc-a40c0c2fbd6d
fbd44391-7037-4773-9f3b-d62a11329ad2
)

## headers are: qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode11_nostocMatches.csv

for i in ${cyanoRds[@]}; do
  grep $i round2Barcode11-allSilva.csv | 
done ## in there, but...

for i in ${cyanoRds[@]}; do
  grep ${i} round2Barcode11-allSilva.csv | grep "Nostoc,"
done
## with the all silva database, only 4 out of 9 actually make to nostoc

for i in ${cyanoRds[@]}; do
  grep $i nostoc_16S_barcode11_cyanoMatches.csv
done
## yes in the cyano-only DB search

for i in ${cyanoRds[@]}; do
  grep $i nostoc_16S_barcode11_cyanoMatches.csv | grep "Nostoc,"
done
## same in the cyanoDB, 4 matches to nostoc

## the difference is that the remaining reads match to other weird 
## cyanos, with slightly weaker matches. 

## let's look at a few nostoc from our cyano-only DB 
## full silva search: 

## convert to fasta seq
nostocSeq="f9ffe375-053d-4f4a-97ee-615793363c98"
grep -A 1 $nostocSeq ${minionReads}/${readFile} | sed "s/^@/>/"

## when we blast this against the full NCBI database, we get a nostoc or some clost relative
## so why does our silva db search discard it?

nostocSeq="f9ffe375-053d-4f4a-97ee-615793363c98"
blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
## rerun, with multiple matches and verbose format:
## need a fasta
blastn -db $blastDB \
  -query <(grep -A 1 $nostocSeq ${minionReads}/${readFile} | sed "s/^@/>/") \
  -num_threads 10 \
  -out dissappearingNostocBlast.txt

grep $nostocSeq round2Barcode11-allSilva.csv 

## the full silva matches are probably more trustworthy, but 
## there isn't really a difference when we focus on just 
## strong nostoc matches

## as before, extract reads and blast results, see above for notes
## this time, since we have it, use the full silvaDB blast results

grep "Nostocaceae;Nostoc" round2Barcode11-allSilva.csv > barcode11_nostocMatches.csv ## down to 1023 matches. A little higher with cyanoDB, but trust this more
wc -l barcode11_nostocMatches.csv ## down to 1023 matches. A little higher with cyanoDB, but trust this more

cut -f1 -d, barcode11_nostocMatches.csv > barcode11_nostocReads.txt
allReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq"
seqtk subseq $allReads barcode11_nostocReads.txt > barcode11_onlyNostoc.fastq
sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode11_nostocMatches.csv

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11')

nostocMatches = pd.read_csv('barcode11_nostocMatches.csv', index_col='qseqid')
## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

pd.set_option('display.max_rows', None)

nostocMatches.groupby('sseqid').count() 

## again, at some point, we need to compare with our Hylocomium symbiont. Where is our consensus sequence for this?

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## AB511947.1.1445 (446 matches)
## AB511947 = wild, uncultured Nostoc verrucosum, an edible 
## next is FR798940 (167)
## FR798940 = "concrete-made fountain with stagnant water, black dry crust" 
## sounds like another free living bacteria.  
## KF037277.1.1457 (67 matches) is from tropical soil, China
## interesting, the accession doesn't give any taxonomy on this. 
## I only see the taxonomy in the manual blast reults

## AB511947.1.1445             446
## FR798940.1.1463             167
## KF037277.1.1457             67

ashitsukiMatches = nostocMatches[nostocMatches['sseqid']=='AB511947.1.1445']
concreteMatches = nostocMatches[nostocMatches['sseqid']=='FR798940.1.1463']
chinaMatches = nostocMatches[nostocMatches['sseqid']=='KF037277.1.1457']

pd.set_option('display.max_rows', None)


ashitsukiMatches[['pident', 'length']].mean() ## 94.9%, 687
concreteMatches [['pident', 'length']].mean() ## 95.0%, 734
chinaMatches[['pident', 'length']].mean() ## 93.6%, 333

## overall picture:

nostocMatches[['sseqid', 'pident', 'length']].groupby('sseqid').mean()

nostocMatches[['pident', 'length']].mean() ## 94.4%, 577 bp

## strategy here would be to extract each, make an alignment and consensus from 
## each and then compare

## ashitsuki Matches

## let's get a reference sequence, the PCC nostoc punctiforme sequence from NCBI (AF027655):

vim nostocPunctRefSeq.fasta
seqtk seq -l 0 nostocPunctRefSeq.fasta  > nostocPunctRefSeq_noLB.fasta
#mv nostocPunctRefSeq_noLB.fasta nostocPunctRefSeq.fasta 
## this might be useful for all alignments, put it somewhere
#mv nostocPunctRefSeq.fasta  /media/vol1/daniel/nostoc/ourNostocMSA/

refNostoc=/media/vol1/daniel/nostoc/ourNostocMSA/nostocPunctRefSeq.fasta

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11
#cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11
grep "AB511947.1.1445" barcode11_nostocMatches.csv | cut -d , -f 1 > barcode11_ashitsuki_nostocReadNames.txt
grep "FR798940.1.1463" barcode11_nostocMatches.csv | cut -d , -f 1 > barcode11_concrete_nostocReadNames.txt
grep "KF037277.1.1457" barcode11_nostocMatches.csv | cut -d , -f 1 > barcode11_China_nostocReadNames.txt
## as noted below in alignments, we have a chimeric read in the ashitsuki reads:
#grep ae9a27e6-1dfe-4513-b39f-997724c75732 barcode11_ashitsuki_nostocReadNames.txt
sed -i '/ae9a27e6-1dfe-4513-b39f-997724c75732/d' barcode11_ashitsuki_nostocReadNames.txt 
## and maybe this one, too. It may be cause a big gap in the alignment:
#grep 53fc4d0f-e611-43ac-b382-2ca69b9c1a67 barcode11_ashitsuki_nostocReadNames.txt
#sed -i '/ae9a27e6-1dfe-4513-b39f-997724c75732/d' barcode11_ashitsuki_nostocReadNames.txt 
## get these into a fasta:

allReads=2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fasta
seqtk subseq $allReads barcode11_ashitsuki_nostocReadNames.txt > barcode11_nostoc_ashitsuki.fasta
seqtk subseq $allReads barcode11_concrete_nostocReadNames.txt > barcode11_nostoc_concrete.fasta
seqtk subseq $allReads barcode11_China_nostocReadNames.txt > barcode11_nostoc_China.fasta
## get rid of crazy nanopore names
sed -i -r "s/^>([^ ]*).*/>concrete_\1/" barcode11_nostoc_concrete.fasta
sed -i -r "s/^>([^ ]*).*/>china_\1/" barcode11_nostoc_China.fasta 
sed -i -r "s/^>([^ ]*).*/>ashitsuki_\1/" barcode11_nostoc_ashitsuki.fasta
## keep just the first words:
for i in barcode*fasta; do
  sed -i -r "s/^(>[^-]*).*/\1/" $i
done
## and how do we get the blast match that seeded each of these?
#esearch -db "Nucleotide" -query "AB511947.1" | efetch -format "fasta" > AB511947.fasta
#esearch -db "Nucleotide" -query "FR798940.1" | efetch -format "fasta" > FR798940.fasta
#esearch -db "Nucleotide" -query "KF037277.1" | efetch -format "fasta" > KF037277.fasta
#seqtk seq -l 0 AB511947.fasta  > AB511947_noLB.fasta; mv AB511947_noLB.fasta AB511947.fasta 
#seqtk seq -l 0 FR798940.fasta  > FR798940_noLB.fasta; mv FR798940_noLB.fasta FR798940.fasta 
#seqtk seq -l 0 KF037277.fasta  > KF037277_noLB.fasta; mv KF037277_noLB.fasta KF037277.fasta 
cat AB511947.fasta barcode11_nostoc_ashitsuki.fasta > temp
mv temp barcode11_nostoc_ashitsuki.fasta 
cat FR798940.fasta barcode11_nostoc_concrete.fasta > temp
mv temp barcode11_nostoc_concrete.fasta
cat KF037277.fasta barcode11_nostoc_China.fasta > temp
mv temp barcode11_nostoc_China.fasta
## get rid of long headers:
sed -i -r "s/(>AB511947.1 Nostoc verrucosum).*/\1/" barcode11_nostoc_ashitsuki.fasta 
sed -i -r "s/(>FR798940.1 Nostoc).*/\1 from stagnant water and concrete/" barcode11_nostoc_concrete.fasta
sed -i -r "s/(>KF037277.1).*/\1 Chinese soil bacteria/" barcode11_nostoc_China.fasta 
## how do we add in our reference nostoc?
for i in barcode11*fasta; do
  cat $refNostoc $i > temp
  sed -i -r "s/(>AF027655.1).*/\1/" temp
  mv temp $i
done
sed -i -r "s/(>AF027655)\.1.*/\1_ashitsuki/" barcode11_nostoc_ashitsuki.fasta 
sed -i -r "s/(>AF027655)\.1.*/\1_China/" barcode11_nostoc_China.fasta
sed -i -r "s/(>AF027655)\.1.*/\1_concrete/" barcode11_nostoc_concrete.fasta

grep "^>" barcode11_nostoc_ashitsuki.fasta | head -5
grep "^>" barcode11_nostoc_concrete.fasta | head -5
grep "^>" barcode11_nostoc_China.fasta | head -5


## for each, do an alignment, may be useful
for i in barcode11_nostoc_ashitsuki.fasta barcode11_nostoc_concrete.fasta barcode11_nostoc_China.fasta; do
  echo $i
  muscle -in $i -out ${i/.fasta/.afa} &
done


## and combine them, just to see what this looks like:

#muscle -profile -in1 barcode11_nostoc_ashitsuki.afa -in2 barcode11_nostoc_concrete.afa -out muscleMSA_barcode11_ashitsuki_concrete.afa
#muscle -profile -in1 muscleMSA_barcode11_ashitsuki_concrete.afa -in2 barcode11_nostoc_China.fasta -out muscleMSA_barcode11_ashitsuki_concrete_China.afa 
## this fails. Why? Probably the length (columns) of the alignment being different. 
## maybe try combining the smaller read files (concrete and china) into a single alignment, 
## then combine:

## so lumping the concrete and China reads.
cat barcode11_nostoc_concrete.fasta barcode11_nostoc_China.fasta > barcode11_nostoc_concreteChina.fasta
muscle -in barcode11_nostoc_concreteChina.fasta -out barcode11_nostoc_concreteChina.afa 
muscle -profile -in1 barcode11_nostoc_ashitsuki.afa -in2 barcode11_nostoc_concreteChina.afa -out muscleMSA_barcode11_ashitsuki_concreteChina.afa
## and the reverse, let's lump the  ashitsuki and the china reads, to test the effect of order here:
cat barcode11_nostoc_ashitsuki.fasta barcode11_nostoc_China.fasta > barcode11_nostoc_ashitsukiChina.fasta
muscle -in barcode11_nostoc_ashitsukiChina.fasta -out barcode11_nostoc_ashitsukiChina.afa 
muscle -profile -in1 barcode11_nostoc_ashitsukiChina.afa -in2 barcode11_nostoc_concrete.afa -out muscleMSA_barcode11_ashitsukiChina_concrete.afa
## and one big one, of all three blast clusters:
cat barcode11_nostoc_ashitsuki.fasta barcode11_nostoc_concrete.fasta barcode11_nostoc_China.fasta > \
  barcode11_nostoc_ashitsukiConcreteChina.fasta
muscle -in barcode11_nostoc_ashitsukiConcreteChina.fasta -out barcode11_nostoc_ashitsukiConcreteChina.afa


## move these and the other alignments, to keep things organized
mv *afa /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/

## and get this local
getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/

/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11

## looking at this, the alignment is way too long. 
## found chimeric read:
ae9a27e6-1dfe-4513-b39f-997724c75732

## and maybe these ones too:
grep 53fc4d0f-e611-43ac-b382-2ca69b9c1a67 /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/*
grep 33c27d17-b529-4e46-9fe9-c82b296ca335 /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/*
## but hold onto these for a minute

## rerun the above pipeline excluding this read...

## these are cleaner alignments, let's make trees to see if we are seeing what 
## we think we are seeing.

#cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/
cd /media/vol1/daniel/nostoc/16sTree/round2/barcode11

alignDir=/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/
alignment=muscleMSA_barcode11_ashitsuki_concreteChina.afa
FastTree -gtr -nt < ${alignDir}/${alignment} > barcode11_Nostoc_ashitsuki_concreteChina.nwk
alignment=muscleMSA_barcode11_ashitsukiChina_concrete.afa
FastTree -gtr -nt < ${alignDir}/${alignment} > muscleMSA_barcode11_ashitsukiChina_concrete.nwk
alignment=barcode11_nostoc_ashitsukiConcreteChina.afa
FastTree -gtr -nt < ${alignDir}/${alignment} > muscleMSA_barcode11_ashitsukiChinaconcrete.nwk

getFile="/media/vol1/daniel/nostoc/16sTree/round2/barcode11/"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/

## they are somehow very different. There is a strong effect, it looks like whichever alignments 
## are made together tend to stay together. Maybe the "profile" tool in muscle is inappropriate here.
## I guess the last thing to try to align them all, while we work on getting a nif database,
## is to let one large align run with all reads, labeled according to their blast cluster. 

## oh god, this is a mess.  

## try SINA 1.7?

apt search SINA ## nope

## here:
https://github.com/epruesse/SINA
https://sina.readthedocs.io/en/latest/

## let's make a conda environment for this:

conda activate sina

## we need an arb-formatted DB. Can we use the cyanoseq or cydrasil databases for this?

## cyanoseq, v1.2 (v6 doesn't have the alignment on their zenodo?)

cd /media/vol1/daniel/nostoc/16sTree/cyanoSeq

wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2.fasta

## try conversion to arb format:
sina -i CyanoSeq_1.2.fasta -o CyanoSeq_1.2.arb --prealigned

## try a simple alignment:

## let's try our barcode 11 sequences. First, what happens if we give it 
## all of our nostoc sequences, not divided up by blast-matches 

## all nostoc matches from barcode11 are here:

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11

fasta="barcode11_nostoc_ashitsuki.fasta"
blastoutDir="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11"
#ls ${blastoutDir}/${fasta}
#seqtk seq -A $fastq  > $fasta
sina \
  -i ${blastoutDir}/$fasta \
  -o ${fasta/\.fasta/aligned_cyanoseq.afa} \
  --db CyanoSeq_1.2.arb &> log.txt

## tried to use the --overhang= option but appears to be broken. hanging sequences are causing 
## problems with hmmer below...manually remove them?

## lots of errors (https://github.com/epruesse/SINA/issues/110). let's see how it worked, anyway.

mv ${fasta/\.fasta/aligned_cyanoseq.afa} /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/

## on local ##
#getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_onlyNostocaligned_cyanoseq.afa"
getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_nostoc_ashitsukialigned_cyanoseq.afa"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/
cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/
## ^on local^ ##

## looks promising, let's try it with the blast-clusters, maybe just the most numerous. Modified above.
## though as mentioned, hanging sequences are causing problems. Also, the reference sequences that I "spiked-in"
## removed the hanging base that offended hmmer, and also the reference AB511947 nostoc verrucosa sequence

########## consensus sequence #########

## as far as getting a consensus sequence, maybe take an HMM approach?
## e.g. https://medium.com/@sepo7/generating-a-consensus-sequence-from-a-profile-hmms-with-hmmer-python-506ed13f26ad

alignDir="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11"
alignFile="barcode11_nostoc_ashitsukialigned_cyanoseq.afa"
hmmbuild barcode11_ashitsuki.hmm ${alignDir}/${alignFile}

## at first, received an error:
#Alignment input parse error:
#   sequence ashitsuki_c259e768 has alen 1461; expected 1460
#   while reading aligned FASTA file /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_nostoc_ashitsukialigned_cyanoseq.afa
#   at or near line 493
## manually removed this base as mentioned above

## and ask for a "plurality" type consensus:
hmmemit -c -o barcode11_nostoc_ashitsuki_16s_consensus.fasta barcode11_ashitsuki.hmm

## RNA to DNA
sed -i '/^[^>]/ y/uU/tT/' barcode11_nostoc_ashitsuki_16s_consensus.fasta 
mv barcode11_nostoc_ashitsuki_16s_consensus.fasta  /media/vol1/daniel/nostoc/consensusSequences/OGzygodon_nostoc_16s_consensus.fasta  

## make a special place for these:


## and is this our consensus seq?
## it's our best guess. There may be one or two other strains in their, by the 
## other "blast clusters", but this may also be noise from the sequencer.
## hard to say.

## so, repeat the above for our original nostoc, and barcodes 9 (if possible) and 10, 
## identify with NBC and the cyanoseq reads, hang them 
## on the cydrasil tree or the cyanoseq tree?

##### nifH #####

## we need a nifH database and maybe a tree. Maybe a good database here:
## https://www.jzehrlab.com/nifh  

## okay, what is the strategy for getting consensus seqs from our nifH consensus sequence into shape?

## I assume the same strategy, blast to a database, group the reads by their tendency to blast to 
## common matches. 

## but for that we need a database of NifH genes.    

## intriguing: https://doi.org/10.1016/j.soilbio.2023.109261
## (Hu, Wang, et al. 2024)
## "Biological nitrogen fixation and the role of soil diazotroph 
##  niche breadth in representative terrestrial ecosystems"
## they translated the nifH sequence with framebot, then blastp 
##  to a curated NifH database

## one database they used is from the NifHTool authors:

cd /media/vol1/daniel/nostoc/nifHdatabases

wget https://zenodo.org/records/5913032/files/JefferDSP/NIFTHool-v1.0.zip

unzip NIFTHool-v1.0.zip

## we just want:
mv data_NifH.csv NIFtHool.csv

## I think we need this as a fasta:

python3 

import pandas as pd
import os
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio import SeqIO

aa = pd.read_csv("NIFtHool.csv", header=None)

protSeqs = aa.iloc[:,2].apply(Seq).to_list()

listOfNifHrecords = []
for i,j in enumerate(protSeqs):
    seqi = SeqRecord(seq=protSeqs[i], id=aa.iloc[i,0], name=aa.iloc[i,1], description=aa.iloc[i,1])
    listOfNifHrecords.append(seqi)

SeqIO.write(listOfNifHrecords, "NIFtHool.faa", "fasta")

help(SeqIO.write)

## also there is this Koira & Brzel dataset, 963 NifH genes from culture genomes:

wget https://mdpi-res.com/d_attachment/microorganisms/microorganisms-09-01662/article_deploy/microorganisms-09-01662-s001.zip

unzip microorganisms-09-01662-s001.zip

mv 'Archive 2'/'Supplement Data S1 Sequences.xlsx' ./Supplement_Data_S1_Sequences.xlsx


## think nifH protein seqs are here:

python3 
import pandas as pd
import os
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio import SeqIO

aa = pd.read_excel(open('Supplement_Data_S1_Sequences.xlsx', 'rb'), sheet_name='CompleteNif')  
## can we make a fasta (FAA) out of this?
## getting down to the two columns we really need:
nifHdf = aa[['NifH', 'NifHSeq']]
protSeqs = nifHdf['NifHSeq'].apply(Seq).to_list()
## to make a big list:
listOfNifHrecords = []
for i,j in enumerate(protSeqs):
    seqi = SeqRecord(seq=protSeqs[i], id=nifHdf.iloc[i,0], description=nifHdf.iloc[i,0])
    listOfNifHrecords.append(seqi)

listOfNifHrecords[0]

## write this out as a fasta?:
SeqIO.write(listOfNifHrecords, "KoiraBroezel.faa", "fasta")

## this should work. The third source of cyanobacterial reads 
## given in this database ("Nitrogenase NifH 99.fasta")
https://bridges.monash.edu/articles/online_resource/Nitrogenase_NifH_99_fasta/13152692?backTo=/collections/_/5230745

## had to download manually, put it on nanoComp:
rsync -auv '/home/daniel/Downloads/Nitrogenase NifH 99.fasta' test@132.180.112.115:/media/vol1/daniel/nostoc/nifHdatabases/

mv 'Nitrogenase NifH 99.fasta' NitrogenaseNifH99.fasta
## this formatting seems fine

## they (Wang et. al 2022) did translating etc, 
## but I think we need a reliable consensus sequence,
## as before. so try the same old bag of tricks.

## we have nucleotide sequences to align against AA, 
## need blastx. 

cd /media/vol1/daniel/nostoc/nifHdatabases

cat KoiraBroezel.faa NIFtHool.faa NitrogenaseNifH99.fasta > allNifHdbs.faa

makeblastdb -in allNifHdbs.faa -dbtype prot

#### barcode12 NifH OG Hylocomium ####

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12

blastDB=/media/vol1/daniel/nostoc/nifHdatabases/allNifHdbs.faa
nifH12reads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode12.fastq

seqtk seq -A $nifH12reads > nifH12.fasta

blastx -db $blastDB \
  -query nifH12.fasta \
  -num_threads 10 \
  -num_alignments 5 \
  -out nifH12reads_blastmatches.txt 

blastx -db $blastDB \
  -query nifH12.fasta \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode12-nifH.csv \
  -outfmt 10 & 

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode12-nifH.csv

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os
pd.set_option('display.max_rows', None)
os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12')
nostocMatches = pd.read_csv('round2Barcode12-nifH.csv', index_col='qseqid')
nostocMatches.groupby('sseqid').count() 
aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## the most common match is to a reference sequence for Nostoc NifH, WP_069074423
## 8 matches out of 70, so not great. But we are used to this. 

## most common match
nostocMatches[nostocMatches.sseqid.str.contains("WP_069074423")]

## second is weird:
nostocMatches[nostocMatches.sseqid.str.contains("F0RY64")]
## but scores are all bad. These can be ignored, I think.

## third has some strong matches:
nostocMatches[nostocMatches.sseqid.str.contains("WP_104908765.1")]
## this accession is NifH for Lobaria pulmonaria (5183) cyanobiont

## one fairly strong match (37 AAs, bitscore 80.1) to a calothrix nifH
nostocMatches[nostocMatches.sseqid.str.contains("WP_035154649.1")]

## there are duplications here, 3 of these are listed twice. 
## the strong matches are far fewer:
nostocMatches.query('bitscore > 100 & sseqid == "WP_069074423.1"')

## anyway, let's focus on those with high bit scores 
## subset to just these:
strongMatches = nostocMatches.query('bitscore > 90')

## how to write these out...

wantedReads=strongMatches.reset_index().qseqid

rawReadsBarcode = ("/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/"
                   "OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/"
                   "2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode12.fastq")

wantedReads

wantedReads.str.match("95eb4fe6-6ee3-4a5c-9987-9d027b08b61d").any()

highBits=[]
for rec in SeqIO.parse(rawReadsBarcode, "fastq"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)


highBits

## write this out as a fasta?:
SeqIO.write(highBits, "Barcode12_NifH_reads2align.fa", "fasta")

## let's see what happens when we align these with muscle and/or sina:

muscle -in Barcode12_NifH_reads2align.fa -out Barcode12_NifH.afa

getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12/Barcode12_NifH.afa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode12/"
rsync -auv test@132.180.112.115:${getFile} $putHere

## maybe rerun the alignment with the WP_069074423 reference seq 

## note - Barcode9 re-scoped, looks like it is a gleocapsa or something messy and coccoid. No wonder the nifh didn't amplify
## and similar, OG zygodon also didn't really look "nostoc-y", though in this case I am not so confident that
## it isn't just a broken down Nostoc colony. 

## what a pain in the ass. In the meantime 
