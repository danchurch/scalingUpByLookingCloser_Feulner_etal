## let's see if we can extract the 16s sequence for this 
## cyano

## as always, make a repo:

git clone https://github.com/danchurch/nanoporeNostoc16sAlignments.git
git config --global user.email "danchurchthomas@gmail.com"
git config --global user.name "danchurch"
git remote set-url origin git@github.com:danchurch/nanoporeNostoc16sAlignments.git


## from one of our colony PCRs:

scp test@132.180.112.115:/media/vol1/daniel/nostoc/FAX46654_pass_7c69c392_f65555ec_0.fastq .

## we want a database that contains all public 16s cyanobacteria to blast against. 

## then make some sort of consensus sequence to report. As a preliminary result. 

## downloaded the silva sequences for cyanobacteria 16s
## we should use this to blast against, to find our possible cyano reads

## go looking for the symbionts after that. 

## for the cyano reads - 
## silva cyano reads are here:

cd /media/vol1/daniel/nostoc/cyanoRef16s

tar -xzvf arb-silva.de_2023-11-22_id1287436.tgz

## that's rna, U's instead of T's. Does blast have a problem with this?

## our raw read folder is here:

rawReadDir=/var/lib/minknow/data/lowPoresNostoc/Nostoc2/20231121_1424_MN40608_FAX46654_7c69c392/fastq_pass

cp $rawReadDir 

## copied to 
/media/vol1/daniel/nostoc/minionReadsNostoc

## combine them:

gunzip *
cat * > allNostoc2.fastq

## to fasta
seqtk seq -A allNostoc2.fastq > allNostoc2.fasta

## can we clean up the headers?

head -n 10 allNostoc2.fasta | sed "s/runid=.*$//" ## seems to work

sed -i "s/runid=.*$//" allNostoc2.fasta

## great. we need a blastable database
## silva gives rna, not DNA, is this a problem?


makeblastdb -in arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta -parse_seqids -dbtype nucl 

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta
minionReads=/media/vol1/daniel/nostoc/minionReadsNostoc/allNostoc2.fasta

blastn -db $cyanoDB \
  -query $minionReads \
  -num_threads 10 \
  -num_alignments 1 \
  -out minion2cyanoMatches.csv \
  -outfmt 10 &

## ugh, the headers are weird:

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta

## some weird things in there. For instance, why is this in our cyano database? gammaproteo

cd /media/vol1/daniel/nostoc/blastout

grep -c "Proteobacteria" $cyanoDB 

grep "Proteobacteria" $cyanoDB ## prochlorothrix, but misassigned

grep "EF174233.1.1481" $cyanoDB

## looks like a pseudomonas mislabeled as a cyano in the silva database

grep ">" /media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta | less

## ugh. more curation is needed. Get rid of all chloroplast sequences. 
## modify headers so that genus is included in the blast results
## etc, etc. 

## blast results:

blRes=/media/vol1/daniel/nostoc/minionReadsNostoc/minion2cyanoMatches.csv

grep "EF174233.1.1481" $cyanoDB

grep "EF174233.1.1481" $blRes

## so we need to rerun the blast without chloroplast sequences in the ref db,
## or exclude any non-cyano (contaminants, chloroplasts) using
## the taxonomy in the headers of our reference sequence
## change the headers to include the taxonomy. 

## to clean up the database a bit:

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta

head $cyanoDB 

head $cyanoDB | sed "s/ /_/g"

## what can we use as a connector...

grep "_" $cyanoDB ## nope
grep "=" $cyanoDB ## nope
grep "+" $cyanoDB ## that works, only one of those, in a chloroplast sequence.

## speaking of, how do we get rid of the chloroplast reads?

grep -i "Chloroplast" $cyanoDB 

grep -i "Chloroplast" $cyanoDB | grep "chloroplast"

## get rid of line breaks 
seqtk seq -l 0 $cyanoDB > silvaCyanosNoLB.fasta

grep -ci "Chloroplast" silvaCyanosNoLB.fasta ## 75,997 sequences are chloroplasts

grep -iV "Chloroplast" silvaCyanosNoLB.fasta

head -n 100 silvaCyanosNoLB.fasta | grep -iv "Chloroplast" 

grep -v "Chloroplast" silvaCyanosNoLB.fasta

grep -iA 1 "Chloroplast" silvaCyanosNoLB.fasta

## ugh, need to go to python

import pandas as pd
from Bio import SeqIO
import os

## get our silva cyano database in there:

os.chdir("/media/vol1/daniel/nostoc/cyanoRef16s")

silvaCyanos="arb-silva.de_2023-11-22_id1287436_tax_silva_trunc.fasta"

notChloros=[]
for rec in SeqIO.parse(silvaCyanos, "fasta"):
    print(rec.id)
    if "hloroplast" not in rec.description and "Cyanobacteria" in rec.description: 
        print ("yep!!!")
        print (rec.description)
        notChloros.append(rec)

## check it:
for i,j in enumerate(notChloros):
    print(i)
    print(j)

len(notChloros) ##103898 records. Should not be anything but real cyanos, no chloroplasts.

## write out
SeqIO.write(notChloros, "silvaCyanos.fasta", "fasta")

## back in the shell
## we still want to reformat, to keep the phylo info in our 
## blast csv:

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta

grep -c "+" $cyanoDB ## 0

## change out headers, get rid of first space: 
sed "s/ /;/" -i silvaCyanos.fasta

grep -c "Chloroplast" $cyanoDB ## 0


less silvaCyanos.fasta

## looks okay. make db and try again:
makeblastdb -in silvaCyanos.fasta -dbtype nucl 

cd /media/vol1/daniel/nostoc/blastout
cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta
minionReads=/media/vol1/daniel/nostoc/minionReadsNostoc/allNostoc2.fasta
nohup blastn -db $cyanoDB \
  -query $minionReads \
  -num_threads 10 \
  -num_alignments 1 \
  -out minion2cyanoMatches.csv \
  -outfmt 10 &

cd /media/vol1/daniel/nostoc/blastout

less minion2cyanoMatches.csv

wc -l minion2cyanoMatches.csv ## 35220 hits, out of 

grep -c "^>"  $minionReads ## 40,000

grep -c "Nostocaceae" minion2cyanoMatches.csv ## 11340

grep -c "Nostoc" minion2cyanoMatches.csv ## 11340 

grep -c "Nostocaceae;Nostoc" minion2cyanoMatches.csv ## 9928
grep -c ";Nostoc," minion2cyanoMatches.csv ## 9940 weird, why more? formatting I guess

## interesting. what to do from here:
## fastqc, nanoqc
## 
## check relative abundances - is nostoc really the most 
## common thing here?
## Take out the nostoc sequences, 
## find some consensus sequences, put them on a 16s tree. 
## how many "different" nostocs are there?
## figure out if it something new
## that's a bit of work.
## that should be preliminary data for some kind of grant. 
## but we do need to get some kind of consensus here. 
## maybe pull out all nostoc hits and run an alignment... 
## but there are lots...

## we have a two step project here 
## 1 - get some consensus sequences - vsearch
## 2 - place these on a tree, probably the tree from 
##     these folks: https://github.com/FGPLab/cydrasil

## start by getting some representative sequences

## let's pull out all reads that blasted to 16s nostoc sequences

cd /media/vol1/daniel/nostoc/blastout 

grep "Nostocaceae;Nostoc" minion2cyanoMatches.csv > nostocMatches.csv
cut -f1 -d, nostocMatches.csv > nostocReads.txt

nostocReads="/media/vol1/daniel/nostoc/blastout/nostocReads.txt"
allReads="/media/vol1/daniel/nostoc/minionReadsNostoc/allNostoc2.fastq"
## use seqtk to keep only the matches to nostoc
seqtk subseq $allReads $nostocReads > onlyNostoc.fastq

grep -c "runid=" onlyNostoc.fastq ##9928, looks good

## how do these look?

fastqc -t 10 -o fastqcOut onlyNostoc.fastq
 
scp -r test@132.180.112.115:/media/vol1/daniel/nostoc/minionReadsNostoc/fastqcOut .


## yeah, let's cut the adapters, other stuff 


## first basepairs are really low quality. Not sure
## how long the adapters are...
## can we find our primers in there? the sequences are:

## 16S-27F:
grep AG.GTTTGAT..TGGCTCAG onlyNostoc.fastq ## 20 bp

## a random sample of reads before this:
TGTGCATACTGGATCAGTTACGTATTGCT
TGCTATGTGCTCTACTGGTACAGTTAGCGTATTGCT
TGGCATCTACTGGTTAGACTTGGTCTTGCT
ATGTAGCCTTGGTTCAGAGTACGTATTGCT
TGTGTCACCTGGTTCGAGTTTACGTATTGCT

## 16S-1492R

grep TACCTTGTTA.GACTT onlyNostoc.fastq ## 16 bp

## a random sample of reads before this:
ATGTCTACCTTGGTTCAGAGTACGTATTGCT
TATGTGTACGTCCTACTTGGTTCCGTTGCGTATTGCT
ATGTTTTGCATCTACTGGTTGGTTGGTATTGCT
TGCCATGCTTGGTTCAGTACGTATTGCT


## so it looks like the adaptors are 30-40 bp,
## and the primers are 16-20bp 
## I think this means, to be safe, that 
## we should chop the first 60 reads.
## and allow the maximum reads after that to 
## be ~1600 bp:

cd /media/vol1/daniel/nostoc/minionReadsNostoc

#seqtk trimfq -L80 onlyNostoc.fastq > test.fastq
seqtk trimfq -b60 -L1600  onlyNostoc.fastq > onlyNostTrimmed.fastq

rm fastqcOut/*
fastqc -t 10 -o fastqcOut onlyNostoc.fastq
fastqc -t 10 -o fastqcOut test.fastq
fastqc -t 10 -o fastqcOut onlyNostTrimmed.fastq

## on local, to look at this:
rm -r fastqcOut/ &&
scp -r test@132.180.112.115:/media/vol1/daniel/nostoc/minionReadsNostoc/fastqcOut . &&
firefox fastqcOut/*html

## that's starting to look right. 
## now, get some otus out of this?

cd /media/vol1/daniel/nostoc/clustering

fastaF=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostoc.fastq
vsearch \
  --cluster_size $fastaF \
  --id 0.90 \
  --relabel otu \
  --sizein \
  --sizeout \
  --fasta_width 0 \
  --strand both \
  --consout "nostocConsensusSeqs.fasta" \
  --threads 10 \
  --otutabout "nostocClusterTable.csv"

## that fails horribly. at id=0.97 or 0.90 we still have 
## about the same number of OTUs as reads. 
## the exceptions are not recognizeable as cyanos 
## anymore.

## weird.

## try nanoclust
## tried nanoclust. installation was a nightmare, 
## had to hand modify scripts, install a thousand
## dependencies even though it was in conda
## then it didn't work anyway because the reads weren't abundant
## enough for the algorithm.

## new approach, we have our blast results,
## let's sort them by abundance, and assume 
## the things that blast to the same thing are
## the same same thing

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' nostocMatches.csv

python3 

import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.chdir('/media/vol1/daniel/nostoc/blastout/')

nostocMatches = pd.read_csv('/media/vol1/daniel/nostoc/blastout/nostocMatches.csv', index_col='qseqid')
## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

nostocMatches.groupby('sseqid').count()

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()

bb = aa.T.iloc[0,:].sort_values(ascending=False)

## the vast majority (7805 out of 9928) have blasted to
## JN847344.1.1541

## accession number JN847344

## this is from a lichen associated cyanobacteria, from Leptogium
## from oregon

## what is our mean percent % similarity and length of match?


nostocMatches.head()

leptoMatches=nostocMatches[nostocMatches['sseqid']=='JN847344.1.1541']

## second most common (285 out of 9928) match is to a hornwort-associated nostoc:
hornMatches=nostocMatches[nostocMatches['sseqid']=='CP001037.5515629.5517117']

leptoMatches.head()
leptoMatches.tail()

leptoMatches[['pident', 'length']].mean() ## on average, 86% match

nostocMatches[['sseqid', 'pident', 'length','evalue']].groupby('sseqid').mean()

aa = nostocMatches[['sseqid', 'pident', 'length']].groupby('sseqid')

hornMatches[['pident', 'length']].mean() ## on average, 86% match also.

nostocMatches[['sseqid','pident']].groupby('sseqid').count()

## so now we have two problems:

## 1 - we need a consensus sequence for our nostoc
## 2 - we need a tree to put it in.

##### placement on tree ########

## let's see if we can get our consensus seqs,
## the tree from Cydarasil3 (https://github.com/FGPLab/cydrasil)
## we'll try pplacer (http://matsen.github.io/pplacer/generated_rst/pplacer.html)
## also using taxtastic (https://fhcrc.github.io/taxtastic/quickstart.html)

## pplacer needs:

conda create -n pplacer -c bioconda pplacer
conda activate pplacer
conda install -c bioconda taxtastic

## make the reference package:

taxit create -l 16s_rRNA -P my.refpkg \
    --aln-fasta seqs.fasta \
    --tree-stats tree_stats.txt \
    --tree-file tree.nwk

seqsfasta=
tree_stats=
tree=
taxit create -l 16s_rRNA -P my.refpkg \
    --aln-fasta $seqsfasta \
    --tree-stats $tree_stats \
    --tree-file $tree

## ugh, cydrasil doesn't have all the files
## needed for pplacer. Try SSU-align/EPA-ng pipeline that cydrasil
## recommends:

conda create -n cydrasil -c bioconda ssu-align epa-ng

conda activate cydrasil

/media/vol1/daniel/nostoc/16sTree/cydrasil_repo

consenSeqs=/media/vol1/daniel/nostoc/clustering/nostocConsensusSeqs.fasta
ssuAlignMask=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/cydrasil-v3-ssu-align.bacteria.mask

ssu-align $consenSeqs aln
ssu-mask -s $ssuAlignMask aln

ssu-align query-seqs.fasta output-directory-name

## let's put that on hold for a moment...

####### get consensus sequence for nostoc sp ####

## problem two is to get a consensus 16s sequence from
## our nanopore sequencing effort

## we think we have a new nostoc species that is 
## associated with the hylocomium. Let's see.

## we are down to maybe 10,000 sequences that 
## are probably nostoc. 
## Let's assume these are what we are looking for.

## for a 16S tree, this is maybe feasible. 
## let's try ssu-align

nostoc 

conda activate cydrasil

## convert trimmed nostoc to fasta
cd /media/vol1/daniel/nostoc/minionReadsNostoc

seqtk seq -A onlyNostTrimmed.fastq > onlyNostTrimmed.fasta
sed -i "s/runid=.*$//" onlyNostTrimmed.fasta

cd /media/vol1/daniel/nostoc/ourNostocMSA
nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fasta
ssu-align -f $nostocReads msaNostoc

## repeated read names...how can this be...
grep "de18da17-28ad-4b14-8440-f70e40d5dbe3" $nostocReads

## are there others?:

sed -n "/>/p" $nostocReads | sort | uniq -d ## 841! what is going on??

## look at one set:

grep -A1 "de18da17-28ad-4b14-8440-f70e40d5dbe3" $nostocReads

## those look identical...make sure

readName="de18da17-28ad-4b14-8440-f70e40d5dbe3"
grep -A1 $readName $nostocReads > twoReads.txt
diff <(sed -n "2"p twoReads.txt) <(sed -n "4"p twoReads.txt)

## are other reads identical?

sed -n "/>/p" $nostocReads | sort | uniq -d > dupedReads

for readName in $(cat dupedReads); do
  grep -A1 $readName $nostocReads > twoReads.txt
  diff <(sed -n "2"p twoReads.txt) <(sed -n "4"p twoReads.txt)
done

## yeah, those are exact dups. 

## is all the metadata the same? for instance

nostocFastq=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fastq

readName="de18da17-28ad-4b14-8440-f70e40d5dbe3"
grep -A1 $readName $nostocFastq > twoReads.txt
#grep -A1 $readName $nostocReads > twoReads.txt

diff <(sed -n "1"p twoReads.txt) <(sed -n "4"p twoReads.txt)

## not sure where they occurred or why? hope that's not a 
## a problem...hopefully just another quirk of nanopore.

## for the moment, can we remove duplicates?

## use seqkit?

conda deactivate 
conda activate seqkit

cd /media/vol1/daniel/nostoc/minionReadsNostoc/

seqkit rmdup < onlyNostTrimmed.fasta > onlyNostTrimmed_dedup.fasta

## found 1019 duplicated sequences!! whoah, weird.
## now try again with ssu

conda deactivate 

conda activate cydrasil

cd /media/vol1/daniel/nostoc/ourNostocMSA

nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta
nohup ssu-align -f $nostocReads msaNostoc &

mv nohup.out nohup.align.out

## mask the low-confidence columns

nohup ssu-mask msaNostoc &

## SSU-ALIGN masking shows that we have a lot of 
## low confidence columns...it really only trusts
## 140 columns...ugh nanopore

## how do we view these two alignments (masked/non)
## and get a consensus out of them?

conda deactivate

conda create -n jalview -c bioconda jalview

conda activate jalview

## neither of these are useful. The raw unmasked one has 10,000 columns,
## with supposedly high-confidence columns scattered throughout. 

## the masked one blasts to nothing. 

## let's try muscle:


cd /media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign

noFasta=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fasta
nohup muscle -in $noFasta -out nostoc16sAlignment.fa  &

\time muscle -in $noFasta -out nostoc16sAlignment.fa

## think that will run for some time....

## and died. Not enough ram?

13796344

13,796,344 ## that's not that much...hmmm

## as per here: http://www.drive5.com/muscle/muscle.html#_Toc81224829

noFasta=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed.fasta
nohup muscle -in $noFasta -out nostoc16sAlignment.fa -maxiters 2 -diags1 -sv &

file2get="/media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign/nostoc16sAlignment.fa"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/idColonies"
scp -r test@132.180.112.115:$file2get $putHere

## look at it with aliview:

wget http://ormbunkar.se/aliview/downloads/linux/linux-version-1.28/aliview.install.run

gtctcgtgggctcggagatgtgtataagagacagggactacnvgggtwtctaat

## ugh. so the question remains, if these sequences are so 
## un-alignable, how did blast perfom so well? 

## let's rerun the blast search with verbose results, with alignments,
## might give us a clue as to what is going on.

## our dedupped data is here on the lab computer, back it up on github
file2get="/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/data/"
scp -r test@132.180.112.115:$file2get $putHere

## also the reference fasta we made, of cleaned up silva cyanobacterial accessions:
file2get="/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/refDatabases/"
scp -r test@132.180.112.115:$file2get $putHere
## and gzip it because too big

## anyway, move over to lab comp to let things run

cd /media/vol1/daniel/nostoc/minionReadsNostoc

nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta

cd /media/vol1/daniel/nostoc/blastout

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta
nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta
nohup blastn -db $cyanoDB \
  -query $nostocReads \
  -num_threads 10 \
  -num_alignments 1 \
  -out minion2cyanoMatchesVerbose.txt &

## the previous most common hit is still the most common:

grep -c  ">JN847344.1.1541" minion2cyanoMatchesVerbose.txt ## ____ out of

grep -c "Query=" minion2cyanoMatchesVerbose.txt ## ____


## don't know why we didn't notice this before, but this match is 
## also common:

grep -c KF359696.1.1469 minion2cyanoMatchesVerbose.txt 

grep -c ">KF359696.1.1469" minion2cyanoMatchesVerbose.txt ## but never first hit, hmmm

## 1557 hits, usually following the JN8 accession with an equal e/bit score
## what is this?

## it is also a leptogium symbiont. 

## so what do we do with this?

## is this the same file as used above by the ssh aligner and muscle?
## essentially. 
## so why did the alignments fail so badly?

## get new version of muscle:

wget https://github.com/rcedgar/muscle/releases/download/5.1.0/muscle5.1.linux_intel64

sudo ln -s muscle5.1.linux_intel64 muscle5

cd /media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign
nostocReads=/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta
nohup muscle5 -super5 $nostocReads -output nostoc16sAlignment.fa &> nostoc16sAlignment.log &

cd /media/vol1/daniel/nostoc/



## maybe try subsetting. subset to the very highest matches, to the same  

cd /media/vol1/daniel/nostoc/blastout

grep "JN847344.1.1541" nostocMatches.csv > leptoNostocBlastMatches.csv 

cut -d, -f3 leptoNostocBlastMatches.csv 

wc -l  nostocMatches.csv

## this looks like it is still failing. 
## don't understand. In the blast matches, these all look similar, 
## at a glance:

grep -c "^>" /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt ## pretty much all leptogium nostoc seqs covered

less /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt 

grep "|||" -A 1 -B 1 /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
less

grep "Plus/Plus" -A 4 /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
less

## there are reads in both directions, but I assume muscle can handle this

## different approach: pick out a subset, ~100 reads. 
## how do we know to which ones are the good ones?

## read into python, pick out the top ones according to escore or bits, with 
## strict minimums, maybe direction (strand = Plus/Plus)?

## or another simple test - look for strict matches to a sequence from the ref
## take all the ones that match this, they should mostly be in the same direction
## and pretty high quality:


## eg this sequence, which occurs in the middle, somewhere around 1050 bp:

less /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt 

grep  "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
grep  "AAACCGGAGGAAGGTGG" 

grep "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/minion2cyanoMatchesVerbose.txt |
grep -c "AAACCGGAGGAAGGTGG" 

## still 377 sequences


## to pull these out of our nostoc sequences:

cd /media/vol1/daniel/nostoc/minionReadsNostoc

grep -c "AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta 
## only 529, not sure if this is intellectually satisfying...try it

python3 

import pandas as pd
from Bio import SeqIO
from Bio import AlignIO

import matplotlib.pyplot as plt; plt.ion()
import os
import re

nostocReads = "/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta"
patt = re.compile("AAACCGGAGGAAGGTGG")

## find all sequences with a strict match to this 

patt = re.compile("AAACCGGAGGAAGGTGG")
a=0
strictMatches = []
for values in SeqIO.parse(nostocReads, "fasta"):
    if patt.findall(str(values.seq)) and len(values.seq) > 1000  :
        a+=1
        print(values.id)
        patt.findall(str(values.seq)) 
        strictMatches.append(values)

print(a) ## 632 matches

SeqIO.write(strictMatches, "leptogium_subsetStrict.fasta", "fasta")

## try our multiple alignment with this instead
## back in shell:

cd /media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign

lepFasta=/media/vol1/daniel/nostoc/minionReadsNostoc/leptogium_subsetStrict.fasta
nohup muscle5 -super5 $lepFasta -output lepNost16sAlignment.fa &> lepNost16sAlignment.log &

## let that run tonight. 
## the smaller one (lepto only) is available 

#wget http://ormbunkar.se/aliview/downloads/linux/linux-version-1.28/aliview.install.run

## doesn't look great.

## I do not know if this is shit data, or diverse data

## I think we have to manually curate 

## use eugene?
wget https://github.com/ugeneunipro/ugene/releases/download/50.0/ugene-50.0-linux-x86-64.tar.gz
tar -xf ugene-50.0-linux-x86-64.tar.gz

## on local:

file2get="/media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign/lepNost16sAlignment.fa"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/msa/lepNost16sAlignment_original.fa"
scp -r test@132.180.112.115:$file2get $putHere

## to get it on the office comp:
file2get="/media/vol1/daniel/nostoc/ourNostocMSA/muscleAlign/lepNost16sAlignment.fa"
putHere="/media/vol/nostocBigFiles/"
scp -r test@132.180.112.115:$file2get $putHere

cd /home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/msa

/home/daniel/ugene-50.0/ugene -ui &

## then hand curation in ugene:
##  1. deleted first 470 bp or so, these were only found in our fourth read, chimeric
##  2. deleted any columns that consisted of 95% gaps or more. This brought the majority
##     of sequence lengths to ~1485 bp, approximately the expected length for 16s
##  3. So trimmed off ends after 1485
##  4. did an addition filter of removing any column with 60% or more missing bps  
##  5. that rep sequence was exported, then entered into the alignment, and any site that 
##     showed 20% for at least two BP is relabeled as "N", in a separate file

## the consensus sequence is upper/lower case based on quality:
aa=$(cat leptoNostoc_draftConsensus.txt)
echo ">leptoNostoc_draftConsensus" > leptoNostoc_draftConsensus.fasta
echo ${aa^^} >> leptoNostoc_draftConsensus.fasta
#rm leptoNostoc_draftConsensus.txt
cat leptoNostoc_draftConsensus.fasta

## how does this blast?
## without Ns, still best blast is the leptogium symbiont:
## KF359696.1, PID 98.24, eval=0.0, bitscore 2471

## with Ns, still best blast is the leptogium symbiont. Match scores lower, makes sense

## we can try putting both on a 16s tree of cyanobacteria


##### repeat consensus seq pipeline from 2025 #####

## timemachine, it's now 2025. I developed a pipeline
## for getting consensus sequences from other nostocs
## from tagmented, multiplexed barcoded nanopore 
## data. It may be useful here, let's see if we can
## repeat it here and see if it gives us the same 
## results.
## refer to line 1827 or so below

## where should we start? Need the sequence data,
## hopefully without the adapters, linkers, primers
## etc.:

## if we believe our scripts from 3 years ago,
## the nostoc-like sequences with nanopore adapters
## and 16s primers removed, and deduplicated, should be here:

ls /media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta

less /media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta

grep -c ">" /media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta

## this is much bigger data than before, 9,000 seqs
## compared to hundreds. These have already been shown
## to blast to nostoc. Does that mean we should be able
## to skip to the alignment?

## basically following from line 1878 below

## new directory for this work, to make things more 
## confusing:

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo

## our blast results for these reads, not de-dupped, are here:

less /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/nostocMatches.csv

## go into python to get high-scoring matches:

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os, re
import numpy as np
import pickle

#pd.set_option('display.max_rows', None)
#pd.set_option('display.max_rows', 20)

os.getcwd()

nostocMatches = pd.read_csv('/media/vol1/daniel/nostoc/blastout/round1_Hylocomium/nostocMatches.csv', index_col='qseqid')

## just checking, are the duplicates detectable in the read names?:
nostocMatches.index.duplicated().any()
help(nostocMatches.index.duplicated) ## yup, read names re-used. Not sure. This 
dups = nostocMatches.index.duplicated(keep=False)
nostocMatches[dups] ## seems like every dup has a good and a poor match. Not sure why. Anyway, makes it easier to pick.

nostocMatches['sseqid'].to_list()

## all of these should have been id'd to nostoc, let's check:
nostocMatches['sseqid'].str.split(';', expand=True)[[6]] == "Nostoc"

(nostocMatches['sseqid'].str.split(';', expand=True)[[6]] == "Nostoc").all() ## yup

## so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]


aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

cc.tail(20)

minBitscore = 600
dd = (nostocMatches.query(f"bitscore > {minBitscore}")[['sseqid','evalue']]
            .groupby('sseqid')
            .count()
            .T.iloc[0,:]
            .sort_values(ascending=True))

## we lose some matches, but not a lot.
## our previous approach was to select reads by 
## taking the most common blast matches:
#nAccesions = 4
#bestAccessions = dd.iloc[-nAccesions:].index.to_list()
#bestAccessionsRegex = re.compile("|".join(bestAccessions))
#nostocMatchesBestAccessions = (nostocMatches[nostocMatches['sseqid']
#                                        .str.contains(bestAccessionsRegex)]
#                                        .query(f"bitscore > {minBitscore}"))
#
## but maybe it is better to just enforce a bitscore minimum:

nostocMatches.query(f"bitscore > {minBitscore}")

plt.hist(np.histogram( nostocMatches['bitscore'].to_numpy(), bins=20))
## this always fails. not sure why. Try it locally:

pklFile = open('ogHyloNostoc16sBitscores.pkl', 'ab')
pickle.dump(nostocMatches['bitscore'], pklFile)
pklFile.close()



## local:
getFile='/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/ogHyloNostoc16sBitscores.pkl'
putItHere='/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/'
rsync -auv test@132.180.112.115:$getFile $putItHere

python3

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt; plt.ion()
import os, pickle

pklfile = open('ogHyloNostoc16sBitscores.pkl', 'rb')    
bitscores = pickle.load(pklfile)

bitscores.plot

bitscores.plot.hist()

## this shows a bimodal distribution, a body of low 
## quality matches centered around 400, and much
## larger set of matches centered around 1600. 
## I'm betting this a function of read length,
## basically.
## 1000 seems to be a good cutoff to keep the "cream"
## let's start with that.

## back on nanoComp:

minBitscore = 600
nostocMatches.query(f"bitscore > {minBitscore}").shape ## we still have 8000+ reads, enough to keep us busy.
nostocMatchesBestAccessions = nostocMatches.query(f"bitscore > {minBitscore}")

nostocMatchesBestAccessions['bitscore'].mean() ## mean 1549


wantedReads = nostocMatchesBestAccessions.index.to_series()

rawReads = "/media/vol1/daniel/nostoc/minionReadsNostoc/onlyNostTrimmed_dedup.fasta"
os.path.exists(rawReads)

highBits=[] 
for rec in SeqIO.parse(rawReads, "fasta"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)

len(highBits)

SeqIO.write(highBits, "ogHylo_strongNostocMatches.fa", "fasta")

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo

## get this local, 
getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/ogHylo_strongNostocMatches.fa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv test@132.180.112.115:${getFile} $putHere

##then onto optiplex:
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylo_strongNostocMatches.fa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo"
rsync -auv $getFile daniel@132.180.113.114:$putHere

optiplex

cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo

## we also need some sort of database, is silva somewhere?

silvaDB=/home/daniel/Documents/databases/silva/silva_nr99_v138.2_toGenus_trainset.fa

## now, run the alignment. Very large, so reuse tricks from above (line ~590),
## and run on the optiplex

## do we have vsearch on the optiplex?

silvaDB=/home/daniel/Documents/databases/silva/silva_nr99_v138.2_toGenus_trainset.fa
vsearch \
   --orient ogHylo_strongNostocMatches.fa \
   --db $silvaDB \
   --fastaout  ogHylo_strongNostocMatches_oriented.fa \
   --notmatched ogHylo_strongNostocMatches_NotOriented.fa 

## first try this:
nohup muscle -align ogHylo_strongNostocMatches_oriented.fa -output ogHylo_strongNostocMatches.afa & 
## 8250 reads, lost 249 reads, about 40% reversed reads corrected.
grep -c "^>" ogHylo_strongNostocMatches_oriented.fa 

## muscle alignment
nohup muscle -super5 ogHylo_strongNostocMatches_oriented.fa -output ogHylo_strongNostocMatches_oriented.afa &
## started 10am Sept 26, PID = 1599960
## done eight days later. Jeez. But didn't core dump. Bravo muscle5. 

## it's too big for git, but back it up locally
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylo_strongNostocMatches_oriented.afa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv daniel@132.180.113.114:$getFile $putHere

## also need the oriented reads everywhere, btw:
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylo_strongNostocMatches_oriented.fa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv daniel@132.180.113.114:$getFile $putHere

getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylo_strongNostocMatches_oriented.fa"
putHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/"
rsync -auv $getFile test@132.180.112.115:$putHere

## back on optiplex:

cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo

## too big to view?
ugene -ui ogHylo_strongNostocMatches_oriented.afa & ## yup

## use lighter weight viewer on the optiplex
jalview ogHylo_strongNostocMatches_oriented.afa
## there are some massive "insertions". The total alignment is 23,000 bp long

## try CIAlign again, on the optiplex

conda create -n cialign -c bioconda cialign


conda activate cialign

CIAlign --infile ogHylo_strongNostocMatches_oriented.afa \
        --outfile_stem ogHylo_strongNostocMatches_oriented_msaEdits \
        --insertion_min_perc 0.2 \
        --insertion_min_flank 1 \
        --insertion_min_size 1 \
        --insertion_max_size 600 \
        --remove_insertions 

## this one is causing a large insertion in the first half of the alignment:
grep -A1 "18adeac" ogHylo_strongNostocMatches_oriented_msaEdits_cleaned.fasta

## and this one is driving the rest of the MSA downstream, doesn't really
grep -A2 "55c5bbb" ogHylo_strongNostocMatches_oriented_msaEdits_cleaned.fasta

## remove these?
## may cause problems manually changing things, but let's see

sed '/>18adeac/,+1d' ogHylo_strongNostocMatches_oriented_msaEdits_cleaned.fasta  | 
sed '/>55c5bbb/,+1d' > ogHylo_strongNostocMatches_oriented_msaEdits_cleaned_divRemoved.fasta  

## search these using the reads before and after:
234d1347-0d78-46ca-96dd-d160c540e6ab
886dfb2b-d738-4bf6-b374-2f7da7ecdfe3

e1a4e9c0-510f-419a-9db1-5a639fc98817
9e0feb88-78d6-4c13-bbfa-a4c11d780dc8

less ogHylo_strongNostocMatches_oriented_msaEdits_cleaned_divRemoved.fasta  
less ogHylo_strongNostocMatches_oriented_msaEdits_cleaned.fasta

## looks fine. can CIalign repair the alignment, get rid of what should 
## now be a lot of empty columns?:

CIAlign --infile ogHylo_strongNostocMatches_oriented_msaEdits_cleaned_divRemoved.fasta \
        --outfile_stem ogHylo_strongNostocMatches_oriented_msaEdits_divRemoved_repair 

## works

## also did some hand editing with jalviewer, for removing ends, a
## stubborn insertion that for some reason CIAlign couldn't
## pick up.

## can we build a tree with this? 

getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylocomium16sAlignment_handEdits.fa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv daniel@132.180.113.114:$getFile $putHere

## put on the nanoComp:

mv ogHylocomium16sAlignment_handEdits.fa ogHylocomium16sAlignment_handEdits.afa

#getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylo_strongNostocMatches_oriented.afa"
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/ogHylocomium16sAlignment_handEdits.afa"
putHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/"
rsync -auv ${getFile} test@132.180.112.115:$putHere

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/

## make a tree, see if there are obvious, non-random groups: 

alignment="ogHylocomium16sAlignment_handEdits.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk} 
## ~7 minutes

## look at it all with arb:

arb 

## mostly one clade, but ~500 reads that appear to 
## form a second clade:

cut -d"/" -f1  OGhylo_clade1.nds > OGhylo_clade1_reads.txt
cut -d"/" -f1  OGhylo_clade2.nds > OGhylo_clade2_reads.txt

## get the alignment running on this, it will probably at least have to 
## run overnight for clade1:

#getReads="OGhylo_clade1_reads.txt"
getReads="OGhylo_clade2_reads.txt"
allReads="ogHylo_strongNostocMatches_oriented.fa"
## use seqtk to keep only the matches to nostoc
seqtk subseq $allReads $getReads > ${getReads/_reads\.txt/\.fa}


## and run new alignments on these.
## the big one (clade1) we run on optiplex:

getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/OGhylo_clade?.fa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv test@132.180.112.115:$getFile $putHere

getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/OGhylo_clade?.fa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo"
rsync -auv $getFile daniel@132.180.113.114:$putHere

cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo

## on optiplex:
fasta="OGhylo_clade1.fa"
nohup muscle -super5 $fasta -output ${fasta/\.fa/\.afa} &
## start oct6 14:00, PID 3912172

## that ran for forever, nine days or so. 

## On optiplex it is here:
ls /home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/OGhylo_clade1.afa
## backed up on desktop here:

getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/OGhylo_clade1.afa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv daniel@132.180.113.114:$getFile $putHere

ls /home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo

## the smaller can probably run on the nanoComp: 
cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/

fasta="OGhylo_clade2.fa"
muscle5 -align $fasta -output ${fasta/\.fa/\.afa}
## started 9:29, and looks like it will run for a long time. 

## the larger alignment is still running, as expected 

## let's start on the framework for updating this 
## incredibly, the first clade is still  being aligned.

## clade2 was many fewer reads, start with that:

## the file is here on the nanoComp

ls /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/OGhylo_clade2.afa


## backed up?

find . -type f -name OGhylo_clade2.afa -exec ls -hl {} \; ## yes esprimo, no on optiplex, two copies on nanoComp

## are they the same?
diff -s ./nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/OGhylo_clade2.afa ./nostoc/nanoporeNostoc16sAlignments_repo/16sTree/alignments/OGhylo/OGhylo_clade2.afa 
## yup

## btw, clade1...

find . -type f -name OGhylo_clade1.afa  ## not on nanoComp, yes on optiplex, yes on esprimo

## we need a consensus seq for both OGhylo clade1 and 2. 

## get clade1.afa backed up onto nanoComp:

##  move esprimo copy to nanocomp:
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/OGhylo_clade1.afa"
putHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/"
rsync -auv $getFile test@132.180.112.115:$putHere

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/

## so now what? need to curate these. Start with the big one. 

## back on optiplex:

cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo

conda activate cialign

CIAlign --infile OGhylo_clade1.afa \
        --outfile_stem OGhylo_clade1.afa_msaEdits \
        --insertion_min_perc 0.2 \
        --insertion_min_flank 1 \
        --insertion_min_size 1 \
        --insertion_max_size 600 \
        --remove_insertions 

## did that help?
## yes, plus some manual edits with jalviewer
## distribute:

getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/OGhylo_clade1.afa_msaEdits_cleaned.fasta"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/"
rsync -auv daniel@132.180.113.114:$getFile $putHere

## onto nanoComp
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsOGhyloRedo/OGhylo_clade1.afa_msaEdits_cleaned.fasta"
putHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/"
rsync -auv $getFile test@132.180.112.115:$putHere

## make our consensus seq:

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/

## name got mangled...
mv OGhylo_clade1.afa_msaEdits_cleaned.fasta OGhylo_clade1_msaEdits_cleaned.afa

alignFile="OGhylo_clade1_msaEdits_cleaned.afa"
finalFileName="Hylocomium_nostoc_OGredo_16s.fa"
hmmbuild ${alignFile/_msaEdits_cleaned\.afa/\.hmm} ${alignFile}
hmmemit -c -o $finalFileName ${alignFile/_msaEdits_cleaned\.afa/\.hmm}
sed -i "/>/ s/>.*/>${finalFileName%\.fa}/" ${finalFileName}
seqtk seq -l 0 ${finalFileName} > ${finalFileName}.tmp
mv ${finalFileName}.tmp ${finalFileName}

## now we add the other clade to this...

ls /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/OGhylo_clade2.afa

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo

## let's look at this alignment on the laptop:
#getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/OGhylo_clade2.afa"
getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/OGhylo_clade2_msaEdits_cleaned.fasta"
putHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/alignmentsOGHyloRedo/"
rsync -auv test@132.180.112.115:$getFile $putHere

conda activate cialign

CIAlign --infile OGhylo_clade2.afa \
        --outfile_stem OGhylo_clade2_msaEdits \
        --insertion_min_perc 0.2 \
        --insertion_min_flank 1 \
        --insertion_min_size 1 \
        --insertion_max_size 600 \
        --remove_insertions 

## downloaded above

mv OGhylo_clade2_msaEdits_cleaned_handEdited.fasta OGhylo_clade2_msaEdits_cleaned_handEdited.afa

alignFile="OGhylo_clade2_msaEdits_cleaned_handEdited.afa"
finalFileName="Hylocomium_nostoc_OGredo_16s_clade2.fa"
hmmbuild ${alignFile/_msaEdits_cleaned\.afa/\.hmm} ${alignFile}
hmmemit -c -o $finalFileName ${alignFile/_msaEdits_cleaned\.afa/\.hmm}
seqtk seq -l 0 ${finalFileName} > ${finalFileName}.tmp
mv ${finalFileName}.tmp ${finalFileName}

## and blasting that...
## yeah, that it is trash, some kind of pseudomonas, maybe. 

## just ignore it, keep the other, Nostoc-like thing.

## store this consensus seq with the other new ones:
cp Hylocomium_nostoc_OGredo_16s.fa  /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/

## update and synch up


## stopping here 23 October





getFile="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/alignmentsOGHyloRedo/OGhylo_clade2_msaEdits_cleaned_handEdited.fasta"
putHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/redoOGhylo/"
rsync -auv $getFile test@132.180.112.115:$putHere



## and for clade 2, the smaller one?

## on nanoComp:




############## cydrasil tree, try 2 ###############


## then hang it on a tree. How do we do that?

## pipeline here:
https://github.com/FGPLab/cydrasil

## step one, align our sequence against their reference sequence set:
## they recommend one of two alignment software, ssh-aligner or papara
## so ssh. Let's use ssh-align, start with the N-containing consensus  

## this is already installed somewhere on our lab comp:
conda activate cydrasil

cd /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/placeConsensusSeqOnCydrasil

## the various files we need:
cydDir=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/
querySeq=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/leptoNostoc_withN.fa
refAlignment=${cydDir}Cydrasil-v3-reference-alignment.afa
mask=${cydDir}cydrasil-v3-ssu-align.bacteria.mask
tree=${cydDir}cydrasil-v3-reference-tree.nwk
model=${cydDir}cydrasil-v3.bestModel

## all there?
ls -l $querySeq
ls -l $refAlignment
ls -l $mask
ls -l $tree
ls -l $model

## I don't know if we need to do the alignment step when we only have
## one sequence?

## we need some sort of alignment, because they want an SSU-Align alignment model
ssu-align $querySeq ssuAl

## mask it:
ssu-mask -s $mask ssuAl/

## convert back to fasta:
ssu-esl-reformat -o ssuAl/ssuAl.bacteria.mask.afa afa ssuAl/ssuAl.bacteria.mask.stk

## this should now be generally aligned with SSU reads from the rest of the world, ready for placement:
queryAligned=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/placeConsensusSeqOnCydrasil/ssuAl/ssuAl.bacteria.mask.afa

less /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/placeConsensusSeqOnCydrasil/ssuAl/ssuAl.bacteria.mask.afa

## placement on tree

## this works:
epa-ng -s $refAlignment \
       -t $tree \
       -q $queryAligned \
       -m $model --redo

# ## without redo, aborts. Why??
# epa-ng -s $refAlignment \
#        -t $tree \
#        -q $queryAligned \
#        -m $model 

## that seems to have worked

## makes a "jplace" file that is pretty much a newick file, I think, that ITOL can use. 

## we'll try visualization on itol as per instructions

## danchurch is itol login name

## the info is a bit outdated as far as how to root the tree

## check out these articles:
https://communities.springernature.com/posts/margulisbacteria-and-saganbacteria-the-newly-uncovered-siblings-of-cyanobacteria
https://www.nature.com/articles/s41396-021-00898-x

## the github for cydrasil suggests searching for WOR-1 bacteria, or White-Oak-River bacteria, 
## which are called Sagenbacteria in the article.

## According to this article, all of the Margulisbacteria and Sagenbacteria (hah!)
## are a sister group to cyanos. So find the branch for all of these 
## sequences and bend the tree there

## At time of writing, this is the node between gleobacter and these 
## MargulisBacter/Sagenbacter/Sericytochromatia things: 2528

## how do I find my placed sequence?

## in the iTOL control panel, use the "Datasets" tab, 
## a "Datasets" box should pop up, allow you to toggle the placements in the file
## then the "search placements" box should pop up, and allow highlighting 

## regardless of root, this placement also puts our nostoc right in there 
## with:

## FJ815291.1 = Peltigera-associated Nostoc
## JX088109.1 = freshwater aquatic calothrix from NZ
## KT760404.1 = undescribed n-fixing nostoc from grassland soil of NZ (unpub)
## JQ771626.1 = Finnish peltigera

## related:
## the closest blast from microbial genomes of NCBI is to N. punctiforme, with 90% seq sim in 16S
## and for just 16S sequences from genbank, it blasts at 91.26% seq sim to two Nostocs:
KF359696.1, a leptogium symbiont, and JN847344.1, also from leptogium.

## Nostoc.s sp.str KVJ20  = liverwort symbiont
## the genome for this has been sequenced: https://doi.org/10.1128/mra.01190-19

## what about our old friends, closest blast matches: JN847344.1.1541 and KF359696.1

less ${cydDir}Cydrasil-v3-reference-alignment.afa ## they aren't in there, as far as I can tell

## do we need/want a graphic for our JGI application?



############## start over with new nostocs #############

## we have repeated the same nanopore sequencing process
## on some nostoc colonies isolated from other hosts


## We had to do the sequencing without the basecalling because
## of software updates and driver issues. How can we start the basecalling of
## the Pod5 voltage files we created?

## which are here, btw:
/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5


## maybe some help here:
## https://nanoporetech.com/document/data-analysis

## back up the read files:

cd /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90

tar cvzf nostocColonyPCRsRound2.tar.gz pod5/

## back this up to desktop:

cd /media/vol/mossStuff/nostocColonyPCRbackups
rsync -auv test@132.180.112.115:/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/nostocColonyPCRsRound2.tar.gz . 

## as far as basecalling, is it as simple as?:

#mkdir /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled
outDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled"
pod5="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5"
dorado basecaller sup $pod5 -v --device cuda:all --emit-fastq -o $outDir

(dorado basecaller sup $pod5 -v --device cuda:all --emit-fastq -o $outDir & ) &

## seems to work. As per the documentation (https://dorado-docs.readthedocs.io/en/latest/)
## pipe the results to the demultiplexer:

dorado basecaller sup $pod5 --device cuda:all -v |
dorado demux --output demuxed -v

dorado basecaller ... | dorado demux --output demuxed

dorado basecaller sup

dorado demux --output demuxed

## not working for me, not sure why. Try on basecalled files without piping 
## commands:

reads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/calls_2025-07-19_T09-33-22.fastq"
demuxDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed"
dorado demux --kit-name SQK-RBK114-24 --emit-fastq -o $demuxDir $reads

## but the vast majority are unclassified.
## maybe because I'm not using BAM formatting?
## see here: https://github.com/nanoporetech/dorado/issues/1178

## maybe something like:

pod5="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5"
demuxDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed"

dorado basecaller sup $pod5 -v --device cuda:all | dorado demux --kit-name SQK-RBK114-24 -o $demuxDir $reads

## that helped dramatically. The vast majority are still unclassified reads, though. 
## Also reads from barcodes that were not in my study. These are either erroneous or 
## from Dimitri's experiments. 

## any other defaults we can tweak? break up the command:

pod5="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/20250718_1454_MN40608_FBA42671_2ed2dc90/pod5"
demuxDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed"
basecalledDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/basecalled"

cd $pod5

dorado basecaller -v --device cuda:all  -o $basecalledDir sup $pod5 

## is trimming the default? try turning it off. 
dorado basecaller -v --no-trim --device cuda:all  -o $basecalledDir sup $pod5

## GPU is working hard:
nvidia-smi -l 5

############ duplex basecalling possible? #############

## is it possible to rerun basecalling, in duplex mode?
## https://nanoporetech.com/document/kit-14-device-and-informatics#basecalling-kit-14-duplex-data
## not sure if we missed a step somewhere that would preclude this 

## somthing like this 
dorado duplex dna_r10.4.1_e8.2_400bps_sup@v4.1.0 pod5s/ > duplex.bam

## didn't seem to help much...
###########################################################


## now try demultiplexing...
dorado demux -v --kit-name SQK-RBK114-24 -o $demuxDir $basecalledDir

## that helped a lot, we're up to 31% classified. Still low, though...
## any errors reported in veryVerbose mode?

dorado demux -vv --kit-name SQK-RBK114-24 -o $demuxDir $basecalledDir 2> log.txt

dorado demux -h | less

grep -c "midstrand" log.txt ## 23810 hits, lots. May be why we have low classification %

## is there a way to ignore these mid strand barcodes?
## don't see it. 

## there is mention about this:
https://github.com/nanoporetech/dorado/issues/1178

## somewhere there is a toml file to change the scoring for midstrand
## and other issues. 

## trim primers and adapters?
## for now just adapters. We might need the primers to clear things up (nif vs. 16s, etc)
## coming back to this, realized that the demux step also has an default trim option
## so this didn't matter. To retain adapters, I guess you have to tell it during demuxing and
## trimming stages

trimmedDir=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed

cd /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/demuxed

demuxedFile1="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.bam"
dorado trim \
    -k SQK-RBK114-24 \
    -v \
    --no-trim-primers \
    --emit-fastq \
    $demuxedFile1 > ${trimmedDir}/${demuxedFile1}


for demuxedFile in *bam; do
  echo "Starting ${demuxedFile}"
  dorado trim \
    -k SQK-RBK114-24 \
    -v \
    --no-trim-primers \
    --emit-fastq \
    $demuxedFile > ${trimmedDir}/${demuxedFile/\.bam/\.fastq}
  echo "Done ${demuxedFile}"
done

## try aligning to 16s, NifH, etc. 

## on line 188 above, we made a formatted blastn database for finding
## hits to nostoc, try it here for our 16s reads.
## would be barcodes 9-11

## need to convert to fasta

seqtk seq -A 2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq > 

outDir=/media/vol1/daniel/nostoc/blastout/round1_Hylocomium/round2_ZygodonHomaliaAmbylostegium

cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta

minionReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed

cd $minionReads
for i in 2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode{09..11}.fastq; do
  echo $i
  j=${i/*SQK-RBK114-24/nostoc_16S}
  k=${j/\.fastq/\.fasta}
  l=${k/\.fasta/\_cyanoMatches.csv}
  seqtk seq -A $i > $k
  echo $l
  blastn -db $cyanoDB \
    -query $k \
    -num_threads 10 \
    -num_alignments 1 \
    -out $l \
    -outfmt 10 
done

mv *cyanoMatches.csv /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/




## for the moment, let's see if we can make sense of our 16s. Worried about
## the Amblystegium, doesn't come out cleanly as a nostoc

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/

grep "Nostocaceae;Nostoc" nostoc_16S_barcode09_cyanoMatches.csv 

grep -c  "Nostocaceae" nostoc_16S_barcode09_cyanoMatches.csv ## 350
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode09_cyanoMatches.csv ## 64, out of...

grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq ## 4367 reads
wc -l nostoc_16S_barcode09_cyanoMatches.csv ## and 3861 of these 4367 matched to cyanobacteria? seems high.
## before, in hylocomium, only 25% matched to cyanobacteria, but of these almost all matched nostoc. 

## could this be a relic of the fact that we parsed our database down to just cyanbacteria? What happens
## if we blast again all bacteria?

## download full silva db, blast against this?

wget https://www.arb-silva.de/fileadmin/silva_databases/release_138/Exports/SILVA_138_SSURef_tax_silva.fasta.gz

mv SILVA_138_SSURef_tax_silva.fasta.gz /media/vol1/daniel/databases/silva

cd /media/vol1/daniel/databases/silva

gunzip SILVA_138_SSURef_tax_silva.fasta.gz 

head -n 100 SILVA_138_SSURef_tax_silva.fasta  ## ugh the spaces are going to cause a problem in the headers.


## nostoc punctiforme from the PCC:
grep -A1 "AF027655" silva138_SSU_reformathead.fasta


clear
head -n 1 SILVA_138_SSURef_tax_silva.fasta 

## this seems to work, get rid of first space
head -n 1 SILVA_138_SSURef_tax_silva.fasta | sed -r 's/(^>[^ ]*) /\1;/' 

## try for the whole file:
sed -r 's/(^>[^ ]*) /\1;/' SILVA_138_SSURef_tax_silva.fasta > silva138_SSU_reformathead.fasta

## do it without parsing seq ids, because of our very long headers.
makeblastdb -in silva138_SSU_reformathead.fasta -dbtype nucl 



cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium


minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq"

## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}

blastn -db $blastDB \
  -query ${readFile/\.fastq/\.fasta} \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode9-allSilva.csv \
  -outfmt 10 

## did this make a difference?
grep -c "Nostocaceae;Nostoc" nostoc_16S_barcode09_cyanoMatches.csv ## 64
grep -c "Nostocaceae;Nostoc" round2Barcode9-allSilva.csv  ## 9
## quite. 

grep -c  "Nostocaceae" nostoc_16S_barcode09_cyanoMatches.csv ## 350
grep -c  "Nostocaceae" round2Barcode9-allSilva.csv ## 26, many of which are calothrix.

grep "Nostocaceae" nostoc_16S_barcode09_cyanoMatches.csv 
grep "Nostocaceae" round2Barcode9-allSilva.csv ## 26, 

## anyway, not sure what to do with this barcode. I cannot tell if we actually sequenced the c.f. nostoc colony 
## or not. 

## that will run for a while?
## and the others?

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

## barcode 10 should be nostoc from Homalia:
grep -c  "Nostocaceae" nostoc_16S_barcode10_cyanoMatches.csv ## 393
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode10_cyanoMatches.csv ## 380, out of...
grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq ## 569 reads
## that is simpler, clearly a nostoc. But not abundant, let's hope we can work with that.

## barcode 11 should be nostoc from Zygodon:
grep -c  "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv ## 1762
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode11_cyanoMatches.csv ## 1121, out of...
grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq ## 4859 reads

################# barcode 9 get consensus seq ############################

## can we get barcode 9 working? though listed first, this is our last 
## 16s effort of the three from the most recent nanopore sequencing
## data.

## because at first glance, this was the worst data. Rerun the blast check for nostocs, to be sure

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09

blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq"

## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}
#nohup blastn -db $blastDB \
#        -query ${readFile/\.fastq/\.fasta} \
#        -num_threads 10 \
#        -num_alignments 1 \
#        -out round2Barcode09-allSilva.csv \
#        -outfmt 10 & ## 

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode09-allSilva.csv


less round2Barcode09-allSilva.csv

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09

wc -l round2Barcode09-allSilva.csv  ## 4030. Lots of reads. Probably pseudomonas.

grep -c "Nostocaceae;Nostoc" round2Barcode09-allSilva.csv  ## 9. Probably not a nostoc. 

grep "Nostocaceae;Nostoc" round2Barcode09-allSilva.csv  >  round2Barcode09nostoc-allSilva.csv

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode09nostoc-allSilva.csv


grep -c "Cyanobacteriia" round2Barcode09-allSilva.csv  ## more. 

grep "Cyanobacteriia" round2Barcode09-allSilva.csv  ## vast majority to unidentified Oxyphotobacteria (=Cyanophycaceae), the parent order of all normal cyanos. Great.

## any particularly prominent ones?

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09/')

all16sMatches = pd.read_csv('round2Barcode09-allSilva.csv', index_col='qseqid')
nostoc16sMatches = pd.read_csv('round2Barcode09nostoc-allSilva.csv', index_col='qseqid')

## get rid of taxonomy
all16sMatches['sseqid'] = all16sMatches['sseqid'].str.split(';', expand=True)[[0]]
nostoc16sMatches['sseqid'] = nostoc16sMatches['sseqid'].str.split(';', expand=True)[[0]]

all16sMatches.head()

nostoc16sMatches.head()

nostoc16sMatches

pd.set_option('display.max_rows', None)

all16sMatches.groupby('sseqid').count() 

aa = all16sMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True) 

## we have only two good nostoc matches, both to DQ185249, a Peltigera symbiont:
c029ef09-a3d9-497b-bdf5-9ff2ca132b48
4c493455-23f3-4147-8995-431dbcc7554d
## maybe there are more matches in our unclassified reads?
## search them:

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09

echo c029ef09-a3d9-497b-bdf5-9ff2ca132b48 > peltigeraNostocBC9.txt
echo 4c493455-23f3-4147-8995-431dbcc7554d >> peltigeraNostocBC9.txt
less peltigeraNostocBC9.txt

## they don't align well. But I think that is because they are +/- and
## coming in from opposites sides, not a lot of overlap

## meh, let's just grab them all in case we need them:

002514a6-cb78-48fd-9f02-43fcf928e1ac
4c493455-23f3-4147-8995-431dbcc7554d
6d9981eb-77c5-4ecc-872d-aef7ba461e89
23a77472-5eef-4678-8069-ec1b1bd1549b
1bf36659-e0af-475b-8f13-f87d32b204df
45dee099-f7b4-4d84-b679-29fbee90a094
0835ea80-5f12-4339-b2ff-f2ce165ea355
cfd7eaa9-9ab1-4a51-a154-0a7f78d14389
c029ef09-a3d9-497b-bdf5-9ff2ca132b48
## = allNostocThings_BC9_seqNames.txt

unclassyReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_unclassified.fastq
ls $unclassyReads
allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq

## tried first with minimap2, but never mind, brain is not in mm2 right now:
#minimap2 -ax map-ont $unclassyReads peltigeraNostocBC9.fastq > anyothers.paf
#minimap2 ref.fa query.fq > approx-mapping.paf

seqtk subseq $allReads peltigeraNostocBC9.txt | seqtk seq -A > peltigeraNostocBC9.fa
seqtk seq -A $unclassyReads > unclassyReads.fa
makeblastdb -in unclassyReads.fa -dbtype nucl 

blastn -db unclassyReads.fa \
       -query peltigeraNostocBC9.fa \
       -num_threads 10 \
       -num_alignments 5 \
       -out lookClassyPeltigeraNostocBC9.txt 

## meh, not much new there. Nothing I can add without any doubt, at best 95% matches 

## on NCBI, the two seqences with high scores both blast very well 
## to the peltigera symbionts from the Lutzoni 2005 paper
## maybe report the longer one, or at least include in the graphic of the tree

## let's grab some of these and do an alignment. First with all the nostoc reads 
## from this barcode

## DQ185255.1 = Sammlung von Algenkulturen, Universitaet Goettingen, Germany, From Thomas Friedl
## = Nostoc punctiforme associated with Blasia pusilla, sequenced by the Lutzoni project
## the others are peltigera symbionts from the same paper:

DQ185239.1
DQ185249.1
DQ185255.1

for i in DQ185239.1 DQ185249.1 DQ185255.1; do
  echo $i
  esearch -db "Nucleotide" -query $i | 
  efetch -format "fasta"  |
  seqtk seq -l 0 > ${i}.fasta 
done


allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode09.fastq
seqtk subseq $allReads allNostocThings_BC9_seqNames.txt | seqtk seq -A > allNostocThings_BC9.fa

## clean up the headers, manually, get down to just read names, with vim
## spike in some of the lutzoni sequences, see how well they all align:

cat DQ185239.1.fasta DQ185249.1.fasta DQ185255.1.fasta allNostocThings_BC9.fa > allNostocThings_BC9_andRefSeqs.fa

## reorient them: 

grep -c ">" allNostocThings_BC9_andRefSeqs.fa

grep ">" allNostocThings_BC9_andRefSeqs.fa


cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09


#cp allNostocThings_BC9_andRefSeqs.afa allNostocThings_BC9_andRefSeqs_notOriented.afa

silvaDB=/media/vol1/daniel/databases/silva/dada2silva/silva_nr99_v138.2_toGenus_trainset.fa
vsearch \
   --orient allNostocThings_BC9_andRefSeqs.fa \
   --db $silvaDB \
   --fastaout  allNostocThings_BC9_andRefSeqs_oriented.fa \
   --notmatched allNostocThings_BC9_andRefSeqs_NotOriented.fa 

## 7 forward, 5 reversed

## let's remove the leptolyngbya read (see below):

seqtk subseq allNostocThings_BC9_andRefSeqs_oriented.fa <(grep ">" allNostocThings_BC9_andRefSeqs_oriented.fa | 
grep -v "002514a6-cb78-48fd-9f02-43fcf928e1ac" | cut -d ">" -f 2 ) |
seqtk seq -l 60 > almostAllNostocThings_BC9_andRefSeqs_oriented.fa

muscle5 -align almostAllNostocThings_BC9_andRefSeqs_oriented.fa -output allNostocThings_BC9_andRefSeqs.afa

less allNostocThings_BC9_andRefSeqs.afa

## actually, this looks pretty good, even though we just have a handful of reads. 
getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09/allNostocThings_BC9_andRefSeqs.afa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode09"
rsync -auv test@132.180.112.115:$getFile $putHere

ugene -ui allNostocThings_BC9_andRefSeqs.afa

## some hand edits, put back:
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode09/allNostocThings_BC9_andRefSeqs_handEdited.afa"
putHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09/"
rsync -auv $getFile test@132.180.112.115:$putHere

FastTree -gtr -nt < allNostocThings_BC9_andRefSeqs.afa > uneditedBC9tree.nwk

 allNostocThings_BC9_andRefSeqs.afa

## It looks like a real high-quality match, especially the first read, 
## 4c493455-23f3-4147-8995-431dbcc7554d

## removing 002514a6-cb78-48fd-9f02-43fcf928e1ac, it doesn't align well at all. 
## yeah, all blast matches to leptolyngbia

## rerun the above alignment with just this read...

## yup. That is useable data. Aligned them as best as possible. 
## one large gap in coverage. 


alignFile="allNostocThings_BC9_andRefSeqs_handEdited.afa"
hmmbuild Ambylostegium_nostoc_BC9_16s.hmm ${alignFile}
hmmemit -c -o Ambylostegium_nostoc_BC9_16s.fa Ambylostegium_nostoc_BC9_16s.hmm
sed -i '/^>/ s/.*/>Ambylostegium_nostoc_BC9_16s/' Ambylostegium_nostoc_BC9_16s.fa

## there are no gaps or Ns in this. I don't understand that. Let's check an alignment:

muscle5 -align <(cat almostAllNostocThings_BC9_andRefSeqs_oriented.fa Ambylostegium_nostoc_BC9_16s.fa) -output howisourconsensus.afa

less howisourconsensus.afa

ugene -ui howisourconsensus.afa &

## oh weird. Instead of N at the gap, or "-", hmmer put "T". I have no idea why. There was no information
## for these sites, just "N" on the MSA in one sequence. I fixed again manually, replacing with Ns. 


getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode09/howisourconsensus.afa"
putHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode09"
rsync -auv test@132.180.112.115:$getFile $putHere

## get rid of linebreaks, hand edit the sequence in vim
seqtk seq -l 0 Ambylostegium_nostoc_BC9_16s.fa > 2Ambylostegium_nostoc_BC9_16s.fa
mv 2Ambylostegium_nostoc_BC9_16s.fa Ambylostegium_nostoc_BC9_16s.fa
vim Ambylostegium_nostoc_BC9_16s.fa

## added back in the intro bps that hmmer didn't trust (they match other 
## nostoc 16s exactly, so why not), and insert a long set of N's where
## I have no read data but other nostoc 16s has nucleotides.

## so let's keep that one as our representative sequence:
cp Ambylostegium_nostoc_BC9_16s.fa  /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/Ambylostegium_nostoc_BC9_16s.fa


## concerning the larger, total pool of sequences in bc9, not just nostoc-like things,
## the two most common hits are to completely unknown, uncultured bacteria with 
## no taxonomic information. One is free living on various outdoor substrates
## at a park in SW china (KF037401), the other is a human wound-inhabiting bacteria. 
## great. I want to quit. 

## look again, subset to just cyanobacteria:
grep "Cyanobacteriia" round2Barcode09-allSilva.csv > allCyanoMatchesBC09.csv
#sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' allCyanoMatchesBC09.csv

allcyanoMatches = pd.read_csv('allCyanoMatchesBC09.csv', index_col='qseqid')
allcyanoMatches['sseqid'] = allcyanoMatches['sseqid'].str.split(';', expand=True)[[0]]
allcyanoMatches.head()

aa = allcyanoMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## the most common taxa is KF037287.1.1456
## well, weird, this blasts to the same paper as with our all-taxa, 
## the genbank accession has no taxonomic information, but silva does?

## anyway, we will report the above 16s as a consensus seq, see if it is useful.

## and report that the culture was lost, this hit as a possible remnant
## of the nostoc that we photographed from this

################# barcode 10 get consensus seq ############################

## both are more promising. Start with barcode10. 

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10

## just curious, are there a lot of duplicate reads, as before? 
## Could be skewing results here.
readDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
barcode="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"

ls $readDir/$barcode

seqtk seq -A ${readDir}/${barcode} | sed -n "/>/p" |  cut -f 1 -d " " | sort | uniq -d ## I see no dups

## run the blast 
blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"

ls $minionReads/$readFile

## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}

blastn -db $blastDB \
  -query ${readFile/\.fastq/\.fasta} \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode10-allSilva.csv \
  -outfmt 10 


grep "Nostocaceae;Nostoc" nostoc_16S_barcode10_cyanoMatches.csv > barcode10_nostocMatches.csv

cut -f1 -d, barcode10_nostocMatches.csv > barcode10_nostocReads.txt

## use seqtk to keep only the matches to nostoc
allReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"
seqtk subseq $allReads barcode10_nostocReads.txt > barcode10_onlyNostoc.fastq

grep -c "Nostocaceae;Nostoc" nostoc_16S_barcode10_cyanoMatches.csv 

wc -l round2Barcode10-allSilva.csv

wc -l barcode10_onlyNostoc.fastq

wc -l barcode10_nostocMatches.csv

## add headers

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode10_nostocMatches.csv

less barcode10_nostocMatches.csv


## check out barcode 10 with python:

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10')

nostocMatches = pd.read_csv('barcode10_nostocMatches.csv', index_col='qseqid')

## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

nostocMatches.groupby('sseqid').count() 
## the most common match (117 matches) is JQ007760.1.1503, host Peltigera degenii, from Kaasalainen et al. (2012) 
## "Cyanobacteria produce a high variety of hepatotoxic peptides in lichen symbiosis"
## second most common (43) is nephroma cyanobiont HQ591517.1.1534
## at some point, we need to compare with our Hylocomium symbiont. Where is our consensus sequence for this?

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()

bb = aa.T.iloc[0,:].sort_values(ascending=False)

peltigeraMatches = nostocMatches[nostocMatches['sseqid']=='JQ007760.1.1503']

nephromaMatches = nostocMatches[nostocMatches['sseqid']=='HQ591517.1.1534']

pd.set_option('display.max_rows', None)

peltigeraMatches

nephromaMatches

## both are very strong. Perhaps we have two strains? Hard to tell.

##  

peltigeraMatches[['pident', 'length']].mean() ## on average, 95% match

## overall picture:
aa = nostocMatches[['sseqid', 'pident', 'length']].groupby('sseqid')


nephromaMatches[['pident', 'length']].mean() ## on average, 95% match also.

################## note 18.9.25 ###########################
## to make things even more confusing, optimization of 
## the consensus sequence pipeline has changed yet again. 
## see the end of this barcode 10 section to see most current
## effort, line 1806 below  
###########################################################

## so halfway between two cyanobionts. Kind of like last time. 

## at this point, before, we used the best blast matches to nostoc, 
## selected ~500 seqs with strict matches to a particular region 
## aligned these, and manually curated a consensus sequence for downsteam

## last time, SSUalign didn't work that well, but I think we may have
## cleaner data this time, or at least smaller data. Let's try to align our 
## barcode 10 reads that aligned 

readDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
barcode="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"

/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium


conda activate cydrasil

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}
nohup ssu-align -f ${barcode/.fastq/.fasta} msaBarcode10 
ssu-mask msaBarcode10 

conda activate jalview

jalview 

## this is a worthless alignment, as before. Not sure why.

## try muscle: 

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}

muscle -in ${barcode/.fastq/.fasta} -out muscleMSAbarcode10.fa

## looks promising. Grab it locally:

rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSAbarcode10.fa \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## and it's a mess. Hard to identify what is best here. we can do a lot of manual
## editing to the alignment to maybe get a consensus sequence. But let's 
## repeat the first pipeline we did, of looking for a region of high-agreement 
## in the verbose blast document, and selecting reads that contain this region 

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

#readDir="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
#barcode="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"
readDir="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium"
barcode="barcode10_onlyNostoc.fastq"
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}
nostocReads=${barcode/.fastq/.fasta}
cyanoDB=/media/vol1/daniel/nostoc/cyanoRef16s/silvaCyanos.fasta
nohup blastn -db $cyanoDB \
  -query ${barcode/.fastq/.fasta} \
  -num_threads 10 \
  -num_alignments 1 \
  -out barcode10nostocs_2cyanoSilvaVerbose.txt &
  #-out barcode10minion2cyanoMatchesVerbose.txt &

######################################################################################################
## to review, last time we randomly grabbed a conserved region around position 1050 :
## less /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatchesVerbose.txt 
## grep  "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatchesVerbose.txt |
## grep  "AAACCGGAGGAAGGTGG"  
## ## which took us from many (35,220) of matches to 400 or so:
## grep -c  "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatchesVerbose.txt 
## wc -l /media/vol1/daniel/nostoc/blastout/round1_Hylocomium/minion2cyanoMatches.csv
## still not sure if that was a good way to do this...
######################################################################################################

## is this sequence also in our new nostoc?

grep "Query.*AAACCGGAGGAAGGTGG" /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10minion2cyanoMatchesVerbose.txt |
grep  "AAACCGGAGGAAGGTGG"  
## yes, but scattered all over the place.

## how are our qualities of these reads that aligned to nostocaceae

fastqc barcode10_onlyNostoc.fastq

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

## checking on just these nostoc...
fastqc -t 10 -o /media/vol1/daniel/nostoc/fastqcOutputs/round2/barcode10 barcode10_onlyNostoc.fastq

rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/fastqcOutputs/round2/barcode10/barcode10_onlyNostoc_fastqc.html \
  /home/daniel/Documents/projects/mossSymbiosis/fastqc/

## they actually seem quite good, for nanopore, somewhere around 28 for most of the positions of most of the reads.

## let see if we can identify and other sequence that could be useful
## maybe let's try to hit the v4 region, inside the normal EMB primers 515/806

less barcode10nostocs_2cyanoSilvaVerbose.txt

## eg this sequence, or RC:
grep -c "AAGAGTCTAGCTCAACTAGATAAGAGCAGTGGAAACTAC\|GTAGTTTCCACTGCTCTTATCTAGTTGAGCTAGACTCTT" barcode10_onlyNostoc.fasta 
## 60 hits, out of 569 ~ 10% of reads in the barcode

## eg this sequence, or RC:
grep -c "GCATTTCACCGCTACACCAGGAATTCCCTCTGCCCCGAA\|TTCGGGGCAGAGGGAATTCCTGGTGTAGCGGTGAAATGC" barcode10_onlyNostoc.fasta 
## 56 hits

## if we go to the just the matches to our most common match, JQ007760.1.1503:
grep -c ">JQ007760" barcode10nostocs_2cyanoSilvaVerbose.txt  ## 121 matches. look at these



## some possibilities:

grep -c "TTCTTCCTGATCTCTACGCATTTCACCGCTACACCA\|TGGTGTAGCGGTGAAATGCGTAGAGATCAGGAAGAA" barcode10_onlyNostoc.fasta

## meh, unlike last time, I think we are dealing with intentionally fragmented amplicons,
## from tagmentation, so it is probably best to simply use all the sequences that align with our most 
## common match.

## then we can use this align to structure the rest, as per https://drive5.com/muscle/manual/addtomsa.html

## so, let's pull out those with just an best hit to JQ007760.1.1503:

less barcode10_nostocMatches.csv 

grep -c JQ007760 barcode10_nostocMatches.csv 

#grep JQ007760.1.1503 barcode10_nostocMatches.csv > barcode10_nostocJQ007760Matches.csv
## don't rerun unless you need to! Hand-edited to remove a few sequences, below
cut -f1 -d, barcode10_nostocJQ007760Matches.csv > barcode10_JQ007760Reads.txt


allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_JQ007760Reads.txt > barcode10_JQ007760.fastq

## let's try aligning these:


cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

readDir=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium
barcode=barcode10_JQ007760.fastq
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}

muscle -in ${barcode/.fastq/.fasta} -out muscleMSA_barcode10_JQ007760.fa

rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSA_barcode10_JQ007760.fa \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## actually looks good. Time for some hand editing.

## record of hand-edits of round2 barcode 10 blast matches to JQ007760

## 1 the following sequences don't fit in the alignment at all. I'm not sure what happened. 
#    for the moment, removing them and rerun alignment as above:

2b8c14b7-24e5-4306-8954-ff42c0098a21
2d8a4e8e-0771-41b9-b1f2-5c699df1dcbe
71337ef8-62aa-49fe-872e-83fad3ed302c
7dcfc702-f1cd-4dec-9d6d-318bbf6ea096
9080bca4-5689-426d-af53-0b0aa9f107be
925d2359-c67a-4076-bfc5-b59def3a5f9e
dfc03e80-3375-4193-baec-e3408bf0b186
e3322d0f-3fc4-4708-b442-25403222eeb4

## saved as weirdJQ007760matches.txt

## removed these by hand from our list of sequences for the msa
#vim barcode10_nostocJQ007760Matches.csv

## then rerun above code to run the msa
cut -f1 -d, barcode10_nostocJQ007760Matches.csv > barcode10_JQ007760Reads.txt
allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_JQ007760Reads.txt > barcode10_JQ007760.fastq


cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

readDir=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium
barcode=barcode10_JQ007760.fastq
seqtk seq -A ${readDir}/${barcode} > ${barcode/.fastq/.fasta}
muscle -in ${barcode/.fastq/.fasta} -out muscleMSA_barcode10_JQ007760.fa

## from desktop:
rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSA_barcode10_JQ007760.fa \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## following this, some more hand-editing in ugene, removed all gaps that were 90% or more empty.
## also removed all gaps that were mostly empty and next to homopolymers, especially if the
## gap was created by the same nucleotide in the homopolymer in a few reads (cause Nanopore).
## then clipped the first 134 bp from the alignment, there was a lot of noise in the 
## early reads and low coverage. Must be the tagmentation issue?

## anyway, here is at least one consensus seq from that effort (barcode 10, sequences that blast to JQ007760 from Homalia)
>Consensus seq for Nostoc from Homalia
aaggcgtaaggggcatgctgacttgacgtcatccccaccttcctccggtttgtcaccggcagtctctctagagtgcccaacttaatgctggcaactaaaaacgagggttgcgctcgttgcgggacttaacccaacatctcacgacacgagctgacgacagccatgcaccacctgtgttcgcgctcccgaaggcacttgaagctttcactccaattcgcgacatgtcaagccttggtaaggttcttcgcgttgcatcgaattaaaccacatactccaccgcttgtgcgggcccccgtcaattcctttgagtttcaccgttgccggcgtactccccaggcgggatacttaacgcgttagctacggcacggctcgggtcgatacaagccacgcctagtatccatcgtttacggctaggactactggggtatctaatcccattcgctcccctagctttcgtccctcagtgtcagttgcggcctagcagagcgccttcgccaccggtgtttctcctgatctctacgcatttcaccgctacaccaggaattccctctgcccgaacgcactctagcgatgtagtttccactgctctttatctagttgagctagactctttaacagcagacttacatcgccacctgcggacgctttacgcccaatcattccggataacgcttgcatcctccgtattaccgcggctgctggcacggagttagccgatgcttattcctcaggtaccgtcattgtgttcttccctgagaaaagaggtttacgacccaagagccttcctccctcacgcggtattgctccgtcaggctttcgcccattgcggaaaattccccactgctgcctcccgtaggagtctgggccgtgtctcagtcccagtgtggctgatcgtcctctcagaccagctactgatcgtcgccttggtaggctcttactctaccaactagctaatcagacgcgagctcatcttcaggcagttaacctttcaccccgaagggcacatccggtattagccaccgtttccagtggttgtcccagacctgaagccagattctcacgcgttactcacccgtccgccactaaatcccgaaagatttcgttcgacttgcatgtgttaagcataccgccagcgttcatcctgagcca

## as predicted, still blasts best to peltigera symbionts, especially the JQ007760 accesssion
## maybe tomorrow rerun the alignment of all nostocs with this as a reference seq? 

## why not?...following: https://drive5.com/muscle/manual/addtomsa.html

## first, remove the sequences we already have in our alignment to JQ007760 from our larger, aligned-to-nostoc file:

## on nanoComp:

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium

## sequences we don't need (already in alignment):

wc -l barcode10_nostocJQ007760Matches.csv 

cut -f 1 barcode10_nostocJQ007760Matches.csv -d ,

## we need to modify:

wc -l barcode10_nostocMatches.csv 

## so something like:

cat <(cut -f 1 barcode10_nostocJQ007760Matches.csv -d ,) <(cut -f 1 barcode10_nostocMatches.csv -d ,) | 
     sort | 
     uniq -u | 
     sed '/qseqid/d' > barcode10_nostoc_NOT_JQ007760readNames.txt

     barcode10_nostoc_NOT_JQ007760readNames.txt
     seqtk sub


allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_nostoc_NOT_JQ007760readNames.txt > barcode10_nostoc_nonJQ007760Matches.fasta

## back to: https://drive5.com/muscle/manual/addtomsa.html
## run an alignment on these:

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle

readDir=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium
reads=barcode10_nostoc_nonJQ007760Matches.fasta

seqtk seq -A ${readDir}/${reads} > ${reads/.fastq/.fasta}

muscle -in ${reads/.fastq/.fasta} -out muscleMSA_barcode10_notJQ007760.afa

muscle -profile -in1 muscleMSA_barcode10_JQ007760.fa -in2 muscleMSA_barcode10_notJQ007760.afa -out muscleMSA_barcode10_Nostoc_onJQ007760.afa

## did that work? look at it:
getFile="muscleMSA_barcode10_Nostoc_onJQ007760.afa"
rsync -auv test@132.180.112.115:/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/${getFile} \
  /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

## interesting, the blast results might be accurate. As in, there may be multiple strains here. I think I see support for
## at least two. What does it look like if we make a tree on these sequences, as is?

cd /media/vol1/daniel/nostoc/16sTree/round2/barcode10
alignment="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/muscle/muscleMSA_barcode10_Nostoc_onJQ007760.afa"
FastTree -gtr -nt < $alignment > barcode10_Nostoc_onJQ007760.nwk

getFile="/media/vol1/daniel/nostoc/16sTree/round2/barcode10/barcode10_Nostoc_onJQ007760.nwk"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/


## yes, it's a mess, but looks like perhaps four groups. Not sure about their sequence difference,
## but it is really hard to distinguish them from noise. 
## for the moment, move on

## for now accept the above consensus seq. Try the same pipeline for barcode11

## return to this 30.07.2025
## and this approach really didn't work for barcode11. Too noisy.
## instead, below we aligned with SINA using a reference alignment
## from the cyanoseq database, then created a hmm profile from the
## alignment and generated a consensus sequence from this. 
## for consistency, let's apply this approach here. We can compare
## the consensus sequences, to see how consistent the two 
## approaches are.

## last time, we found some error due to the blast database used.
## let's make sure we use the entire silva 

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10

blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq"
## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}
nohup blastn -db $blastDB \
        -query ${readFile/\.fastq/\.fasta} \
        -num_threads 10 \
        -num_alignments 1 \
        -out round2Barcode10-allSilva.csv \
        -outfmt 10 & ## 

grep -c "Nostocaceae;Nostoc" round2Barcode10-allSilva.csv  ## 375


## pull out the nostoc-like things:
grep "Nostocaceae;Nostoc" round2Barcode10-allSilva.csv > barcode10_nostocMatches.csv
sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode10_nostocMatches.csv

####### 
python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

nostocMatches = pd.read_csv('barcode10_nostocMatches.csv', index_col='qseqid')

## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]
nostocMatches.head()
nostocMatches.groupby('sseqid').count() 
aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)

## as before, JQ007760.1.1503 is still the most common match

grep JQ007760.1 barcode10_nostocMatches.csv > barcode10_nostocJQ007760Matches.csv
cut -f1 -d, barcode10_nostocJQ007760Matches.csv > barcode10_JQ007760Reads.txt
allReads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq
seqtk subseq $allReads barcode10_JQ007760Reads.txt > barcode10_JQ007760.fastq

## so, align these with SINA against the cyanoseq db:
conda activate sina

cyanoseqARB=/media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.arb

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10

less barcode10_JQ007760.fastq

fastq="barcode10_JQ007760.fastq"
blastoutDir="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10"
#ls -l ${blastoutDir}/${fastq}
fasta=${fastq/\.fastq/\.fasta}
seqtk seq -A ${blastoutDir}/${fastq} > $fasta
cyanoseqARB=/media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.arb

sina \
  -i $fasta \
  -o ${fasta/\.fasta/aligned_cyanoseq.afa} \
  --db $cyanoseqARB &> log.txt

## as below, lots of errors. But I guess they can be ignored?

ls ${fasta/\.fasta/aligned_cyanoseq.afa} 


## how does this look?

getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10/barcode10_JQ007760aligned_cyanoseq.afa"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/

ugene -ui barcode10_JQ007760aligned_cyanoseq.afa ## that is noisier than our barcode11 ashitsuki matches below. 


## oh well. Try a consensus seq:

## as before hanging BPs to be manually removed
##c61c2933-c3be-4865-97eb-98bbcce1d3db
##2a4ec9cb-e3ae-4238-9ffc-83cc178a78be
vim ${alignDir}/${alignFile}

alignDir="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode10"
alignFile="barcode10_JQ007760aligned_cyanoseq.afa"
hmmbuild barcode10_JQ007760.hmm ${alignDir}/${alignFile}

## and ask for a "plurality" type consensus:
hmmemit -c -o barcode10_nostoc_JQ007760_16s_consensus.fasta barcode10_JQ007760.hmm

## RNA to DNA
sed -i '/^[^>]/ y/uU/tT/' barcode10_nostoc_JQ007760_16s_consensus.fasta 

less barcode10_nostoc_JQ007760_16s_consensus.fasta 


cd  /media/vol1/daniel/nostoc/consensusSequences/

## yeah, don't think that helped. A quick blast match is basically 
## nonsense. 
## weird. 

###### 18.9.2025 #####
## coming back to this yet again. I think I have 
## found a tidy pipeline for get consensus sequences
## it appears that these colonies sometimes have 
## different strains in them, which is weird 
## in addition to the chaos caused by low-quality
## nanopore data and tagmentation in the kit. 
## anyway, as explained below at end of  BC11, 
## pipeline is as follows:

## 1 - pull out all sequences with very high bit-score 
##     to some kind of nostoc
## 2 - align them with muscle
## 3 - build a tree with fasttree, unrooted
## 4 - plot the tree, take the obvious groupings as individual strains, 
## 5 - align these clades each individually with muscle
## 6 - hand-edit this alignment, get rid of vertical gaps > 70% or so
## 7 - build an HMM  for each
## 8 - predict a consensus sequence from each HMM

## so start yet again, and see if we get the same results.
## reusing the barcode 10 blast results from above, around line 1350

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os, re
#pd.set_option('display.max_rows', None)

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10')


nostocMatches = pd.read_csv('barcode10_nostocMatches.csv', index_col='qseqid')

## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## and if we want to filter bitscores?

minBitscore = 600
dd = (nostocMatches.query(f"bitscore > {minBitscore}")[['sseqid','evalue']]
            .groupby('sseqid')
            .count()
            .T.iloc[0,:]
            .sort_values(ascending=True))

#########################################################
## last time, we did this: 

## here let's take the top 4:
#nAccesions = 4
#bestAccessions = dd.iloc[-nAccesions:].index.to_list()
#bestAccessionsRegex = re.compile("|".join(bestAccessions))
#nostocMatchesBestAccessions = (nostocMatches[nostocMatches['sseqid']
#                                        .str.contains(bestAccessionsRegex)])

#########################################################

## but update yet again, on 30.09.2025
## revise to use all high-scoring matches, rather than 
## taking the top accessions:

minBitscore = 900 ## with these AA/nt blast matches, the bitscores are much lower.

nostocMatches.query(f"bitscore > {minBitscore}")[['sseqid','evalue']]

nostocMatches.query(f"bitscore > {minBitscore}").shape ## 171 seqs, let's try this

strongMatches = nostocMatches.query(f'bitscore > {minBitscore}')

wantedReads=strongMatches.reset_index().qseqid

rawReadsBarcode = ("/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/"
                   "OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/"
                   "2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode10.fastq")

os.path.exists(rawReadsBarcode)

highBits=[]
for rec in SeqIO.parse(rawReadsBarcode, "fastq"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)

len(highBits) ## 171, makes sense

#### return to previous pipeline

## write this out as a fasta?:
SeqIO.write(highBits, "Barcode10_strongNostocMatches.fa", "fasta")

## out of python...


## let's reorient these:

silvaDB=/media/vol1/daniel/databases/silva/dada2silva/silva_nr99_v138.2_toGenus_trainset.fa
vsearch \
   --orient Barcode10_strongNostocMatches.fa \
   --db $silvaDB \
   --fastaout  Barcode10_strongNostocMatches_oriented.fa \
   --notmatched Barcode10_strongNostocMatches_NotOriented.fa 



muscle5 -align Barcode10_strongNostocMatches_oriented.fa -output Barcode10_strongNostocMatches.afa 
## this takes a few minutes


alignment="Barcode10_strongNostocMatches.afa"
FastTree -gtr -nt < ${alignment} > Barcode10_strongNostocMatches.nwk 

## 3 min


## as barcode11 below, this has two strong "clades".

## Dimitri just showed me how to extract this with ARB, better than 
## my method of making an SVG an using the labels on the SVG.

## some notes on ARB:

## - middle wheel button on mouse is important, is the "paste" function
##   in text box. also the "grab" function for moving around tree view 

## - for our purposes, we need the "fasta_wgap.ift", under the "Import selected format"
##   in the start "ARB import menu" 

## - import accompanying tree with "tree" --> "tree admin" --> "Import"

## - after marking the clade of interest, can export these sequences:
##   File --> Export --> Export to external format --> etc. 
##    - can export raw fasta ("Compress" --> all gaps), or maintain integrity of the
##      the alignment. We don't want the alignment info in this case, just need the name of the 
##      sequences in each of these clades. We will rerun the alignments and curate.
##    - export format, for us "F_fasta_wide.eft"?


## unlike before, I don't see any obvious extra clades. I guess it was just a relic 
## of not re-orienting the reads....

getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10/Barcode10_strongNostocMatches.afa"
putItHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10"
rsync -auv test@132.180.112.115:/$getFile $putItHere

## handedited, the usual, remove all vertical gaps 70% or more in this case, weird edges dropped. Kept all reads.
getFile="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode10/Barcode10_strongNostocMatches_handEdited.afa"
putItHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10/"
rsync -auv $getFile test@132.180.112.115:$putItHere

##  build hmm

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode10

alignFile="Barcode10_strongNostocMatches_handEdited.afa"
finalFileName="Homalia_nostoc_BC10_16s.fa"
hmmbuild ${alignFile/_handEdited\.afa/\.hmm} ${alignFile}
hmmemit -c -o $finalFileName ${alignFile/_handEdited\.afa/\.hmm}
sed -i "/>/ s/>.*/>${finalFileName%\.fa}/" ${finalFileName}
seqtk seq -l 0 ${finalFileName} > ${finalFileName}.tmp
mv ${finalFileName}.tmp ${finalFileName}

## adding in the re-orientation of the reads improved the quality of 
## the blast matches (bitscore) by 50-200 points, but didn't really
## change the closest matches very much, a semi-random re-ordering 
## of the top 4 matches, it seems.

cp Homalia_nostoc_BC10_16s.fa /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/

## and now, what do these blast to?

## they blast to Nostoc pruniforma, Lichen symbionts (same as before), and
## a lot of uncultered nostocs. 


####################### barcode 11 #################################

## barcode 11 should be nostoc from Zygodon:

## reads here:
cd /media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11

grep -c  "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv ## 1762
grep -c  "Nostocaceae;Nostoc" nostoc_16S_barcode11_cyanoMatches.csv ## 1121, out of...
grep -c "bps_sup@v5.0.0" ${minionReads}/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq ## 4859 reads

## run a check for bias from db. Run against the entire silva and pull out the nostocaceae and/or nostoc matches
blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
minionReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed"
readFile="2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq"
## need a fasta
seqtk seq -A ${minionReads}/${readFile} > ${readFile/\.fastq/\.fasta}
nohup blastn -db $blastDB \
        -query ${readFile/\.fastq/\.fasta} \
        -num_threads 10 \
        -num_alignments 1 \
        -out round2Barcode11-allSilva.csv \
        -outfmt 10 & ## 120290

## from these, we need only those that match to nostaceae, I think

grep -c "Nostocaceae" round2Barcode11-allSilva.csv ## only 33, out of 4859 reads. 

grep -c ";Nostoc," round2Barcode11-allSilva.csv ## 22 nostocs

## compare this to when we blasted to a cyano-only database:

grep -c "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv ## 1762 reads. 

grep -c ";Nostoc," nostoc_16S_barcode11_cyanoMatches.csv ## 1126 reads. so mostly nostocs

## big effect by reference database used. I am only taking the first match, this may be the issue.
## not sure which to trust.

## maybe check one record that appears a Nostoceae in our cyano-matches, but not as a nostoc our entire-silva db matches 
## - is it second/third match? So one that didn't make it into our full silva search.

##  

less round2Barcode11-allSilva.csv

cat <(grep "Nostocaceae" round2Barcode11-allSilva.csv | cut -f 1 -d ,) \
    <(grep "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv | cut -f 1 -d ,) | 
     sort | 
     uniq -u  | wc -l ## 1721 unique (unrepeated sequences)

cat <(grep "Nostocaceae" round2Barcode11-allSilva.csv | cut -f 1 -d ,) \
    <(grep "Nostocaceae" nostoc_16S_barcode11_cyanoMatches.csv | cut -f 1 -d ,) | 
     sort | uniq -u | sed '/qseqid/d' 


## do all of these belong in the cyano-db blast results?
## anyway, most of them do, pick a few and make sure:

cyanoRds=(\
f9d89649-4261-45df-963c-ac3afa28ae03
f9f59d68-ba82-4593-b157-f5204c9f7c3f
f9ffe375-053d-4f4a-97ee-615793363c98
fa3affd9-65fd-4b3b-9328-ea80d3e6b83a
fad023b6-dad7-42ac-b08c-5b497e64f0d0
fad60fdc-feec-406f-bfa5-e0a0a66473ba
fb012ea3-8221-4acf-beae-0b0f85dd8f25
fb9925bb-7c5a-49ab-becc-a40c0c2fbd6d
fbd44391-7037-4773-9f3b-d62a11329ad2
)

## headers are: qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode11_nostocMatches.csv

for i in ${cyanoRds[@]}; do
  grep $i round2Barcode11-allSilva.csv | 
done ## in there, but...

for i in ${cyanoRds[@]}; do
  grep ${i} round2Barcode11-allSilva.csv | grep "Nostoc,"
done
## with the all silva database, only 4 out of 9 actually make to nostoc

for i in ${cyanoRds[@]}; do
  grep $i nostoc_16S_barcode11_cyanoMatches.csv
done
## yes in the cyano-only DB search

for i in ${cyanoRds[@]}; do
  grep $i nostoc_16S_barcode11_cyanoMatches.csv | grep "Nostoc,"
done
## same in the cyanoDB, 4 matches to nostoc

## the difference is that the remaining reads match to other weird 
## cyanos, with slightly weaker matches. 

## let's look at a few nostoc from our cyano-only DB 
## full silva search: 

## convert to fasta seq
nostocSeq="f9ffe375-053d-4f4a-97ee-615793363c98"
grep -A 1 $nostocSeq ${minionReads}/${readFile} | sed "s/^@/>/"

## when we blast this against the full NCBI database, we get a nostoc or some clost relative
## so why does our silva db search discard it?

nostocSeq="f9ffe375-053d-4f4a-97ee-615793363c98"
blastDB="/media/vol1/daniel/databases/silva/silva138_SSU_reformathead.fasta"
## rerun, with multiple matches and verbose format:
## need a fasta
blastn -db $blastDB \
  -query <(grep -A 1 $nostocSeq ${minionReads}/${readFile} | sed "s/^@/>/") \
  -num_threads 10 \
  -out dissappearingNostocBlast.txt

grep $nostocSeq round2Barcode11-allSilva.csv 

## the full silva matches are probably more trustworthy, but 
## there isn't really a difference when we focus on just 
## strong nostoc matches

## ah, the results from the cyanobacterial database weren't complete!
## actually not that big of a difference, lots of matches in both.

## as before, extract reads and blast results, see above for notes
## this time, since we have it, use the full silvaDB blast results

grep "Nostocaceae;Nostoc" round2Barcode11-allSilva.csv > barcode11_nostocMatches.csv ## down to 1023 matches. A little higher with cyanoDB, but trust this more
wc -l barcode11_nostocMatches.csv ## down to 1023 matches. A little higher with cyanoDB, but trust this more

cut -f1 -d, barcode11_nostocMatches.csv > barcode11_nostocReads.txt
allReads="/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq"
seqtk subseq $allReads barcode11_nostocReads.txt > barcode11_onlyNostoc.fastq
sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' barcode11_nostocMatches.csv

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11')

nostocMatches = pd.read_csv('barcode11_nostocMatches.csv', index_col='qseqid')
## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

pd.set_option('display.max_rows', None)

nostocMatches.groupby('sseqid').count() 

aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## AB511947.1.1445 (446 matches)
## AB511947 = wild, uncultured Nostoc verrucosum, an edible 
## next is FR798940 (167)
## FR798940 = "concrete-made fountain with stagnant water, black dry crust" 
## sounds like another free living bacteria.  
## KF037277.1.1457 (67 matches) is from tropical soil, China
## interesting, the accession doesn't give any taxonomy on this. 
## I only see the taxonomy in the manual blast reults

## AB511947.1.1445             446
## FR798940.1.1463             167
## KF037277.1.1457             67

ashitsukiMatches = nostocMatches[nostocMatches['sseqid']=='AB511947.1.1445']
concreteMatches = nostocMatches[nostocMatches['sseqid']=='FR798940.1.1463']
chinaMatches = nostocMatches[nostocMatches['sseqid']=='KF037277.1.1457']

pd.set_option('display.max_rows', None)


ashitsukiMatches[['pident', 'length']].mean() ## 94.9%, 687
concreteMatches [['pident', 'length']].mean() ## 95.0%, 734
chinaMatches[['pident', 'length']].mean() ## 93.6%, 333

## overall picture:

nostocMatches[['sseqid', 'pident', 'length']].groupby('sseqid').mean()

nostocMatches[['pident', 'length']].mean() ## 94.4%, 577 bp

## strategy here would be to extract each, make an alignment and consensus from 
## each and then compare

## ashitsuki Matches

## let's get a reference sequence, the PCC nostoc punctiforme sequence from NCBI (AF027655):

vim nostocPunctRefSeq.fasta
seqtk seq -l 0 nostocPunctRefSeq.fasta  > nostocPunctRefSeq_noLB.fasta
#mv nostocPunctRefSeq_noLB.fasta nostocPunctRefSeq.fasta 
## this might be useful for all alignments, put it somewhere
#mv nostocPunctRefSeq.fasta  /media/vol1/daniel/nostoc/ourNostocMSA/

refNostoc=/media/vol1/daniel/nostoc/ourNostocMSA/nostocPunctRefSeq.fasta

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11
#cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11
grep "AB511947.1.1445" barcode11_nostocMatches.csv | cut -d , -f 1 > barcode11_ashitsuki_nostocReadNames.txt
grep "FR798940.1.1463" barcode11_nostocMatches.csv | cut -d , -f 1 > barcode11_concrete_nostocReadNames.txt
grep "KF037277.1.1457" barcode11_nostocMatches.csv | cut -d , -f 1 > barcode11_China_nostocReadNames.txt
## as noted below in alignments, we have a chimeric read in the ashitsuki reads:
#grep ae9a27e6-1dfe-4513-b39f-997724c75732 barcode11_ashitsuki_nostocReadNames.txt
sed -i '/ae9a27e6-1dfe-4513-b39f-997724c75732/d' barcode11_ashitsuki_nostocReadNames.txt 
## and maybe this one, too. It may be cause a big gap in the alignment:
#grep 53fc4d0f-e611-43ac-b382-2ca69b9c1a67 barcode11_ashitsuki_nostocReadNames.txt
#sed -i '/ae9a27e6-1dfe-4513-b39f-997724c75732/d' barcode11_ashitsuki_nostocReadNames.txt 
## get these into a fasta:

allReads=2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fasta
seqtk subseq $allReads barcode11_ashitsuki_nostocReadNames.txt > barcode11_nostoc_ashitsuki.fasta
seqtk subseq $allReads barcode11_concrete_nostocReadNames.txt > barcode11_nostoc_concrete.fasta
seqtk subseq $allReads barcode11_China_nostocReadNames.txt > barcode11_nostoc_China.fasta
## get rid of crazy nanopore names
sed -i -r "s/^>([^ ]*).*/>concrete_\1/" barcode11_nostoc_concrete.fasta
sed -i -r "s/^>([^ ]*).*/>china_\1/" barcode11_nostoc_China.fasta 
sed -i -r "s/^>([^ ]*).*/>ashitsuki_\1/" barcode11_nostoc_ashitsuki.fasta
## keep just the first words:
for i in barcode*fasta; do
  sed -i -r "s/^(>[^-]*).*/\1/" $i
done
## and how do we get the blast match that seeded each of these?
#esearch -db "Nucleotide" -query "AB511947.1" | efetch -format "fasta" > AB511947.fasta
#esearch -db "Nucleotide" -query "FR798940.1" | efetch -format "fasta" > FR798940.fasta
#esearch -db "Nucleotide" -query "KF037277.1" | efetch -format "fasta" > KF037277.fasta
#seqtk seq -l 0 AB511947.fasta  > AB511947_noLB.fasta; mv AB511947_noLB.fasta AB511947.fasta 
#seqtk seq -l 0 FR798940.fasta  > FR798940_noLB.fasta; mv FR798940_noLB.fasta FR798940.fasta 
#seqtk seq -l 0 KF037277.fasta  > KF037277_noLB.fasta; mv KF037277_noLB.fasta KF037277.fasta 
cat AB511947.fasta barcode11_nostoc_ashitsuki.fasta > temp
mv temp barcode11_nostoc_ashitsuki.fasta 
cat FR798940.fasta barcode11_nostoc_concrete.fasta > temp
mv temp barcode11_nostoc_concrete.fasta
cat KF037277.fasta barcode11_nostoc_China.fasta > temp
mv temp barcode11_nostoc_China.fasta
## get rid of long headers:
sed -i -r "s/(>AB511947.1 Nostoc verrucosum).*/\1/" barcode11_nostoc_ashitsuki.fasta 
sed -i -r "s/(>FR798940.1 Nostoc).*/\1 from stagnant water and concrete/" barcode11_nostoc_concrete.fasta
sed -i -r "s/(>KF037277.1).*/\1 Chinese soil bacteria/" barcode11_nostoc_China.fasta 
## how do we add in our reference nostoc?
for i in barcode11*fasta; do
  cat $refNostoc $i > temp
  sed -i -r "s/(>AF027655.1).*/\1/" temp
  mv temp $i
done
sed -i -r "s/(>AF027655)\.1.*/\1_ashitsuki/" barcode11_nostoc_ashitsuki.fasta 
sed -i -r "s/(>AF027655)\.1.*/\1_China/" barcode11_nostoc_China.fasta
sed -i -r "s/(>AF027655)\.1.*/\1_concrete/" barcode11_nostoc_concrete.fasta

grep "^>" barcode11_nostoc_ashitsuki.fasta | head -5
grep "^>" barcode11_nostoc_concrete.fasta | head -5
grep "^>" barcode11_nostoc_China.fasta | head -5


## for each, do an alignment, may be useful
for i in barcode11_nostoc_ashitsuki.fasta barcode11_nostoc_concrete.fasta barcode11_nostoc_China.fasta; do
  echo $i
  muscle -in $i -out ${i/.fasta/.afa} &
done


## and combine them, just to see what this looks like:

#muscle -profile -in1 barcode11_nostoc_ashitsuki.afa -in2 barcode11_nostoc_concrete.afa -out muscleMSA_barcode11_ashitsuki_concrete.afa
#muscle -profile -in1 muscleMSA_barcode11_ashitsuki_concrete.afa -in2 barcode11_nostoc_China.fasta -out muscleMSA_barcode11_ashitsuki_concrete_China.afa 
## this fails. Why? Probably the length (columns) of the alignment being different. 
## maybe try combining the smaller read files (concrete and china) into a single alignment, 
## then combine:

## so lumping the concrete and China reads.
cat barcode11_nostoc_concrete.fasta barcode11_nostoc_China.fasta > barcode11_nostoc_concreteChina.fasta
muscle -in barcode11_nostoc_concreteChina.fasta -out barcode11_nostoc_concreteChina.afa 
muscle -profile -in1 barcode11_nostoc_ashitsuki.afa -in2 barcode11_nostoc_concreteChina.afa -out muscleMSA_barcode11_ashitsuki_concreteChina.afa
## and the reverse, let's lump the  ashitsuki and the china reads, to test the effect of order here:
cat barcode11_nostoc_ashitsuki.fasta barcode11_nostoc_China.fasta > barcode11_nostoc_ashitsukiChina.fasta
muscle -in barcode11_nostoc_ashitsukiChina.fasta -out barcode11_nostoc_ashitsukiChina.afa 
muscle -profile -in1 barcode11_nostoc_ashitsukiChina.afa -in2 barcode11_nostoc_concrete.afa -out muscleMSA_barcode11_ashitsukiChina_concrete.afa
## and one big one, of all three blast clusters:
cat barcode11_nostoc_ashitsuki.fasta barcode11_nostoc_concrete.fasta barcode11_nostoc_China.fasta > \
  barcode11_nostoc_ashitsukiConcreteChina.fasta
muscle -in barcode11_nostoc_ashitsukiConcreteChina.fasta -out barcode11_nostoc_ashitsukiConcreteChina.afa


## move these and the other alignments, to keep things organized
mv *afa /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/

## and get this local
getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/

/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11

## looking at this, the alignment is way too long. 
## found chimeric read:
ae9a27e6-1dfe-4513-b39f-997724c75732

## and maybe these ones too:
grep 53fc4d0f-e611-43ac-b382-2ca69b9c1a67 /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/*
grep 33c27d17-b529-4e46-9fe9-c82b296ca335 /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/*
## but hold onto these for a minute

## rerun the above pipeline excluding this read...

## these are cleaner alignments, let's make trees to see if we are seeing what 
## we think we are seeing.

#cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/
cd /media/vol1/daniel/nostoc/16sTree/round2/barcode11

alignDir=/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/
alignment=muscleMSA_barcode11_ashitsuki_concreteChina.afa
FastTree -gtr -nt < ${alignDir}/${alignment} > barcode11_Nostoc_ashitsuki_concreteChina.nwk
alignment=muscleMSA_barcode11_ashitsukiChina_concrete.afa
FastTree -gtr -nt < ${alignDir}/${alignment} > muscleMSA_barcode11_ashitsukiChina_concrete.nwk
alignment=barcode11_nostoc_ashitsukiConcreteChina.afa
FastTree -gtr -nt < ${alignDir}/${alignment} > muscleMSA_barcode11_ashitsukiChinaconcrete.nwk

getFile="/media/vol1/daniel/nostoc/16sTree/round2/barcode11/"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/

## they are somehow very different. There is a strong effect, it looks like whichever alignments 
## are made together tend to stay together. Maybe the "profile" tool in muscle is inappropriate here.
## I guess the last thing to try to align them all, while we work on getting a nif database,
## is to let one large align run with all reads, labeled according to their blast cluster. 

## oh god, this is a mess.  

## try SINA 1.7?

apt search SINA ## nope

## here:
https://github.com/epruesse/SINA
https://sina.readthedocs.io/en/latest/

## let's make a conda environment for this:

conda activate sina

## we need an arb-formatted DB. Can we use the cyanoseq or cydrasil databases for this?

## cyanoseq, v1.2 (v6 doesn't have the alignment on their zenodo?)

cd /media/vol1/daniel/nostoc/16sTree/cyanoSeq

wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2.fasta


## try conversion to arb format:
sina -i CyanoSeq_1.2.fasta -o CyanoSeq_1.2.arb --prealigned

## try a simple alignment:

## let's try our barcode 11 sequences. First, what happens if we give it 
## all of our nostoc sequences, not divided up by blast-matches 

## all nostoc matches from barcode11 are here:

cd /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11

fasta="barcode11_nostoc_ashitsuki.fasta"
blastoutDir="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11"
#ls ${blastoutDir}/${fasta}
#seqtk seq -A $fastq  > $fasta
sina \
  -i ${blastoutDir}/$fasta \
  -o ${fasta/\.fasta/aligned_cyanoseq.afa} \
  --db CyanoSeq_1.2.arb &> log.txt

## tried to use the --overhang= option but appears to be broken. hanging sequences are causing 
## problems with hmmer below...manually remove them?

## lots of errors (https://github.com/epruesse/SINA/issues/110). let's see how it worked, anyway.

mv ${fasta/\.fasta/aligned_cyanoseq.afa} /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/

## on local ##
#getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_onlyNostocaligned_cyanoseq.afa"
getFile="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_nostoc_ashitsukialigned_cyanoseq.afa"
rsync -auv test@132.180.112.115:${getFile} /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/
cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/
## ^on local^ ##

## looks promising, let's try it with the blast-clusters, maybe just the most numerous. Modified above.
## though as mentioned, hanging sequences are causing problems. Also, the reference sequences that I "spiked-in"
## removed the hanging base that offended hmmer, and also the reference AB511947 nostoc verrucosa sequence

########## consensus sequence #########

## as far as getting a consensus sequence, maybe take an HMM approach?
## e.g. https://medium.com/@sepo7/generating-a-consensus-sequence-from-a-profile-hmms-with-hmmer-python-506ed13f26ad

alignDir="/media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11"
alignFile="barcode11_nostoc_ashitsukialigned_cyanoseq.afa"
hmmbuild barcode11_ashitsuki.hmm ${alignDir}/${alignFile}

## at first, received an error:
#Alignment input parse error:
#   sequence ashitsuki_c259e768 has alen 1461; expected 1460
#   while reading aligned FASTA file /media/vol1/daniel/nostoc/ourNostocMSA/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_nostoc_ashitsukialigned_cyanoseq.afa
#   at or near line 493
## manually removed this base as mentioned above

## and ask for a "plurality" type consensus:
hmmemit -c -o barcode11_nostoc_ashitsuki_16s_consensus.fasta barcode11_ashitsuki.hmm

## RNA to DNA
sed -i '/^[^>]/ y/uU/tT/' barcode11_nostoc_ashitsuki_16s_consensus.fasta 
mv barcode11_nostoc_ashitsuki_16s_consensus.fasta  /media/vol1/daniel/nostoc/consensusSequences/OGzygodon_nostoc_16s_consensus.fasta  


## and is this our consensus seq?
## it's our best guess. There may be one or two other strains in there, by the 
## other "blast clusters", but this may also be noise from the sequencer.
## hard to say.

## perhaps we are not letting the data speak for itself here...maybe back up, 
## filter to only high-scoring, long matches to any nostoc,
## then align and make a tree. Make a consensus sequence for any large branch 
## on the tree, realigning and hmmer.

## so, where to start... 


cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11

## clean up a little, for redoing these sequences
#find . -type f -newermt "1 month ago" -exec rm {} \;

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os, re

os.getcwd()

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11')

nostocMatches = pd.read_csv('barcode11_nostocMatches.csv', index_col='qseqid')
## all of these have been id'd to nostoc, so get rid of taxonomy
nostocMatches['sseqid'] = nostocMatches['sseqid'].str.split(';', expand=True)[[0]]

nostocMatches.head()

pd.set_option('display.max_rows', None)


aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## 

nostocMatches.query("bitscore > 600").shape

(nostocMatches.query("bitscore > 600")[['sseqid','evalue']]
        .groupby('sseqid')
        .count()
        .T.iloc[0,:]
        .sort_values(ascending=True))

## we have three top hits, with 322, 157, and 44 strong matches. Extract just these reads into a fasta: 

minBitscore = 900 ## with these AA/nt blast matches, the bitscores are much lower.


nostocMatches.query(f"bitscore > {minBitscore}").shape ## 449 seqs

strongMatches = nostocMatches.query(f'bitscore > {minBitscore}')

wantedReads=strongMatches.reset_index().qseqid

rawReadsBarcode = ("/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/"
                   "OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/"
                   "2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode11.fastq")

os.path.exists(rawReadsBarcode)

highBits=[]
for rec in SeqIO.parse(rawReadsBarcode, "fastq"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)

len(highBits) ## 449 reads, makes sense

## write this out as a fasta?:
SeqIO.write(highBits, "Barcode11_strongNostocMatches.fa", "fasta")

## when I'm back on this, align these, make a tree, see if some obvious groupings emerge.  

## back literally a month later, 16.9.2025

## how shall we make a tree with this?

## try the old-fashioned way first, muscle and fast-tree. I don't think
## an aligner for 16s is appropriate here, given all the errors that 
## are probably in these. We are trying to find consensus sequences,
## not yet trying to place on a phylogenetic tree.

## re-orient these:

silvaDB=/media/vol1/daniel/databases/silva/dada2silva/silva_nr99_v138.2_toGenus_trainset.fa
vsearch \
   --orient Barcode11_strongNostocMatches.fa \
   --db $silvaDB \
   --fastaout  barcode11_strongNostocMatches_oriented.fa \
   --notmatched barcode11_strongNostocMatches_NotOriented.fa 


mv Barcode11_strongNostocMatches_oriented.fa barcode11_strongNostocMatches_oriented.fa 

muscle5 -align barcode11_strongNostocMatches_oriented.fa -output barcode11_strongNostocMatches.afa 2> muscle.log &
## took ~45 minutes

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11


alignment="barcode11_strongNostocMatches.afa"
FastTree -gtr -nt < ${alignment} > barcode11_strongNostocMatches.nwk

## 5 min

## check it out

arb 

## don't see a clean break anywhere, let's treat it as one clade
getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_strongNostocMatches.afa"
putItHere="/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/"
rsync -auv test@132.180.112.115:$getFile $putItHere

cd /home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode11/

## when I left, ugene was stuck getting rid of vertical gaps
## maybe find a more efficient way to do this. 

## try installing cialign:
conda create -n cialign -c bioconda cialign

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11/

cp barcode11_strongNostocMatches.afa barcode11_strongNostocMatches.afa.bk

conda activate cialign

CIAlign --infile barcode11_strongNostocMatches.afa \
        --outfile_stem barcode11_strongNostocMatches_msaEdits \
        --insertion_min_perc 0.7 \
        --insertion_min_flank 1 \
        --insertion_min_size 1 \
        --insertion_max_size 400 \
        --remove_insertions 


getFile="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11/barcode11_strongNostocMatches_msaEdits_cleaned.fasta"
putItHere="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/alignmentsBC11/"
rsync -auv test@132.180.112.115:$getFile $putItHere

## do some trimming etc with ugene 

getFile="/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/alignmentsBC11/barcode11_strongNostocMatches_msaEdits_cleaned_handEdited.afa"
putItHere="/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode11/"
rsync -auv $getFile test@132.180.112.115:$putItHere

## get consensus out:
mv barcode11_strongNostocMatches_msaEdits_cleaned_handEdited.afa Barcode11_strongNostocMatches_handEdited.afa

alignFile="Barcode11_strongNostocMatches_handEdited.afa"
finalFileName="Zygodon_Nostoc_BC11_16s.fa"
hmmbuild ${alignFile/_handEdited\.afa/\.hmm} ${alignFile}
hmmemit -c -o $finalFileName ${alignFile/_handEdited\.afa/\.hmm}
sed -i "/>/ s/>.*/>${finalFileName%\.fa}/" ${finalFileName}
seqtk seq -l 0 ${finalFileName} > ${finalFileName}.tmp
mv ${finalFileName}.tmp ${finalFileName}

cp Zygodon_Nostoc_BC11_16s.fa /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/


## that seems like the best pipeline. To review:

## 1 - pull out all sequences with very high bit-score blasts
##     to some kind of nostoc
## 2 - align them with muscle
## 3 - build a tree with fasttree, unrooted
## 4 - plot the tree, take the obvious groupings as individual strains, 
## 5 - if more than one align these clades each individually with muscle
## 6 - build an HMM  for each
## 7 - predict a consensus sequence from each HMM

## let's go back and apply this to our other barcodes, and maybe our original 
## nostoc data, see how it looks. 

################# 16s tree #####################

## cydrasil is getting out of date...
## I think we have a tree we can use from cyanoseq here:

wget https://zenodo.org/records/13910424/files/Nostocales.fasta

wget https://zenodo.org/records/13910424/files/Nostocales.txt

## arb accepts these. Even though the fasta is unaligned. 
wget https://zenodo.org/records/13910424/files/CyanoSeqV1.3_GSRDB_sequences.fasta
## also not aligned. Ugh. 

## maybe we have to download the whole database to get alignments?:
wget https://zenodo.org/records/13910424/files/CyanoSeqV1.3_sequences.fasta
## but these don't appear aligned, either.


## another would be to use silva. Nostoc is pretty non-controversial, I guess?
wget https://www.arb-silva.de/fileadmin/silva_databases/release_138_2/ARB_files/SILVA_138.2_SSURef_NR99_03_07_24_opt.arb.gz
## works, but complex. 

## nostocs hanging all over the place, nostocaceae paraphyletic. 
## I'm not qualified to evaluate...

## okay, as noted above, maybe we can use the previous version of 
## cyanoseq for hanging sequences:

## alignment:
wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2.fasta

## tree is here:
wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2_newick.txt

## this looks promising. Now to hang some of our sequences on it...

## we need a concatenated fasta of all of our 16s consensus sequences

cat /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*fa > all16sConsensusSeqs.fa

## try following this tutorial for epa-ng:
https://github.com/pierrebarbera/epa-ng/wiki/Full-Stack-Example

conda remove -n epa-ng --all

conda create -n epa-ng

conda activate epa-ng

conda install bioconda::epa-ng


## they recommend PaPaRa for aligning our reads to the tree:
wget https://cme.h-its.org/exelixis/resource/download/software/papara_nt-2.5-static_x86_64.tar.gz
tar -xvf papara_nt-2.5-static_x86_64.tar.gz
sudo mv papara_static_x86_64 /opt
sudo ln -s /opt/papara_static_x86_64 /usr/local/bin/papara

cd /media/vol1/daniel/nostoc/16sTree/round2

cp CyanoSeq_1.2.fasta CyanoSeq_1.2_accessionsEdited.fa


##  because the alignment is in afa (fasta), should be in phylip 
## (https://www.garcia-pichellab.com/cydrasil/, https://github.com/sim82/papara_nt)

## try the conversion with biopython 
## (https://bioinformatics.stackexchange.com/questions/19626/how-to-convert-fasta-alignment-to-nexus-or-phylip-format)

wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2.fasta



cd /media/vol1/daniel/nostoc/16sTree/round2/

python3
from Bio import AlignIO
from pathlib import Path
from Bio.AlignIO.PhylipIO import SequentialPhylipWriter
import re, os
file = 'CyanoSeq_1.2.fasta'
pathway = '/media/vol1/daniel/nostoc/16sTree/round2/'
alignment = AlignIO.read(Path(pathway, file), 'fasta')
# write out in relaxed phylip
fileoutphy = re.sub('fasta', 'phy', file)
with open(Path(pathway, fileoutphy), 'w') as output_handle:        
    SequentialPhylipWriter(output_handle).write_alignment(alignment, id_width=120)


## need a long id_width, they made some serious ids in cyanoseq


TREE="CyanoSeq_1.2_tree_noNHX.nw"
REF_MSA="CyanoSeq_1.2.phy"
QRY="all16sConsensusSeqs.fa"
papara -t $TREE -s $REF_MSA -q $QRY -r -n "Cyanoseq_with_OGzygodonNostocs"

## first epa-ng attempt below gives a tree parsing error. Try some editing?
## (https://github.com/pierrebarbera/epa-ng/issues/42)

sed -e 's/\[[^][]*\]//g' CyanoSeq_1.2_newick.txt > CyanoSeq_1.2_tree_noNHX.nw

conda activate epa-ng

epa-ng --redo --split $REF_MSA papara_alignment.Cyanoseq_with_OGzygodonNostocs


TREE="CyanoSeq_1.2_tree_noNHX.nw"
REF_MSA="reference.fasta"
QRY="query.fasta"
INFO="GTR{0.7/1.8/1.2/0.6/3.0/1.0}+FU{0.25/0.23/0.30/0.22}+G4{0.47}"
OUT="."
epa-ng \
  --tree $TREE \
  --ref-msa $REF_MSA \
  --query $QRY \
  --out-dir $OUT \
  --redo \
  --model $INFO

## that seems to work. Need to:
## - get the right evolutionary models 
## - rerun with all of our consensus sequences, 
## - then check on iTol

## - get the right evolutionary models:
## the cyanoseq folks used ModelTest-NG
## https://github.com/ddarriba/modeltest

## install ModelTest-NG:
wget https://github.com/ddarriba/modeltest/files/3790700/modeltest-ng-0.1.6-static-linux64.tar.gz 
tar -xvf modeltest-ng-0.1.6-static-linux64.tar.gz 
sudo mv modeltest-ng-static /opt
sudo ln -s /opt/modeltest-ng-static /usr/local/bin/modeltest-ng

modeltest-ng

## to test this out:
modeltest-ng -i tiny.fas -h uigf -f ef
wget https://github.com/ddarriba/modeltest/raw/refs/heads/master/example-data/dna/tiny.fas

## so for our data?
nohup \
modeltest-ng \
  -i CyanoSeq_1.2.fasta \
  --utree CyanoSeq_1.2_tree_noNHX.nw \
  -h uigf \
  -f ef &

## we need something that looks like this:
INFO="GTR{0.7/1.8/1.2/0.6/3.0/1.0}+FU{0.25/0.23/0.30/0.22}+G4{0.47}"
## though, the paper for cyanseq just reports GTR+I+G4

cd /media/vol1/daniel/nostoc/16sTree/round2



## okay, 
## let's see. Use this combo fasta, repeat above pipeline:

cd /media/vol1/daniel/nostoc/16sTree/round2

TREE="CyanoSeq_1.2_tree_noNHX.nw"
REF_MSA="CyanoSeq_1.2.phy"
QRY="all16sConsensusSeqs.fa"
papara -t $TREE -s $REF_MSA -q $QRY -r -n "Cyanoseq_with_ourMossNostocs"

conda activate

epa-ng --redo --split $REF_MSA papara_alignment.Cyanoseq_with_ourMossNostocs

TREE="CyanoSeq_1.2_tree_noNHX.nw"
REF_MSA="reference.fasta"
QRY="query.fasta"
INFO="GTR+I+G4"
OUT="."
epa-ng \
  --tree $TREE \
  --ref-msa $REF_MSA \
  --query $QRY \
  --out-dir $OUT \
  --redo \
  --model $INFO

mv epa_result.jplace cyanoseqWithNostocConsensusPlacements.jplace

cd /media/vol1/daniel/nostoc/16sTree/round2

cp cyanoseqWithNostocConsensusPlacements.jplace /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cyanseqTree_placements/ 

## ok, how to visualize this? The cydrasil folks use iTOL, as we did above:

getFile=/media/vol1/daniel/nostoc/16sTree/round2/cyanoseqWithNostocConsensusPlacements.jplace
putItHere=/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/16sTreeDrafts/
rsync -auv test@132.180.112.115:$getFile $putItHere

## placements are the same, but the confidences of the placements are higher

## arb? or itol?
## use iTOL to find the placements, use arb to generate the tree graphic.

## we have two subtrees from cyanoseq, rooted and unrooted. 
## they will probably be edited, but for now keep them in the repo:

cp nostocaceaeCyanseq_rooted.svg /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cyanseqTree_placements/
cp nostocaceaeCyanseq_unrooted.svg /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cyanseqTree_placements/

## looking at this, I see very few nostocs. Maybe cyanoseq wasn't the way to go here?
## It looks there are only two confirmed Nostocs. Ugh. Should have checked this 
## months ago. 

## how does this compare to cydrasil3?


## cydrasil has 41 nostocs

## on the other hand, they do not have compactonostoc, 
## which is the most likely home of our zygodon nostoc

## how do we resolve this? How about both? Subset to Nostocaceae in both,
## show placements in both. 

## so can we 1 - repeat the above placements onto the cydrasil tree
## and       2 - export subtrees of nostocaceae using ARB?

## placements on cydrasil tree:


## get an evolutionary model for the cydrasil tree:

modeltest-ng --help

cd /media/vol1/daniel/nostoc/16sTree/cydrasil_tree

cydrasilAlignment=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/Cydrasil-v3-reference-alignment.afa
cydrasilTree=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/cydrasil-v3-reference-tree.nwk
modeltest-ng \
  -i $cydrasilAlignment \
  --utree $cydrasilTree \
  -h uigf \
  -f ef

## standard GTR+I+G4 seems to work


cat /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*fa > all16sConsensusSeqs.fa

## oops, need phylip for papara
cydrasilAlignmentPhylip=/media/vol1/daniel/nostoc/16sTree/cydrasil_repo/Cydrasil-v3-reference-alignment.phy
papara -t $cydrasilTree -s $cydrasilAlignmentPhylip -q all16sConsensusSeqs.fa -r -n "Cydrasil_with_ourMossNostocs"


conda activate epa-ng

epa-ng --redo --split $cydrasilAlignment papara_alignment.Cydrasil_with_ourMossNostocs

TREE=$cydrasilTree
REF_MSA="reference.fasta"
QRY="query.fasta"
INFO="GTR+I+G4"
OUT="."
epa-ng \
  --tree $TREE \
  --ref-msa $REF_MSA \
  --query $QRY \
  --out-dir $OUT \
  --redo \
  --model $INFO

mv epa_result.jplace cydrasilWithNostocConsensusPlacements.jplace
cp cydrasilWithNostocConsensusPlacements.jplace /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cydrasilTree_placements 

getFile=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cydrasilTree_placements/cydrasilWithNostocConsensusPlacements.jplace
putItHere=/home/daniel/Documents/projects/mossSymbiosis/trees4itol/
rsync -auv test@132.180.112.115:$getFile $putItHere

## okay, there is more precision with that. Hopefully there is time for pretty 
## graphic making on monday

## but as I feared, compactonostoc isn't in there. Cydrasil is out of date. 
## we have a bunch of new sequences from the cyanoseq folks. We can try 
## to make a tree with these. 

########### new nostoc sequences from cyanoseq folks ###########

## best to use a ssu-aware aligner. 
## additional, curated sequences from cyanoseq, given to me 
## because I complained they don't have enough Nostoc.
## It's here:  
ls /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/refDatabases

## question - better to place them on the existing cyanoseq tree, or 
##            to do denovo tree?

## my instinct is to hang them on the existing tree provided by
## cyanoseq.
## if it looks funny, then try a denovo tree. 

## how to do this? 

## add our consensus 16s seqs to their extra nostocs:

cd /media/vol1/daniel/nostoc/16sTree/cyanoseq_plus

## they're here:
ls /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/refDatabases/NOSTOC_fromCyanoseqFolks.fasta

ls /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences

cat \
 /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/refDatabases/NOSTOC_fromCyanoseqFolks.fasta \
 /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*.fa |
 seqtk seq -l 0 > cyanoseqExtraNostocs_ours.fa

rm papara_log.Cyanoseq_with_ourMossNostocs
TREE="/media/vol1/daniel/nostoc/16sTree/round2/CyanoSeq_1.2_tree_noNHX.nw"
REF_MSA="/media/vol1/daniel/nostoc/16sTree/round2/CyanoSeq_1.2.phy"
QRY="cyanoseqExtraNostocs_ours.fa"
nohup papara -t $TREE -s $REF_MSA -q $QRY -r -n "Cyanoseq_with_ourMossNostocs" &

## this gives us a phylip file with a new alignment:
less papara_alignment.Cyanoseq_with_ourMossNostocs

conda activate

epa-ng --redo --split $REF_MSA papara_alignment.Cyanoseq_with_ourMossNostocs

REF_MSA="reference.fasta"
QRY="query.fasta"
INFO="GTR+I+G4"
OUT="."
epa-ng \
  --tree $TREE \
  --ref-msa $REF_MSA \
  --query $QRY \
  --out-dir $OUT \
  --redo \
  --model $INFO

mv epa_result.jplace cyanoseqPlusWithNostocConsensusPlacements.jplace

## put in the repo:
cp cyanoseqPlusWithNostocConsensusPlacements.jplace /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cyanseqTree_placements/ 

## looking at the in iTol, it's not that useful. We need to incorporate the
## extra reference sequences first, then use that as a new tree to 
## hang our consensus seqs. 

## redo the above, without the consensus seqs:

cd /media/vol1/daniel/nostoc/16sTree/cyanoseq_plus

conda activate epa-ng

## make the new alignment with the extra nostoc sequences:

TREE="/media/vol1/daniel/nostoc/16sTree/round2/CyanoSeq_1.2_tree_noNHX.nw"
REF_MSA="/media/vol1/daniel/nostoc/16sTree/round2/CyanoSeq_1.2.phy"
QRY=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/refDatabases/NOSTOC_fromCyanoseqFolks.fasta
nohup papara -t $TREE -s $REF_MSA -q $QRY -r -n "CyanoseqNostocPlus" &

## make the new tree with the extra nostoc sequences:
epa-ng --redo --split $REF_MSA papara_alignment.CyanoseqNostocPlus

REF_MSA="reference.fasta"
QRY="query.fasta"
INFO="GTR+I+G4"
OUT="."
epa-ng \
  --tree $TREE \
  --ref-msa $REF_MSA \
  --query $QRY \
  --out-dir $OUT \
  --redo \
  --model $INFO

mv epa_result.jplace cyanoseqPlus.jplace


## we want to accept the placements and use this as a new tree. 
## looks like we want gappa tools to do the conversion
https://github.com/lczech/gappa/wiki/Subcommand:-graft

#conda create -n gappa bioconda::gappa

conda activate gappa

gappa examine graft \
  --jplace-path cyanoseqPlus.jplace \
  --fully-resolve \
  --log-file "gappaLog.txt" \
  --threads 10

## that worked, but to play around in arb we may need a fasta version
## of the Phylip. 

## formatting issues - dots in the phylip. Not sure what do...
## leave it for the moment


## for now can we use this and the papara phylip file for 
## another cycles of placements, this time just our consensus seqs?:

cd /media/vol1/daniel/nostoc/16sTree/cyanoseq_plus

cat /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*.fa |
 seqtk seq -l 0 > our16SconsensusSeqs.fa

## make alignment that includes our consensus sequences
rm papara_log.CyanoseqNostocPlus_our16s
TREE="cyanoseqPlus.newick"


QRY="our16SconsensusSeqs.fa"
papara -t $TREE -s $REF_MSA -q $QRY -r -n "CyanoseqNostocPlus_our16s" 

conda activate epa-ng

REF_MSA="papara_alignment.CyanoseqNostocPlus"
epa-ng --redo --split $REF_MSA papara_alignment.CyanoseqNostocPlus_our16s

## works. Now, hang our query sequences on the cyanoseqnostocPlus:

INFO="GTR+I+G4"
OUT="."
epa-ng \
  --tree $TREE \
  --ref-msa "reference.fasta" \
  --query "query.fasta" \
  --out-dir $OUT \
  --redo \
  --model $INFO

mv epa_result.jplace cyanoseqPlus_our16s.jplace

cp cyanoseqPlus_our16s.jplace /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cyanseqTree_placements/ 

cd /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/16sTree/cyanseqTree_placements/ 

## and that works, but looks really weird. I think trying to sneak two rounds of 
## secondary placements didn't really work. 

## so plan B was build a nostaceae / nostoc tree, include our 16s in it. 
## but there is a middle ground we can try, SINA uses existing alignments
## and isn't a "placement" program, it claims to produce rigorous 
## 16s-sensitive new alignments that combine the old and new seqs. 

## so try this with sina:

cd /media/vol1/daniel/nostoc/16sTree/cyanoseq_plus

## a long time ago above around line 3050, created an arb database from cyanseq
## this is here:
ls -l /media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.arb


## remake a combo fasta of the new cyanoseqNostocs and our consensus seqs:
cat \
 /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/refDatabases/NOSTOC_fromCyanoseqFolks.fasta \
 /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*.fa |
 seqtk seq -l 0 > cyanoseqExtraNostocs_ours.fa

## for testing, just our consensus seqs alone:
cat \
 /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*.fa |
 seqtk seq -l 0 > our16s.fa

conda activate sina

cd /media/vol1/daniel/nostoc/16sTree/cyanoSeq

sina \
  -i /media/vol1/daniel/nostoc/16sTree/cyanoseq_plus/cyanoseqExtraNostocs_ours.fa \
  -o cyanoseqExtraNostocsOur16S.afa \
  --db CyanoSeq_1.2.arb &> log.txt

## not working. Pertinent: https://github.com/epruesse/SINA/issues/110
## what if we just use our seqs:

sina \
  -i  our16s.fa \
  -o testOur16S.afa \
  --db CyanoSeq_1.2.arb 

## also basically a fail

## might be a length issue. The cyanoseq alignment is 1460 bp per line
## our seqs

vim -M /media/vol1/daniel/nostoc/16sTree/cyanoseq_plus/cyanoseqExtraNostocs_ours.fa 
## there are many (most?) that are longer. Perhaps this is the problem?


grep WY1KK1_clone_4_EU586733.1

grep WY1KK1_clone_4_EU586733.1 /media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.fasta

less /media/vol1/daniel/nostoc/16sTree/cyanoSeq/CyanoSeq_1.2.ARF

cd /media/vol1/daniel/nostoc/16sTree/cyanoSeq/

## doesn't work, arb can't find sequences
## ugh, nothing works.
## what now?

## can sina handle denovo alignments?

sina \
  -i cyanoseqExtraNostocs_ours.fa \
  -o cyanoseqExtraNostocsOur16S.afa

## nope.

cd /media/vol1/daniel/nostoc/16sTree/cyanoSeq

## okay. Last resort, we align denovo

## 1. the existing nostacaceae sequences from cyanoseq, 
## 2. the new nostoc sequences from the cyanoseq fellows:
## 3. our consensus sequences. 

## 1. the existing nostacaceae sequences from cyanoseq...
## cyanoseq 1.2 tree is here:

ls /media/vol1/daniel/nostoc/16sTree/cyanoSeq

## question - are existing nostacaceae sequences from cyanoseq also in the
## the "additional sequences" that were given to me?:

grep -c MH598843 CyanoSeq_1.2* ## in there
grep MH598843 NOSTOC_fromCyanoseqFolks.fasta ## not in there

## so these are likely completely new sequences

## we need an alignment and tree because we can't really estimate the 
## bounds of nostocaceae otherwise

cd /media/vol1/daniel/nostoc/16sTree/cyanoSeq

wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2.fasta
wget https://zenodo.org/records/7864137/files/CyanoSeq_1.2_newick.txt

arb ## select what I think is nostocaceae (also includes nodulariaceae??)

## exports as RNA (formatted the original arb db as RNA, mistake)
## sed??
sed "/^[^>]/ s/U/T/g" nostocaceae_maybe.fasta |
sed "/^[^>]/ s/ //g" | sed "/>/ s/ .*//g" |
seqtk seq -l 0 > nostocaceae_maybe_cleaned.fa

## this is saved here:
cyanoseqNostocaceae=/media/vol1/daniel/nostoc/16sTree/cyanoSeq/nostocaceae_maybe_cleaned.fa
## 2. the new nostoc sequences from the cyanoseq fellows:
extraNostocs=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/refDatabases/NOSTOC_fromCyanoseqFolks.fasta
## 3. our consensus sequences. They're in here: 
ourSeqs=/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/16s/consensusSequences/*.fa

## do the work here:
cd /media/vol1/daniel/nostoc/16sTree/nostocaceae_cyanoseq

cat $cyanoseqNostocaceae $extraNostocs $ourSeqs |
seqtk seq -l 0 > seqs2alignNostocaceae.fa


## looks like a gap "-" or two somehow made it into my consensus
## sequence for ambylostegium nostoc 16S
## removed it with sed:

sed -i "/^[^>]/ s/-//g" seqs2alignNostocaceae.fa

## also there is some weirdness in the nostoc file from the cyanoseq boys, 
## removing it here:
grep -A 1 MT514711.1 seqs2alignNostocaceae.fa | grep "MT.NSTCS.CCC.S.*"
sed -i "s/MT\.NSTCS\.CCC.S.*//g" seqs2alignNostocaceae.fa

## and in this sequence also:
grep -A 1 KF718455 seqs2alignNostocaceae.fa | grep K\.NSTCS\.TGRAS\.DCYANB
## removing it here
sed -i "s/K\.NSTCS\.TGRAS\.DCYANB.*//g" seqs2alignNostocaceae.fa

## and here
grep -A 1 JQ776451 seqs2alignNostocaceae.fa | grep \.NCTRDCYANBACT
## removing it here
sed -i "s/\.NCTRDCYANBACT.*//g" seqs2alignNostocaceae.fa

## and here
grep -A 1 JF810611 seqs2alignNostocaceae.fa | grep .NSTCS.M.SSRBSMARNAGNAR
sed -i "s/\.NSTCS\.M\.SSRBSMARNAGNAR.*//g" seqs2alignNostocaceae.fa

## align with SSU-aligner
conda activate ssu-align 

nohup ssu-align -n bacteria seqs2alignNostocaceae.fa nostocaceaeCyanoseqPlusOurSeqs_ali &
ssu-mask --pf 0.9999 --pt 0.9999 nostocaceaeCyanoseqPlusOurSeqs_ali
ssu-mask --stk2afa nostocaceaeCyanoseqPlusOurSeqs_ali

## okay make a tree:

nostocAlignment=/media/vol1/daniel/nostoc/16sTree/nostocaceae_cyanoseq/nostocaceaeCyanoseqPlusOurSeqs_ali/nostocaceaeCyanoseqPlusOurSeqs_ali.bacteria.afa

FastTree -gtr -nt < $nostocAlignment > nostocaceaeTree.nwk

## get local for iTOL:

getFile=/media/vol1/daniel/nostoc/16sTree/nostocaceae_cyanoseq/nostocaceaeCyanoseqPlusOurSeqs_ali/nostocaceaeTree.nwk
putItHere=/home/daniel/Documents/projects/mossSymbiosis/trees4itol/
rsync -auv test@132.180.112.115:$getFile $putItHere

## and look at in arb


################# nifH ########################

## we need a nifH database and maybe a tree. Maybe a good database here:
## https://www.jzehrlab.com/nifh  

## okay, what is the strategy for getting consensus seqs from our nifH consensus sequence into shape?

## I assume the same strategy, blast to a database, group the reads by their tendency to blast to 
## common matches. 

## but for that we need a database of NifH genes.    

## intriguing: https://doi.org/10.1016/j.soilbio.2023.109261
## (Hu, Wang, et al. 2024)
## "Biological nitrogen fixation and the role of soil diazotroph 
##  niche breadth in representative terrestrial ecosystems"
## they translated the nifH sequence with framebot, then blastp 
##  to a curated NifH database

## one database they used is from the NifHTool authors:

cd /media/vol1/daniel/nostoc/nifHdatabases

wget https://zenodo.org/records/5913032/files/JefferDSP/NIFTHool-v1.0.zip

unzip NIFTHool-v1.0.zip

## we just want:
mv data_NifH.csv NIFtHool.csv

## I think we need this as a fasta:

python3 

import pandas as pd
import os
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio import SeqIO

aa = pd.read_csv("NIFtHool.csv", header=None)

protSeqs = aa.iloc[:,2].apply(Seq).to_list()

listOfNifHrecords = []
for i,j in enumerate(protSeqs):
    seqi = SeqRecord(seq=protSeqs[i], id=aa.iloc[i,0], name=aa.iloc[i,1], description=aa.iloc[i,1])
    listOfNifHrecords.append(seqi)

SeqIO.write(listOfNifHrecords, "NIFtHool.faa", "fasta")

help(SeqIO.write)

## also there is this Koira & Brzel dataset, 963 NifH genes from culture genomes:

wget https://mdpi-res.com/d_attachment/microorganisms/microorganisms-09-01662/article_deploy/microorganisms-09-01662-s001.zip

unzip microorganisms-09-01662-s001.zip

mv 'Archive 2'/'Supplement Data S1 Sequences.xlsx' ./Supplement_Data_S1_Sequences.xlsx


## think nifH protein seqs are here:

python3 
import pandas as pd
import os
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio import SeqIO

aa = pd.read_excel(open('Supplement_Data_S1_Sequences.xlsx', 'rb'), sheet_name='CompleteNif')  
## can we make a fasta (FAA) out of this?
## getting down to the two columns we really need:
nifHdf = aa[['NifH', 'NifHSeq']]
protSeqs = nifHdf['NifHSeq'].apply(Seq).to_list()
## to make a big list:
listOfNifHrecords = []
for i,j in enumerate(protSeqs):
    seqi = SeqRecord(seq=protSeqs[i], id=nifHdf.iloc[i,0], description=nifHdf.iloc[i,0])
    listOfNifHrecords.append(seqi)

listOfNifHrecords[0]

## write this out as a fasta?:
SeqIO.write(listOfNifHrecords, "KoiraBroezel.faa", "fasta")

## this should work. The third source of cyanobacterial reads 
## given in this database ("Nitrogenase NifH 99.fasta")
https://bridges.monash.edu/articles/online_resource/Nitrogenase_NifH_99_fasta/13152692?backTo=/collections/_/5230745

## had to download manually, put it on nanoComp:
rsync -auv '/home/daniel/Downloads/Nitrogenase NifH 99.fasta' test@132.180.112.115:/media/vol1/daniel/nostoc/nifHdatabases/

mv 'Nitrogenase NifH 99.fasta' NitrogenaseNifH99.fasta
## this formatting seems fine

## they (Wang et. al 2022) did translating etc, 
## but I think we need a reliable consensus sequence,
## as before. so try the same old bag of tricks.

## we have nucleotide sequences to align against AA, 
## need blastx. 

cd /media/vol1/daniel/nostoc/nifHdatabases

cat KoiraBroezel.faa NIFtHool.faa NitrogenaseNifH99.fasta > allNifHdbs.faa

makeblastdb -in allNifHdbs.faa -dbtype prot

####### barcode12 NifH OG Hylocomium ##########

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12

blastDB=/media/vol1/daniel/nostoc/nifHdatabases/allNifHdbs.faa

nifH12reads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode12.fastq



seqtk seq -A $nifH12reads > nifH12.fasta

grep -c "^>" nifH12.fasta ## only 75 reads. Let's see how they look

blastx -db $blastDB \
  -query nifH12.fasta \
  -num_threads 10 \
  -num_alignments 5 \
  -out nifH12reads_blastmatches.txt 

blastx -db $blastDB \
  -query nifH12.fasta \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode12-nifH.csv \
  -outfmt 10 & 

## 64 matches, out of 75 reads
sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode12-nifH.csv

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os
pd.set_option('display.max_rows', None)
os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12')

nostocMatches = pd.read_csv('round2Barcode12-nifH.csv', index_col='qseqid')
nostocMatches.groupby('sseqid').count() 
aa = nostocMatches[['sseqid','pident','evalue']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

## the most common match is to a reference sequence for Nostoc NifH, WP_069074423
## 8 matches out of 70, so not great. But we are used to this. 

## most common match
nostocMatches[nostocMatches.sseqid.str.contains("WP_069074423")]

## second is weird:
nostocMatches[nostocMatches.sseqid.str.contains("F0RY64")]
## but scores are all bad. These can be ignored, I think.

## third has some strong matches:
nostocMatches[nostocMatches.sseqid.str.contains("WP_104908765.1")]
## this accession is NifH for Lobaria pulmonaria (5183) cyanobiont

## one fairly strong match (37 AAs, bitscore 80.1) to a calothrix nifH
nostocMatches[nostocMatches.sseqid.str.contains("WP_035154649.1")]

## there are duplications here, 3 of these are listed twice. 
## the strong matches are far fewer:
nostocMatches.query('bitscore > 100 & sseqid == "WP_069074423.1"')

## anyway, let's focus on those with high bit scores 
## subset to just these:
strongMatches = nostocMatches.query('bitscore > 90')

## how to write these out...

wantedReads=strongMatches.reset_index().qseqid

rawReadsBarcode = ("/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/"
                   "OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/"
                   "2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode12.fastq")

wantedReads

wantedReads.str.match("95eb4fe6-6ee3-4a5c-9987-9d027b08b61d").any()

highBits=[]
for rec in SeqIO.parse(rawReadsBarcode, "fastq"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)

highBits

## write this out as a fasta?:
SeqIO.write(highBits, "Barcode12_NifH_reads2align.fa", "fasta")

## let's see what happens when we align these with muscle and/or sina

## first we need to make sure they are all 5'-3'. Assuming our databases
## are also, use this to align our reads?
## problem - the databases we scraped are all AA. 
## below, in the tree building process for NifH we made a fasta 
## of all the reads from the Kubota/Ininberg papers. 
## excluding our "homemade" ones that were manual downloads from
## ncbi.

## pipeline notes on 2965, btw

## looks like our install of vsearch doesn't have the orient function,
## and we have the latest version from apt. Update with binaries.


#sudo apt purge vsearch
wget https://github.com/torognes/vsearch/releases/download/v2.30.0/vsearch-2.30.0-linux-x86_64.tar.gz
tar -xvf vsearch-2.30.0-linux-x86_64.tar.gz
mv vsearch-2.30.0-linux-x86_64  ~/.vsearch-2.30.0
chmod 777 ~/.vsearch-2.30.0/bin/vsearch
sudo ln -s /home/test/.vsearch-2.30.0/bin/vsearch /usr/bin/vsearch

/usr/bin/vsearch

grep -c ">" nifH12.fasta

vsearch \
   --orient Barcode12_NifH_reads2align.fa \
   --db /media/vol1/daniel/nostoc/nifHtree/kubotaTreeSeqsPart.fa \
   --fastaout  Barcode12_NifH_reads2align_oriented.fa \
   --notmatched Barcode12_NifH_reads2align_NotOriented.fa 

## in the end of this, just nine reads of any quality

## align them, maybe with one or two "nice" NifH ref seqs...

## where to get the refseqs...
## we would expect a "normal" (molybdenum-enabled) from the 
## nostoc commune/punctiforme group 
## maybe let's use the three copies of NifH detected in Nostoc punctiforme PCC 73102 (NC_010628.1)
## WP_012412139.1,WP_012407784.1,WP_012407220.1 
## these are here:

extraRefSeqDir="/media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/nifHtree/extraRefSeqs"
ls ${extraRefSeqDir}/Nostoc_punct_PCC73102_NifH?_NC_010628.1_WP_0124?????.1.fa

## reorient them:
vsearch \
   --orient <(cat ${extraRefSeqDir}/Nostoc_punct_PCC73102_NifH?_NC_010628.1_WP_0124?????.1.fa) \
   --db /media/vol1/daniel/nostoc/nifHtree/kubotaTreeSeqsPart.fa \
   --fastaout  NifH_NcommuneRefSeqs_oriented.fa \
   --notmatched NifH_NcommuneRefSeqs_NotOriented.fa 

## try an alignment with these:
cat Barcode12_NifH_reads2align_oriented.fa NifH_NcommuneRefSeqs_oriented.fa |
seqtk seq -l 40 > BC12_andrefSeqs_2align.fa

## for comparison:

muscle5 -align Barcode12_NifH_reads2align_oriented.fa -output BC12_noRefSeqs.afa
muscle5 -align BC12_andrefSeqs_2align.fa -output BC12_andrefSeqs.afa

## hand curation of the alignments with ugene...
## do edits locally
getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12/BC12*afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode12/
rsync -auv test@132.180.112.115:$getFile $putItHere

ugene -ui *afa ## the usual, remove +/- vertical gaps, cut off where we have <3 reads 

#getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode12/noRefBC12_handedits.fa
#getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode12/withRefBC12_handedits_refsRemoved.fa
getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode12/withRefBC12_handedits.fa
putItHere=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12
rsync -auv $getFile test@132.180.112.115:$putItHere

## curious if the reference sequences make a difference in this process:

less withRefBC12_handedits.afa

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12

grep NC_010628 withRefBC12_handedits.afa

cp withRefBC12_handedits.afa withRefBC12_handedits.afa.bk
sed -i "/ref/ s/|:/_/" withRefBC12_handedits.afa

#alignment="noRefBC12_handedits.afa"
alignment="withRefBC12_handedits.afa"
#alignment="withRefBC12_handedits_refsRemoved.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk} 

ugene -ui *nwk
## actually, makes no difference to tree topology whether refs were included
## and the ref seqs are distributed throughout the reads, in different clades
## etc. So I think we can't distinguish if we have paralogs in here, 
## just try to get hmm 

alignFile="withRefBC12_handedits_refsRemoved.afa"
hmmbuild barcode12.hmm ${alignFile}
hmmemit -c -o Hylocomium_nostoc_BC12_nifH.fa barcode12.hmm

cp Hylocomium_nostoc_BC12_nifH.fa /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/nifH/consensusSequences/Hylocomium_nostoc_BC12_nifH.fa

## not sure how confident I am in this, only 9 reads. Blasts to nifHs, including the peltigera-symbiont, at least.

########## barcode 13 NifH OG Zygodon #####################

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13

blastDB=/media/vol1/daniel/nostoc/nifHdatabases/allNifHdbs.faa

nifH13reads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode13.fastq

seqtk seq -A $nifH13reads > nifH13.fasta

grep -c "^>" nifH13.fasta ## 1018 reads. That's more like it. Let's see how they look

blastx -db $blastDB \
  -query nifH13.fasta \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode13-nifH.csv \
  -outfmt 10 & 

## 1426 matches, out of 1018 reads? What happened...
## whenever it finds two matches to the same subject
## by a read, it reports them both, even though we 
## asked for one alignment only. 

sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode13-nifH.csv

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os
pd.set_option('display.max_rows', None)

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13')

nifhMatches = pd.read_csv('round2Barcode13-nifH.csv', index_col='qseqid')
aa = nifhMatches[['sseqid','pident']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

nifhMatches.head()

nifhMatches[['bitscore']]

strongMatches = nifhMatches.query('bitscore > 90')

wantedReads=strongMatches.reset_index().qseqid

rawReadsBarcode = ("/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/"
                   "OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/"
                   "2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode13.fastq")

highBits=[]
for rec in SeqIO.parse(rawReadsBarcode, "fastq"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)

highBits ## 547 strong matches

## write this out as a fasta?:
SeqIO.write(highBits, "Barcode13_NifH_reads2align.fa", "fasta")

grep -c ">" Barcode13_NifH_reads2align.fa

vsearch \
   --orient Barcode13_NifH_reads2align.fa \
   --db /media/vol1/daniel/nostoc/nifHtree/kubotaTreeSeqsPart.fa \
   --fastaout  Barcode13_NifH_reads2align_oriented.fa \
   --notmatched Barcode13_NifH_reads2align_NotOriented.fa

## all reoriented.

## reoriented references maybe handy here?
reorientedRefs=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12/NifH_NcommuneRefSeqs_oriented.fa

grep -c ">" Barcode13_NifH_reads2align_oriented.fa

cat Barcode13_NifH_reads2align_oriented.fa  $reorientedRefs |
seqtk seq -l 40 > BC13_andrefSeqs_2align.fa

muscle5 -align Barcode13_NifH_reads2align_oriented.fa -output BC13_noRefSeqs.afa ## takes ~10 min

cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13

muscle5 -align BC13_andrefSeqs_2align.fa -output BC13_andrefSeqs.afa

## get local, curate:
#getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13/BC13_noRefSeqs.afa
getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13/BC13_andrefSeqs.afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode13
rsync -auv test@132.180.112.115:$getFile $putItHere

ugene -ui *afa ## the usual, remove +/- vertical gaps, etc.

getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode13/BC13_andrefSeqs_handEdits.fa
putItHere=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13
rsync -auv $getFile test@132.180.112.115:$putItHere

## we have a lot of sequences, so make a tree, see if distinct clusters emerge:
 
sed -i "/ref/ s/|:/_/" BC13_andrefSeqs_handEdits.afa

alignment="BC13_andrefSeqs_handEdits.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk}  ## 30 sec

## looks like maybe three groups. Look again in ARB:

## yeah, three clades, save as:

barcode13_clade1.fa
barcode13_clade2.fa
barcode13_clade3.fa

## run alignments on these again
muscle5 -align barcode13_clade1.fa -output barcode13_clade1.afa
muscle5 -align barcode13_clade2.fa -output barcode13_clade2.afa
muscle5 -align barcode13_clade3.fa -output barcode13_clade3.afa

## curate them locally, the usual

## get local, curate:
getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13/barcode13_clade?.afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode13
rsync -auv test@132.180.112.115:$getFile $putItHere

## put back
getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode13/barcode13_clade?_handEdited.afa
putItHere=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13
rsync -auv $getFile test@132.180.112.115:$putItHere

## are the reference seqs still in there?:
grep "ref" barcode13_clade?_handEdited.afa

## one of them didn't cluster at all.
## and then Clade 1 and Clade 3 each have one. Makes sense. Looks like this organism
## has two NifH copies. We could probably investigate if one is molybdenum dependent, and one vanadium or iron
## or maybe it is two cyanobacteria. Maybe look into this later.

## for the record:
## BC13 clade1 has >ref|NC_010628.1_7297077-7298042
## BC13 clade3 has >ref|NC_010628.1_512909-513802
## these are NifH sequences we took from a Nostoc punctiforme genome
## and remove them:

grep -n -A2 "ref" barcode13_clade?_handEdited.afa ## 329, 363
sed -i '/ref/,+1d' barcode13_clade1_handEdited.afa 
sed -i '/ref/,+1d' barcode13_clade3_handEdited.afa 


cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode13

##  build hmms

#alignFile="barcode13_clade1_handEdited.afa"
#alignFile="barcode13_clade2_handEdited.afa"
#alignFile="barcode13_clade3_handEdited.afa"
hmmbuild ${alignFile/\.afa/\.hmm} ${alignFile}
hmmemit -c -o ${alignFile/_handEdited.afa/_consensus.fasta} ${alignFile/\.afa/\.hmm}

## clade3 best match from an identified organism is the nif from a compactonostoc,
## fits our 15s match. 
## clade2 doesn't really blast to much, but closest id'd org is from Scytonenataceae, "Brasilonema" sp. Funny. Kind of like 16s from Zygodon and Homalia
##   also therefore makes sense that our reference sequences didn't align at all to this one
## clade1 - 2 out of 3 (1rst and 3rd) are to the cyanobacteria from the Kubota paper! still not perfect matches (96% match or so)

cat barcode13_clade?_consensus.fasta > barcode13_consensuses.fasta 

cp barcode13_consensuses.fasta /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/nifH/consensusSequences/Zygodon_nostoc_BC13_nifH.fa
## may need to edit the id lines, for the tree


########## barcode 14 NifH Homalia #####################


cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14

blastDB=/media/vol1/daniel/nostoc/nifHdatabases/allNifHdbs.faa

nifH14reads=/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode14.fastq

seqtk seq -A $nifH14reads > nifH14.fasta

grep -c "^>" nifH14.fasta ## 118 reads. Not great. Let's see what we can do.

blastx -db $blastDB \
  -query nifH14.fasta \
  -num_threads 10 \
  -num_alignments 1 \
  -out round2Barcode14-nifH.csv \
  -outfmt 10 & 


sed -i '1i qseqid,sseqid,pident,length,mismatch,gapopen,qstart,qend,sstart,send,evalue,bitscore' round2Barcode14-nifH.csv

python3 
import pandas as pd
from Bio import SeqIO
import matplotlib.pyplot as plt; plt.ion()
import os
pd.set_option('display.max_rows', None)

os.chdir('/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14')

nifhMatches = pd.read_csv('round2Barcode14-nifH.csv', index_col='qseqid')
aa = nifhMatches[['sseqid','pident']].groupby('sseqid').count()
bb = aa.T.iloc[0,:].sort_values(ascending=False)
cc = aa.T.iloc[0,:].sort_values(ascending=True)

nifhMatches.head()

nifhMatches[['bitscore']]

minBitscore = 60 ## with these AA/nt blast matches, the bitscores are much lower.

nifhMatches.query(f"bitscore > {minBitscore}")[['sseqid','evalue']]

nifhMatches.query(f"bitscore > {minBitscore}").shape ## 43 seqs, let's try this

strongMatches = nifhMatches.query(f'bitscore > {minBitscore}')

wantedReads=strongMatches.reset_index().qseqid

rawReadsBarcode = ("/media/vol1/daniel/rawDataNanopore/NostocColonyPCRsRound2/"
                   "OGZygodonHylocomiumHomalia/OGZygodonHylocomiumHomalia_baseCalled/trimmed/"
                   "2ed2dc90-9ec6-43dc-b1a6-362b75c1ab18_SQK-RBK114-24_barcode14.fastq")

highBits=[]
for rec in SeqIO.parse(rawReadsBarcode, "fastq"):
    print(rec.id)
    if wantedReads.str.match(rec.id).any():
      print("yes!: " + rec.id)
      highBits.append(rec)

len(highBits) ## 40 strong matches, we lost a couple, must have been dups

SeqIO.write(highBits, "Barcode14_NifH_reads2align.fa", "fasta")

grep -c ">" Barcode14_NifH_reads2align.fa

vsearch \
   --orient Barcode14_NifH_reads2align.fa \
   --db /media/vol1/daniel/nostoc/nifHtree/kubotaTreeSeqsPart.fa \
   --fastaout  Barcode14_NifH_reads2align_oriented.fa \
   --notmatched Barcode14_NifH_reads2align_NotOriented.fa

reorientedRefs=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode12/NifH_NcommuneRefSeqs_oriented.fa

grep -c ">" Barcode14_NifH_reads2align_oriented.fa

cat Barcode14_NifH_reads2align_oriented.fa  $reorientedRefs |
seqtk seq -l 40 > BC14_andrefSeqs_2align.fa

muscle5 -align Barcode14_NifH_reads2align_oriented.fa -output BC14_noRefSeqs.afa 

muscle5 -align BC14_andrefSeqs_2align.fa -output BC14_andrefSeqs.afa

#getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14/BC14_noRefSeqs.afa
getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14/BC14_andrefSeqs.afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode14
rsync -auv test@132.180.112.115:$getFile $putItHere

ugene -ui BC14_andrefSeqs.afa ## the usual, remove +/- vertical gaps, etc.

getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode14/BC14_andrefSeqs_handEdited.afa
putItHere=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14
rsync -auv $getFile test@132.180.112.115:$putItHere

## we have a lot of sequences, so make a tree, see if distinct clusters emerge:
sed -i "/ref/ s/|:/_/" BC14_andrefSeqs_handEdited.afa

less BC14_andrefSeqs_handEdited.afa

alignment="BC14_andrefSeqs_handEdited.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk}  ## 30 sec

arb

## looks again like three groups. 

## clade1  contained ref7927 = WP_012412139.1 (  NC_010628.1 (7,297,077..7,298,042)  )
## clade2  contained ref1229 = WP_012407784.1 (  NC_010628.1 (1,229,540..1,230,433)  )
## clade3 contained no reference sequence, technically,
## but it was closest to ref5129 WP_012407220.1 ( NC_010628.1 (512,909..513,802)  ), which fell into no clade

## run alignments on these again
muscle5 -align barcode14_clade1.fa -output barcode14_clade1.afa
muscle5 -align barcode14_clade2.fa -output barcode14_clade2.afa
muscle5 -align barcode14_clade3.fa -output barcode14_clade3.afa

getFile=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14/barcode14_clade?.afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode14
rsync -auv test@132.180.112.115:$getFile $putItHere

## manually curate...

## put back

getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentsBarcode14/barcode14_clade?_handEdited.afa
putItHere=/media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14
rsync -auv $getFile test@132.180.112.115:$putItHere

## remove the reference seqs

grep "ref" barcode14_clade?_handEdited.afa

grep -n -A2 "ref" barcode14_clade?_handEdited.afa 
sed -i '/ref/,+1d' barcode14_clade1_handEdited.afa 
sed -i '/ref/,+1d' barcode14_clade2_handEdited.afa 


cd /media/vol1/daniel/nostoc/blastout/round2_ZygodonHomaliaAmbylostegium/barcode14

##  build hmms

#alignFile="barcode14_clade1_handEdited.afa"
#alignFile="barcode14_clade2_handEdited.afa"
#alignFile="barcode14_clade3_handEdited.afa"
hmmbuild ${alignFile/\.afa/\.hmm} ${alignFile}
hmmemit -c -o ${alignFile/_handEdited.afa/_consensus.fasta} ${alignFile/\.afa/\.hmm}

## clade1 is the shortest sequence, top blast match to another of Kubota's cyanobacterium. Cool.
## clade2 blasts to lichen symbionts CP026692 Lobaria symbiont, and CP026681 Peltigera symbiont
## clade3 also blasts strongly to Lobaria symbiont, CP026692.1, from same study as clade2 blast matches. 
## (iceland lichen symbiont genome sequencing project, unpublished)

cat barcode14_clade?_consensus.fasta > barcode14_consensuses.fasta 

cp barcode14_consensuses.fasta /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/nifH/consensusSequences/Homalia_nostoc_BC14_nifH.fa

ls /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/nifH/consensusSequences/


## so this should be all of our nifH consensus sequences. 
## time to hang them on a tree:

###### construction of tree ######

## I can't find a curate nifH tree in the literature
## centered on nostoc (aceae...ales...)
## so let's try to recreate the Ininbergs/Kumota trees

## Ininbergs has the following accessions:

## what is an elegant way to do this... I wonder if we can 
## query genbank by studies 

cd /media/vol1/daniel/nostoc/nifHtree

python3 
import pandas as pd
from Bio import SeqIO
from Bio import Entrez
import matplotlib.pyplot as plt; plt.ion()
import os,re
Entrez.email = "daniel_thomas@uni-bayreuth.de"  

## we want nifH sequence data from 2 studies:
ininbergTitle = "Composition and diversity of nifH genes of nitrogen-fixing cyanobacteria associated with boreal forest feather mosses"
kubotaTitle = "Nitrogen fixation and nifH gene diversity in cyanobacteria living on feather mosses in a subalpine forest of Mt. Fuji"
ininberg_pmid = "21714790"
kubota_pmid = "36808304"

stream = Entrez.elink(
    dbfrom='pubmed',
    db="nucleotide", 
    id=ininberg_pmid, 
    idtype="acc"
)
record = Entrez.read(stream)
stream.close()

record

## to get one accession out of this:
record[0]['LinkSetDb'][0]['Link'][0]

## to get them all?:
accessionsIninberg = [ i['Id'] for i in record[0]['LinkSetDb'][0]['Link'] ]

len(accessionsIninberg)

## to fetch these?

## to get one:
handle = Entrez.efetch(db="nucleotide", id=accessionsIninberg[0], rettype="fasta", retmode="text")
seq_record = SeqIO.read(handle, "fasta")

## to get them all:
def getSequence(accID):
    handle = Entrez.efetch(db="nucleotide", id=accID, rettype="fasta", retmode="text")
    seq_i = SeqIO.read(handle, "fasta")
    handle.close()
    return(seq_i)

seqsIninberg = [ getSequence(i) for i in accessionsIninberg ]

## repeat for Kubota reads:

stream = Entrez.elink(
    dbfrom='pubmed',
    db="nucleotide", 
    id=kubota_pmid, 
    idtype="acc"
)
record = Entrez.read(stream)
stream.close()
accessionsKubota = [ i['Id'] for i in record[0]['LinkSetDb'][0]['Link'] ]



seqsKubota = [ getSequence(i) for i in accessionsKubota ]

seqsIninberg + seqsKubota 

## what other sequences do we need, to rebuild their trees?

## kubota used Trichodesmium erythraeum (Accession number L00689) as their outgroup:
handle = Entrez.efetch(db="nucleotide", id="L00689.1", rettype="fasta", retmode="text")
Trichodesmium_seq = [SeqIO.read(handle, "fasta")]
handle.close()

## and I see the following sequences on their figures:

chekSeq="UB89346"
pd.Series(accessionsIninberg)[pd.Series(accessionsIninberg).str.contains(chekSeq)]
pd.Series(accessionsKubota)[pd.Series(accessionsKubota).str.contains(chekSeq)]

## these look like the reference sequences they both used:
Nostoc sp. PCC 7120 (637231238)
Tolypothrix sp. PCC 7101 (AY221817)
Mastigocladus laminosus CCMEE 5268 (EF570567)
Fischerella UTEX 1931 (U49514)
Richelia sp. SC01 clone 5325A45 (DQ225763)
Nostoc sp. PCC 7120 (637231821)
Anabaena variabilis ATCC 29413 (U89346)
Anabaena oscillarioides (M63686)
Cylindrospermopsis raciborskii CS-505 (647107234)
Aphanizomenon aphanizomenoides UADFA13 (FJ895145)
Anabaena sp. LG2 clone 7104A02 (EU381369)
Anabaena variabilis ATCC 29413 (646569746)
Trichodesmium erythraeum IMS101 (638109037)
Nostoc punctiforme PCC 73102 (642599733)
Nostoc commune UTEX 584 (L23514)
Nostoc sp. 'J.Gallon' (L15551)
Nodularia sp. KAC 13 (AY271821)
Nostoc punctiforme PCC 73102 642600311
Scytonema hofmanni UTEX 2349 DQ531684
Nostoc muscorum UTEX 1933 U04054
Cylindorospermum sp. SU01 JF827724
Fischerella UTEX 1931 (U49515)
Calothrix desertica PCC 7102 (U73129)
Nostoc punctiforme PCC 73102 642604820
Anabaena variabilis ATCC 29413 646569556


refAccDict={'descrip' : [ "Nostoc sp. PCC 7120", "Tolypothrix sp. PCC 7101", "Mastigocladus laminosus CCMEE 5268", "Fischerella UTEX 1931", "Richelia sp. SC01 clone 5325A45", "Nostoc sp. PCC 7120", "Anabaena variabilis ATCC 29413", "Anabaena oscillarioides", "Cylindrospermopsis raciborskii CS-505", "Aphanizomenon aphanizomenoides UADFA13", "Anabaena sp. LG2 clone 7104A02", "Anabaena variabilis ATCC 29413", "Trichodesmium erythraeum IMS101", "Nostoc punctiforme PCC 73102", "Nostoc commune UTEX 584", "Nostoc sp. 'J.Gallon", "Nodularia sp. KAC 13", "Nostoc punctiforme PCC 73102", "Scytonema hofmanni UTEX 2349", "Nostoc muscorum UTEX 1933", "Fischerella UTEX 1931", "Calothrix desertica PCC 7102", "Nostoc punctiforme PCC 73102", "Anabaena variabilis ATCC 29413" ],
'accNum' : ["637231238", "AY221817", "EF570567", "U49514", "DQ225763", "637231821", "U89346", "M63686", "647107234", "FJ895145", "EU381369", "646569746", "638109037", "642599733", "L23514", "L15551", "AY271821", "642600311", "DQ531684", "U04054", "U49515", "U73129", "642604820", "646569556"]}

pd.set_option('display.max_rows', None)

refAccDF = pd.DataFrame(refAccDict)
del(refAccDict)

refAccDF

refAccDF.head()

numbers= re.compile("^[0-9]")

## a lot of these are not ncbi formated accession numbers. What are they?
onlyNums = refAccDF['accNum'].str.contains(numbers)

refAccDF[onlyNums]

## these look like I will need to go hunting manually...
## but the rest, I think we can get...

oldNamesRefAccs = refAccDF[~onlyNums]['accNum'].to_list()
newNamesRefAccs = [ i+".1" for i in oldNamesRefAccs ]
refSeqsPart = [ getSequence(i) for i in newNamesRefAccs ]

## also the extra nifH from Anabaena variabilis from 1995 that they used:
handle = Entrez.efetch(db="nucleotide", id="U89346.1", rettype="fasta", retmode="text")
oldAnaNifH_seq = [SeqIO.read(handle, "fasta")]
handle.close()

## before I do that, write out everything else that we do have accession info for into a fasta
## what do we have?


kubotaTreeSeqsPart = seqsIninberg + seqsKubota + Trichodesmium_seq + oldAnaNifH_seq + refSeqsPart 
len(kubotaTreeSeqsPart) ## 105

## now write this out:
SeqIO.write(kubotaTreeSeqsPart, "kubotaTreeSeqsPart.fa", "fasta")

## now hunt the other sequences they probably used...

refAccDF[onlyNums]

## what are these numbers?
                    Nostoc sp. PCC 7120  637231238
                    Nostoc sp. PCC 7120  637231821
           Nostoc punctiforme PCC 73102  642599733
           Nostoc punctiforme PCC 73102  642600311
           Nostoc punctiforme PCC 73102  642604820
  Cylindrospermopsis raciborskii CS-505  647107234
         Anabaena variabilis ATCC 29413  646569746 ## = U89346?, also now called Trichormus variabilis
         Anabaena variabilis ATCC 29413  646569556 
        Trichodesmium erythraeum IMS101  638109037 ## already have above

## we may also want to put in some of the lutzoni sequences.
## let's first see if we can just recreate their tree

## let's look at one of these, Nostoc punctiforme PCC 73102 (NC_010628.1)
## three copies in the genome, looks like:
  nifH, at 512909-513802 --> WP_012407220.1 (  NC_010628.1 (512,909..513,802)      )
nifH, at 1229540-1230433 --> WP_012407784.1 (  NC_010628.1 (1,229,540..1,230,433)  )
nifH, at 7297077-7298042 --> WP_012412139.1 (  NC_010628.1 (7,297,077..7,298,042)  )

WP_012412139.1 
WP_012407784.1 
WP_012407220.1 

## let's assume these are the 3 N. punctiforme reference seqs they used.
## but to get the ntide sequence, had to use the sequence view of NC_010628.1,
## switch to Graphics view, then search for NifH, then manually select the range
## given by the searchs, and download the fasta

## Nostoc sp. PCC 7120

## the only assembly of this organism that was available at the time of 
## ininbergs 2011 was:
GCF_000009705.1
## chromosome here:

NC_003272.1

## this was called Anabaena in the ininberg paper,
## has been renamed to a nostoc by the time of Kubota 2023. Okay, fine. 

Anabaena variabilis ATCC 29413  
## = U89346?, also now called Trichormus variabilis
## = assembly GCF_000204075.1? But this is too new. 
## it looks like there is one annotation of the molybdenum nif, = U89346
## the other two Anabaena variabilises, not sure where they dug
## these out of, back in 2011...

## put these files somewhere in the github repo, they are also precious

## I dug out the normal molybdenum dependent NifH and another (Fe-dependent?)
## from older genomes. There is also this Vanadium dependent 
## NifH:
DQ315787.1
esearch -db "Nucleotide" -query "DQ315787.1" | 
efetch -format "fasta" > /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/DQ315787.1.fasta


## okay, so what files need to be combined?

cp /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/extraRefSeqs/* /media/vol1/daniel/nostoc/nifHtree/

cd /media/vol1/daniel/nostoc/nifHtree

cat *.fa > kubotaIninbergs.fa

## looks promising. now, add in our consensus sequences and run an alignment

cat kubotaIninbergs.fa <(cat /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/nifH/consensusSequences/*) | seqtk seq -l 60 > thomasKubotaIninbergs.fa

## run alignment:
muscle5 -align thomasKubotaIninbergs.fa -output thomasKubotaIninbergs.afa
## takes 4 minutes or so

## looking at it locally...
getFile=/media/vol1/daniel/nostoc/nifHtree/thomasKubotaIninbergs.afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/
rsync -auv test@132.180.112.115:$getFile $putItHere

## shoot, looks like the Nostoc nifH sequences I put in (ref|NC_003272.1|:xxxxxxx-xxxxxxx Nostoc sp. PCC 7120 = FACHB-418) 
## are causing big problems. 

## probably we have introns and they just kept coding regions. 

## also looks like we have a duplicate label, I think we manually downloaded this 
## when we already had it:

grep U89346.1 *


vim thomasKubotaIninbergs.afa
## changed one of these to say ">U89346.1_2" in the alignment.

## and clean up the ref seqs
sed -i "/ref/ s/|:/_/" thomasKubotaIninbergs.afa

## run the tree without manual edits, see what happens:

alignment="thomasKubotaIninbergs.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk}  ## 30 secs

## look at in arb

## yeah, that's weird. 

## try again with a curated alignment:

## taking out the massing introns in the ref seqs I included

getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/thomasKubotaIninbergs_handEdited.afa
putItHere=/media/vol1/daniel/nostoc/nifHtree
rsync -auv $getFile test@132.180.112.115:$putItHere

grep U89346.1 thomasKubotaIninbergs_handEdited.afa
grep ref thomasKubotaIninbergs_handEdited.afa

alignment="thomasKubotaIninbergs_handEdited.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk} 

arb

## okay, alignment/tree sort of agrees with the other papers. 
## I would much rather hang my sequences on their trees, 
## but they did not supply and data and don't respond to emails.

## so here we are. where do our sequences fall?
## we have 7 consensus sequences.

cat /media/vol1/daniel/nostoc/nanoporeNostoc16sAlignments_repo/get_consensus_seq/nifH/consensusSequences/* > consensusSeqs.fa

Homalia_cyanobacteria_BC14_nifH_clade1 --> nifH2, non-Fiji
Homalia_cyanobacteria_BC14_nifH_clade2 --> Nostoc2, next to LC716862.1
Homalia_cyanobacteria_BC14_nifH_clade3 --> Nostoc1/Stigonema, near LC716873 
Hylocomium_cyanobacteria_BC12_nifH     --> Nostoc2, next to JF827746 
Zygodon_cyanobacteria_BC13_nifH_clade1 --> NifH2, next to LC716821/JF827751
Zygodon_cyanobacteria_BC13_nifH_clade2 --> Nostoc2, next to Nostoc muscorum
Zygodon_cyanobacteria_BC13_nifH_clade3 --> Nostoc1

Homalia_cyanobacteria_clade1
Homalia_cyanobacteria_clade2
Homalia_cyanobacteria_clade3
Hylocomium_cyanobacteria    
Zygodon_cyanobacteria_clade1
Zygodon_cyanobacteria_clade2
Zygodon_cyanobacteria_clade3

## we'll get rid of some of these less confident branch values
## using Tree --> Modify Branches --> Multifurcate --> set thresholds, multifurcate branch supports < 50%
## they call it multifurcation (I guess I called these polytomies)

## report these, with nearest blast results. 

## interesting, there is an entire clade of Kubota sequences that do not appear 
## in their paper, as far as I can see. The highest published sequence I
## see in their tree is LC716884. This extra clade starts with LC716885, to LC716899
## They cluster together and branch early. 

cut -f 1 export.nds | sort > extraKubotaSeqs.txt

## let's do our alignment and tree without these?
## or just cut them out of the tree, since they cluster so
## tightly.

## if kubota ever gets back to me I will ask him/her about this.

## for publication revise accesion IDs of our sequences
## and manually scraped reference seqs (e.g. N. punctiforme PCC 73102 NifH seqs)
## with easier-to-understand labels, for for easily repeated alignment/tree pipeline 
## rerun alignment without Kubota mystery clade

## zombie sequences, where did these come from?:

grep CP000117 *

## today, get out a graphic with some notes for Ulla to have for her thesis

cd /media/vol1/daniel/nostoc/nifHtree

mv thomasKubotaIninbergs_handEditednwk.tree thomasKubotaIninbergs_firstDraft.nwk

## get local
#getFile=/media/vol1/daniel/nostoc/nifHtree/thomasKubotaIninbergs_firstDraft.nwk
getFile=/media/vol1/daniel/nostoc/nifHtree/thomasKubotaIninbergs_handEditednwk.xml
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/
rsync -auv test@132.180.112.115:$getFile $putItHere

## this arb xml file seems like it isn't the standard phyoxml, and iTol can't import it
## but group info seems lost on the standard nwk...hm...

## actually, there it is, the newick, just fine.

#### revise nifH tree with kubota data ####

## Kubota kindly gave us their data for the other ref seqs they
## used in their tree. Hopefully this fixes the issue with the

getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/reference_Ininbergs.fa 
putItHere=/media/vol1/daniel/nostoc/nifHtree/
rsync -auv $getFile test@132.180.112.115:$putItHere

cd /media/vol1/daniel/nostoc/nifHtree/

seqtk seq -l 0 reference_Ininbergs.fa

## this looks like it includes the ininbergs sequences. 
## how do we confirm that this has everything we need?
## he/she mentioned that there may be missing sequences,
## how can we find them?

## problem is we can expect neither our sequences nor 
## accessions names to exactly match the names and 
## sequences in their fasta, so automated comparison
## is probably not possible. 
## I think the only way is to get all the names from this
## new fasta and manually compare to names in the paper 
## and in our list.

grep ">" thomasKubotaIninbergs.fa | sort > seqList_thomasKubotaIninbergs.txt
grep ">" reference_Ininbergs.fa | sort > seqList_fromKubota.txt

grep -c ">" reference_Ininbergs.fa

## actually, there is a perfect one-to-one match between these. 
## The only difference would be presumably between the sequences 
## they pulled from genomes (ATCC 29413, PCC 73102, etc)
## it even looks like they have all the Ininbergs sequences. 

## JF827722 was lost. where?
grep "JF827722" seqList_fromKubota.txt ## y

grep "JF827722" nifHseqs2align.fa ## no... why not? 

grep "JF827722" nifHseqs2align_handEdited.afa
grep "JF827722" nifHseqs2align_handEdited.nwk


## so use their fasta, plus the automated NCBI pulls for Kubota seqs, minus the 
## extra non-cyano kubota clade, + our consensus seqs:

python3 
import pandas as pd
from Bio import SeqIO
from Bio import Entrez
import matplotlib.pyplot as plt; plt.ion()
import os,re
Entrez.email = "daniel_thomas@uni-bayreuth.de"  

kubotaTitle = "Nitrogen fixation and nifH gene diversity in cyanobacteria living on feather mosses in a subalpine forest of Mt. Fuji"
kubota_pmid = "36808304"

stream = Entrez.elink(
    dbfrom='pubmed',
    db="nucleotide", 
    id=kubota_pmid, 
    idtype="acc"
)
record = Entrez.read(stream)

stream.close()

accessionsKubota = [ i['Id'] for i in record[0]['LinkSetDb'][0]['Link'] ]

## which of these are NOT in the extra clade from kubota of non-cyanos?


with open ("extraKubotaSeqs.txt", "r") as file:
    nonCyanoKubotas = file.read().splitlines()

cyanoKubotas = [ i for i in accessionsKubota if i not in nonCyanoKubotas ]

## then get these:

def getSequence(accID):
    handle = Entrez.efetch(db="nucleotide", id=accID, rettype="fasta", retmode="text")
    seq_i = SeqIO.read(handle, "fasta")
    handle.close()
    return(seq_i)

seqsCyanoKubotas = [ getSequence(i) for i in cyanoKubotas ]


## the fasta file of other reads (inenberg, etc):


reference_Ininbergs = list(SeqIO.parse("reference_Ininbergs.fa", "fasta"))

## for some reason, this is not importing the first sequence

## weird. for reasons I cannot understand, biopython always dropped
## that first sequence. I traded sequences around, etc. 
## Whatever was first was dropped. 

## I "ironed it out" with good old seqtk:
seqtk seq -l 0 reference_Ininbergs.fa > reference_Ininbergs.fa.tmp
mv reference_Ininbergs.fa.tmp reference_Ininbergs.fa

NifHconsensusSeqs = list(SeqIO.parse("consensusSeqs.fa", "fasta"))


nifHseqs2align = reference_Ininbergs + seqsCyanoKubotas + NifHconsensusSeqs

nifHseqs2align

len(nifHseqs2align) ## 104 seqs, ~right.


SeqIO.write(nifHseqs2align, "nifHseqs2align.fa", "fasta")

## run the alignment
muscle5 -align nifHseqs2align.fa -output nifHseqs2align.afa 

## edit manually, locally
getFile=/media/vol1/daniel/nostoc/nifHtree/nifHseqs2align.afa
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs
rsync -auv test@132.180.112.115:$getFile $putItHere

getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/nifHseqs2align_handEdited.afa
putItHere=/media/vol1/daniel/nostoc/nifHtree/
rsync -auv $getFile test@132.180.112.115:$putItHere

## make tree

#alignment="nifHseqs2align_handEdited.afa"
alignment="nifHseqs2align.afa"
FastTree -gtr -nt < ${alignment} > ${alignment/afa/nwk}  ## 30 sec

find . -name nifHseqs2align.nwk
arb &

## and the tree is weird, very different from the results of 
## the other authors, and different than my previous tree. Ugh. 

## we did three things differently than the other authors:
## 1. used muscle aligner instead of mafft
## 2. trimmed the alignment before building the tree
## 3. used fasttree instead of IQ-TREE 

## the easy first check is to see if our manual curations
## had an effect on the tree, repeated above

## it helps a bit to use the full length sequences
## but I still get a different topology than 
## the other authors. 

## anyway, I think I will make two trees, a rooted tree with all reads
## to put in supp material, and an unrooted one showing the clades.

## done in arb. 

## these can serve as the basis for the figures. 

## to prettify the labels..
## this will be extremely intensive manually,
## but maybe we can keep track of what we do 
## so that it can be automatically repeated
## make a panda series of names on tree, and what we would like to 
## see instead. 

## names are exported to "nds" (csv) with arb

mv nifHtreeNames.nds nifHtreeNames.csv

cd /home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/nifHtree
#grep ".*</text>" nifHsimplified.svg > simplifiedTreeLabels.txt

python3
import pandas as pd
import matplotlib.pyplot as plt; plt.ion()
import os,re

pd.set_option('display.max_rows', None)

with open ("simplifiedTreeLabels.txt", "r") as file:
    treeNames = file.read().splitlines()

treeNames = pd.Series(treeNames)

treeNames[4]

ininbergPat = re.compile("(JF[0-9]*)")
kubotaPat = re.compile("(LC[0-9]+).*")
pubLabels = (treeNames
  .str.split("|").str.get(0)
  .str.replace("\.1","",regex=True)
  .str.replace("_"," ")
  .str.replace("BC..", "", regex=True)
  .str.replace("cyanobacteria", "-associated Nostoc-like colony")
  .str.replace(" -", "-")
  .str.replace("  ", " ")
  .str.replace(ininbergPat, r"\1 Ininbergs et al. (2011)", regex=True)
  .str.replace(kubotaPat, r"\1 Kubota et al. (2023)", regex=True)
  .str.replace("(M63686).*", r"\1 Anabaena oscillarioides",regex=True)
  .str.replace("(DQ531684).*", r"\1 Scytonema hofmanni UTEX 2349",regex=True)
  .str.replace("(FJ895145).*", r"\1 Aphanizomenon aphanizomenoides UADFA13",regex=True)
  .str.replace("(EF570567).*", r"\1 Mastigocladus laminosus CCMEE 5268",regex=True)
  .str.replace("(EU381369).*", r"\1 Anabaena sp. LG2",regex=True)
  .str.replace("(U49514).*", r"\1 Fischerella UTEX 1931",regex=True)
  .str.replace("(DQ225763).*", r"\1 Richelia sp. SC01",regex=True)
  .str.replace("(U89346).*", r"\1 Anabaena variabilis",regex=True)
  .str.replace("(JF827722).*", r"\1 Stigonema ocellatum",regex=True)
  .str.replace("(L23514).*", r"\1 Nostoc commune UTEX 584",regex=True)
  .str.replace("(U04054).*", r"\1 Nostoc muscorum UTEX 1933",regex=True)
  .str.replace("(AY271821).*", r"\1 Nodularia sp. KAC 13",regex=True)
  .str.replace("(638109037).*", r"\1 Trichodesmium erythraeum: NC_008312",regex=True)
  .str.replace("(U73129).*", r"\1 Calothrix sp.",regex=True)
  .str.replace("(647107234).*", r"\1 Cylindrospermopsis raciborskii CS-505",regex=True)
  .str.replace("(646569556).*", r"\1 Anabaena variabilis ATCC 29413",regex=True)
  .str.replace("(646569746).*", r"\1 Anabaena variabilis ATCC 29413 NC_007413",regex=True)
  .str.replace("(AY221817).*", r"\1 Tolypothrix sp. PCC 7101",regex=True)
  .str.replace("(642604820).*", r"\1 Nostoc punctiforme PCC 73102: NC_010628",regex=True)
  .str.replace("(L15551).*", r"\1 Nostoc sp. 'J. Gallon'",regex=True)
  .str.replace("(U49515).*", r"\1 Fischerella UTEX1931 alternative (nifH2)",regex=True)
  .str.replace("(642599733).*", r"\1 Nostoc punctiforme PCC 73102: NC_010628",regex=True)
  .str.replace("(642600311).*", r"\1 Nostoc punctiforme PCC 73102: NC_010628",regex=True)
  .str.replace("(FJ895145).*", r"\1 Aphanizomenon aphanizomenoides UADFA13",regex=True)
  .str.replace("(637231821).*", r"\1 Nostoc sp. PCC 7120: NC_003272",regex=True)
  .str.replace("(637231238).*", r"\1 Nostoc sp. PCC 7120: NC_003272",regex=True)
)
pubLabels

cleanupTreeLabs = pd.DataFrame({'treeNames':treeNames, 'pubLabels':pubLabels})

## can we use this to quickly change the labels in our svg?

#with open ("nifHtree_fullTree.svg", "r") as file:
with open ("nifHsimplified.svg", "r") as file:
    newText = file.read()
    for i,j in enumerate(cleanupTreeLabs['treeNames']):
        print(i)
        print(cleanupTreeLabs['treeNames'][i])
        print(cleanupTreeLabs['pubLabels'][i])
        newText = newText.replace(cleanupTreeLabs['treeNames'][i], cleanupTreeLabs['pubLabels'][i])
#    with open ("nifHtree_fullTree_editedLabels.svg","w") as newFile:
    with open ("nifHsimplified_editedLabels.svg","w") as newFile:
        newFile.write(newText)

getFile=/media/vol1/daniel/nostoc/nifHtree/nifHtree*.svg
putItHere=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/
rsync -auv test@132.180.112.115:$getFile $putItHere

## I think we need to get these onto the github repo, everything is getting confusing..
## working on laptop

#getFile=/home/daniel/Documents/projects/mossSymbiosis/alignmentThomasKubotaIninbergs/nifHtree*.svg
getFile=/media/vol1/daniel/nostoc/nifHtree/testNifH.svg
putItHere=/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/nifHtree
rsync -auv test@132.180.112.115:$getFile $putItHere
#rsync -auv daniel@132.180.112.24:$getFile $putItHere

## some errors, but seems harmless, works.

## - highlight placement of all of our sequences:
Hylocomium-associated Nostoc-like colony nifH
Zygodon-associated Nostoc-like colony nifH clade1
Zygodon-associated Nostoc-like colony nifH clade2
Zygodon-associated Nostoc-like colony nifH clade3
Homalia-associated Nostoc-like colony nifH clade1
Homalia-associated Nostoc-like colony nifH clade2
Homalia-associated Nostoc-like colony nifH clade3
## - label "mixed clade"

## get tree file onto laptop
getFile=/media/vol1/daniel/nostoc/nifHtree/nifHseqs2align.nwk
putItHere=/home/daniel/Documents/projects/mossCyanobacteria/culturingCyanos/nanoporeNostoc16sAlignments/nifHtree
rsync -auv test@132.180.112.115:$getFile $putItHere


#### make a notebook #####

## these may be useful:
https://dmnfarrell.github.io/bioinformatics/bokeh-sequence-aligner
https://plotly.com/python/alignment-chart/
https://etetoolkit.org/ipython_notebook/
https://github.com/etetoolkit/ete
## the last one, ete, looks like the best option, at first glance.

